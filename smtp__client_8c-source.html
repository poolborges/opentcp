<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/smtp/smtp_client.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/smtp/smtp_client.c</h1><a href="smtp__client_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright </span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright </span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the </span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if </span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola </span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself, </span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to </span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior </span>
00026 <span class="comment"> *written permission. For written permission, please contact </span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP", </span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written </span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED </span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE </span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR </span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE </span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, </span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series </span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to </span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see </span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00067 <span class="preprocessor">#include &lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00068 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00069 <span class="preprocessor">#include &lt;<a class="code" href="globalvariables_8h.html">inet/globalvariables.h</a>&gt;</span>
00070 <span class="preprocessor">#include &lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00071 <span class="preprocessor">#include &lt;<a class="code" href="timers_8h.html">inet/timers.h</a>&gt;</span>
00072 <span class="preprocessor">#include &lt;<a class="code" href="tcp__ip_8h.html">inet/tcp_ip.h</a>&gt;</span>
00073 <span class="preprocessor">#include &lt;<a class="code" href="smtp__client_8h.html">inet/smtp/smtp_client.h</a>&gt;</span>
00074 
<a name="l00075"></a><a class="code" href="smtp__client_8c.html#a0">00075</a> UINT8 <a class="code" href="smtp__client_8c.html#a0">smtpc_init_done</a> = 0; 
00083 <span class="keyword">struct</span>
00084 <span class="keyword"></span>{
00085         UINT8 <a class="code" href="structpop3c__struct.html#m0">state</a>;
00086         UINT32 <a class="code" href="structpop3c__struct.html#m1">remip</a>;
00087         UINT16 <a class="code" href="structpop3c__struct.html#m2">remport</a>;
00088         INT8 <a class="code" href="structpop3c__struct.html#m3">sochandle</a>;
00089         UINT8 <a class="code" href="structpop3c__struct.html#m4">tmrhandle</a>;
00090         UINT16 <a class="code" href="structpop3c__struct.html#m5">unacked</a>;
00091         UINT16 bufindex;
00092         
00093 }<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>;
00094 
00095 
00096 <span class="comment">/* The applications that use TCP must implement following function stubs                        */</span>
00097 <span class="comment">/* void application_name_init (void) - call once when processor starts                          */</span>
00098 <span class="comment">/* void application_name_run (void) - call periodically on main loop                            */</span>
00099 <span class="comment">/* INT32 application_name_eventlistener (INT8, UINT8, UINT32, UINT32)                           */</span>
00100 <span class="comment">/* - called by TCP input process to inform arriving data, errors etc                            */</span>
00101 
00102 <span class="comment">/* SMTP client application              */</span>
00103 
<a name="l00120"></a><a class="code" href="smtp__client_8c.html#a9">00120</a> INT8 <a class="code" href="smtp__client_8c.html#a9">smtpc_connect</a> (UINT32 ip, UINT16 port){
00121         <span class="comment">/* Do we have socket    */</span>
00122 
00123         <span class="keywordflow">if</span>( <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle &lt; 0 ) {
00124                 DEBUGOUT(<span class="stringliteral">"smtpc_connect() called but no socket\r\n"</span>);
00125                 <span class="keywordflow">return</span>(-1);
00126         }
00127         
00128         <span class="keywordflow">if</span>( <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state &lt; <a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a> ) {
00129                 DEBUGOUT(<span class="stringliteral">"smtpc_connect() called but uninitialized\r\n"</span>);
00130                 <span class="keywordflow">return</span>(-1);
00131         }
00132         
00133         <span class="keywordflow">if</span>( <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a> ) {
00134                 DEBUGOUT(<span class="stringliteral">"SMTP Connection request going to be processed\r\n"</span>);
00135                 <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.remip = ip;
00136                 <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.remport = port;
00137                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a3">SMTP_OPEN_REQUESTED</a>);
00138                 <span class="keywordflow">return</span>(1);
00139         }
00140         
00141         <span class="keywordflow">return</span>(-1);     
00142         
00143 }
00144 
00145 
<a name="l00155"></a><a class="code" href="smtp__client_8c.html#a10">00155</a> <span class="keywordtype">void</span> <a class="code" href="smtp__client_8c.html#a27">smtpc_init</a> (<span class="keywordtype">void</span>){
00156         
00157         <span class="keywordflow">if</span>(smtpc_init_done) {
00158                 DEBUGOUT(<span class="stringliteral">"smtp client already initialized\r\n"</span>);
00159                 <span class="keywordflow">return</span>;
00160         }
00161         
00162         
00163         <span class="comment">/* Get timer handle     */</span>
00164         
00165         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.tmrhandle = <a class="code" href="timers_8c.html#a2">get_timer</a>();
00166         
00167         <span class="comment">/* Get TCP Socket       */</span>
00168         
00169         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle = <a class="code" href="tcp_8c.html#a3">tcp_getsocket</a>(<a class="code" href="tcp__ip_8h.html#a40">TCP_TYPE_CLIENT</a>, <a class="code" href="tcp__ip_8h.html#a18">TCP_TOS_NORMAL</a>, <a class="code" href="group__opentcp__config.html#a14">TCP_DEF_TOUT</a>, smtpc_eventlistener);
00170         
00171         <span class="keywordflow">if</span>( <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle &lt; 0 ) {
00172                 DEBUGOUT(<span class="stringliteral">"smtpc_init() uncapable of getting socket\r\n"</span>);
00173                 <a class="code" href="system_8h.html#a6">RESET_SYSTEM</a>();
00174         }       
00175         
00176         smtpc_changestate(<a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a>);
00177         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.bufindex = <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>;
00178         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.unacked = 0;        
00179         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.remip = 0;
00180         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.remport = 0;
00181 
00182         <a class="code" href="smtp__client_8c.html#a0">smtpc_init_done</a> = 0x01;
00183 
00184 }
00185 
<a name="l00193"></a><a class="code" href="smtp__client_8c.html#a11">00193</a> UINT8 <a class="code" href="smtp__client_8c.html#a30">smtpc_getstate</a> (<span class="keywordtype">void</span>){
00194         <span class="keywordflow">return</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state);
00195         
00196 }
00197 
00198 <span class="comment">/********************************************************************************</span>
00199 <span class="comment">Function:               smtpc_eventlistener</span>
00200 <span class="comment"></span>
00201 <span class="comment">Parameters:             INT8 cbhandle - handle to TCP socket where event is coming from </span>
00202 <span class="comment">                                UINT8 event - type of event</span>
00203 <span class="comment">                                UINT32 par1 - parameter the meaning of depends on event</span>
00204 <span class="comment">                                UINT32 par2 - parameter the meaning of depends on event</span>
00205 <span class="comment">                                </span>
00206 <span class="comment">Return val:             INT32 - depends on event but usually (-1) is error of some</span>
00207 <span class="comment">                                                kind and positive reply means OK</span>
00208 <span class="comment">                                </span>
00209 <span class="comment">Date:                   21.7.2002</span>
00210 <span class="comment"></span>
00211 <span class="comment">Desc:                   This function is given to TCP socket as function pointer to be</span>
00212 <span class="comment">                                used by TCP engine to make callbacks to inform about events</span>
00213 <span class="comment">                                on TCP e.g. arriving data. Main functionality of this function </span>
00214 <span class="comment">                                is to parse data from TCP to detect SMTP server reply commands,</span>
00215 <span class="comment">                                handling out retransmissions and making state changes</span>
00216 <span class="comment">*********************************************************************************/</span>
00217 
00218 
00219 INT32 smtpc_eventlistener (INT8 cbhandle, UINT8 event, UINT32 par1, UINT32 par2)
00220 {
00221         <span class="comment">/* This function is called by TCP stack to inform about events  */</span>
00222         
00223         UINT16 cmd;
00224                 
00225         
00226         <span class="keywordflow">if</span>( cbhandle != <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle)          <span class="comment">/* Not our handle       */</span>
00227                 <span class="keywordflow">return</span>(-1);
00228         
00229         <span class="keywordflow">switch</span>( event ) {
00230         
00231                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a54">TCP_EVENT_CONREQ</a>:
00232                 
00233                         <span class="comment">/* We don't allow incoming connections  */</span>
00234                         
00235                         <span class="keywordflow">return</span>(-1);
00236         
00237                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>:
00238                 
00239                         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state &gt; <a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a>)     {
00240                                 <span class="comment">/* Inform application   */</span>      
00241                                 <a class="code" href="smtpc__callbacks_8c.html#a46">smtpc_error</a>();  
00242                         }
00243                 
00244                         smtpc_changestate(<a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a>);
00245                         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.unacked = 0;
00246                         
00247                         <span class="keywordflow">return</span>(1);
00248                 
00249                         <span class="keywordflow">break</span>;
00250                 
00251                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a55">TCP_EVENT_CONNECTED</a>:
00252                 
00253                         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a4">SMTP_CONNECTIONOPEN_SENT</a>) {
00254                                 DEBUGOUT(<span class="stringliteral">"SMTP TCP connection opened\r\n"</span>);
00255                                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a5">SMTP_CONNECTION_OPENED</a>);
00256                                 <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.unacked = 0;
00257                                 <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.bufindex = <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>;
00258                                 <span class="keywordflow">return</span>(-1);
00259                         }
00260                                 
00261                         <span class="keywordflow">break</span>;
00262                         
00263                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a56">TCP_EVENT_CLOSE</a>:
00264                 
00265                         smtpc_changestate(<a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a>);
00266                         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.unacked = 0;
00267                         <span class="keywordflow">return</span>(1);
00268                 
00269                         <span class="keywordflow">break</span>;
00270                         
00271                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a58">TCP_EVENT_ACK</a>:
00272                 
00273                         <span class="comment">/* Our message is acked */</span>
00274                         
00275                         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.unacked = 0;
00276                         
00277                         <span class="keywordflow">break</span>;
00278                         
00279                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a60">TCP_EVENT_DATA</a>:
00280                 
00281                         <span class="comment">/* Do we have unacked data?     */</span>
00282                         
00283                         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.unacked)
00284                                 <span class="keywordflow">return</span>(-1);
00285                 
00286                         <span class="comment">/* Get reply from server        */</span>
00287                         
00288                         <span class="keywordflow">if</span>(par1 &lt; 3)                                    <span class="comment">/* Long enough? */</span>
00289                                 <span class="keywordflow">return</span>(-1);
00290                 
00291                         <span class="comment">/* Get command                          */</span>
00292                         
00293                         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_tcp_packet.buf_index);
00294                         cmd = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00295                         cmd += <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00296                         cmd += <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00297                         
00298                         <span class="keywordflow">switch</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state) { 
00299                                 
00300                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a5">SMTP_CONNECTION_OPENED</a>:
00301                                 
00302                                         <span class="keywordflow">if</span>(cmd == <a class="code" href="smtp__client_8h.html#a22">SMTP_CMD_SERVER_READY</a>) {
00303                                                 DEBUGOUT(<span class="stringliteral">"SMTP Server is ready\r\n"</span>);
00304                                                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a6">SMTP_SERVER_READY</a>);
00305                                                 <span class="keywordflow">return</span>(1);
00306                                         }
00307                                         
00308                                         <span class="keywordflow">break</span>;
00309                                 
00310                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a7">SMTP_HELO_SENT</a>:
00311                                 
00312                                         <span class="keywordflow">if</span>(cmd == <a class="code" href="smtp__client_8h.html#a23">SMTP_CMD_OK</a>) {        
00313                                                 DEBUGOUT(<span class="stringliteral">"HELO acked by SMTP server\r\n"</span>);
00314                                                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a8">SMTP_HELO_ACKED</a>);
00315                                                 <span class="keywordflow">return</span>(1);
00316                                         }
00317                                         
00318                                         <span class="keywordflow">break</span>;                          
00319                                         
00320                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a9">SMTP_MAILFROM_SENT</a>:
00321                                 
00322                                         <span class="keywordflow">if</span>(cmd == <a class="code" href="smtp__client_8h.html#a23">SMTP_CMD_OK</a>) {
00323                                                 DEBUGOUT(<span class="stringliteral">"MAIL FROM Acked by SMTP server\r\n"</span>);
00324                                                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a10">SMTP_MAILFROM_ACKED</a>);
00325                                                 <span class="keywordflow">return</span>(1);
00326                                         }
00327                                         
00328                                         <span class="keywordflow">break</span>;                  
00329                                         
00330                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a11">SMTP_RCPTTO_SENT</a>: 
00331                                 
00332                                         <span class="keywordflow">if</span>(cmd == <a class="code" href="smtp__client_8h.html#a23">SMTP_CMD_OK</a>) {
00333                                                 DEBUGOUT(<span class="stringliteral">"RCPT TO Acked by SMTP server\r\n"</span>);
00334                                                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a12">SMTP_RCPTTO_ACKED</a>);
00335                                                 <span class="keywordflow">return</span>(1);
00336                                         }
00337                                         
00338                                         <span class="keywordflow">break</span>;  
00339                                         
00340                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a13">SMTP_DATAREQ_SENT</a>:
00341                                 
00342                                         <span class="keywordflow">if</span>(cmd == <a class="code" href="smtp__client_8h.html#a24">SMTP_CMD_DATAOK</a>) {
00343                                                 DEBUGOUT(<span class="stringliteral">"DATA Acked by SMTP Server\r\n"</span>);
00344                                                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a14">SMTP_DATAREQ_ACKED</a>);
00345                                                 <span class="keywordflow">return</span>(1);
00346                                         }
00347                                         
00348                                         <span class="keywordflow">break</span>;                                                                          
00349                                 
00350                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a18">SMTP_DATAEND_SENT</a>:
00351                                 
00352                                         <span class="keywordflow">if</span>(cmd == <a class="code" href="smtp__client_8h.html#a23">SMTP_CMD_OK</a>) {
00353                                                 DEBUGOUT(<span class="stringliteral">"CRLF.CRLF Acked by SMTP Server\r\n"</span>);
00354                                                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a19">SMTP_DATAEND_ACKED</a>);
00355                                                 <span class="keywordflow">return</span>(1);
00356                                         }
00357                                         
00358                                         <span class="keywordflow">break</span>;                                  
00359                                         
00360                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a20">SMTP_QUIT_SENT</a>:
00361                                 
00362                                         <span class="keywordflow">if</span>(cmd == <a class="code" href="smtp__client_8h.html#a25">SMTP_CMD_QUITOK</a>) {
00363                                                 DEBUGOUT(<span class="stringliteral">"QUIT Acked by SMTP Server\r\n"</span>);
00364                                                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a21">SMTP_QUIT_ACKED</a>);
00365                                                 <span class="keywordflow">return</span>(1);
00366                                         }
00367                                         
00368                                         <span class="keywordflow">break</span>;
00369                                         
00370                                 <span class="keywordflow">default</span>:
00371                                         <span class="keywordflow">break</span>;
00372 
00373                         
00374                         }
00375 
00376                 
00377                         <span class="keywordflow">return</span>(1);
00378                 
00379                         
00380                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a59">TCP_EVENT_REGENERATE</a>:
00381                 
00382                         <span class="comment">/* Send last packet again       */</span>
00383                 
00384                         DEBUGOUT(<span class="stringliteral">"SMTP is regenerating...\r\n"</span>);
00385                 
00386                         <span class="keywordflow">switch</span> (<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state) {
00387                         
00388                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a7">SMTP_HELO_SENT</a>:
00389                                         smtpc_sendhelo();
00390                                         <span class="keywordflow">return</span>(1);
00391                                 
00392                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a9">SMTP_MAILFROM_SENT</a>:
00393                                         smtpc_sendmailfrom();
00394                                         <span class="keywordflow">return</span>(1);
00395                                         
00396                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a11">SMTP_RCPTTO_SENT</a>:
00397                                         smtpc_sendrcptto();
00398                                         <span class="keywordflow">return</span>(1);
00399                                 
00400                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a13">SMTP_DATAREQ_SENT</a>:
00401                                         smtpc_senddatareq();
00402                                         <span class="keywordflow">return</span>(1);
00403                                 
00404                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a15">SMTP_BODY_SENT</a>:
00405                                         smtpc_sendbody();
00406                                         <span class="keywordflow">return</span>(1);      
00407                                 
00408                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a16">SMTP_SENDING_DATA</a>:
00409                                         smtpc_senddata();
00410                                         <span class="keywordflow">return</span>(1);
00411                                 
00412                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a18">SMTP_DATAEND_SENT</a>: 
00413                                         smtpc_senddataend();
00414                                         <span class="keywordflow">return</span>(1);
00415                                 
00416                                 <span class="keywordflow">case</span> <a class="code" href="smtp__client_8h.html#a20">SMTP_QUIT_SENT</a>:
00417                                         smtpc_sendquit();
00418                                         <span class="keywordflow">return</span>(1);
00419                                         
00420                                 <span class="keywordflow">default</span>:
00421                                         <span class="keywordflow">return</span>(-1);
00422                         }
00423                 
00424                 
00425                         <span class="keywordflow">break</span>;
00426         
00427         
00428                 <span class="keywordflow">default</span>:
00429                         <span class="keywordflow">return</span>(-1);
00430         }       
00431 
00432         <span class="keywordflow">return</span>(-1);
00433 
00434 }
00435 
00436 <span class="comment">/********************************************************************************</span>
00437 <span class="comment">Function:               smtpc_run</span>
00438 <span class="comment"></span>
00439 <span class="comment">Parameters:             void    </span>
00440 <span class="comment">                                </span>
00441 <span class="comment">Return val:             void</span>
00442 <span class="comment">                                </span>
00443 <span class="comment">Date:                   21.7.2002</span>
00444 <span class="comment"></span>
00445 <span class="comment">Desc:                   This function is main 'thread' of SMTP client program</span>
00446 <span class="comment">                                and should be called periodically when SMTP client is</span>
00447 <span class="comment">                                active. This function is responsible of sending commands and</span>
00448 <span class="comment">                                data to SMTP server and making callbacks to user function stubs.</span>
00449 <span class="comment">*********************************************************************************/</span>
00450 
00451 
00452 <span class="keywordtype">void</span> smtpc_run (<span class="keywordtype">void</span>)
00453 {
00454         <span class="comment">/* On that function we can send data when called by main loop   */</span>
00455         
00456         <span class="keywordflow">if</span>( <a class="code" href="smtp__client_8c.html#a0">smtpc_init_done</a> == 0 )
00457                 <span class="keywordflow">return</span>;
00458         
00459         <span class="keywordflow">if</span>( <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state &lt; <a class="code" href="smtp__client_8h.html#a3">SMTP_OPEN_REQUESTED</a>)
00460                 <span class="keywordflow">return</span>;
00461                 
00462         <span class="comment">/* Is there timeout of some sort?       */</span>
00463                 
00464         <span class="keywordflow">if</span>(<a class="code" href="timers_8c.html#a7">check_timer</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.tmrhandle) == 0) {
00465                 <span class="comment">/* Yep  */</span>
00466                 <a class="code" href="tcp_8c.html#a11">tcp_abort</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle);
00467                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a>);
00468                         
00469                 <span class="comment">/* Make user callback   */</span>
00470                 <a class="code" href="smtpc__callbacks_8c.html#a46">smtpc_error</a>();
00471                 <span class="keywordflow">return</span>;
00472                 
00473         }       
00474         
00475         <span class="keywordflow">if</span>( <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a3">SMTP_OPEN_REQUESTED</a>) {
00476                 <span class="comment">/* We are on this state because user has requested connection   */</span>
00477                 <span class="comment">/* but connection is not yet opened.                                                    */</span>
00478                 <span class="comment">/* Try to get TCP stack to accept our connection request                */</span>
00479                 
00480                 <a class="code" href="tcp_8c.html#a11">tcp_abort</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle);       <span class="comment">/* Release old connection       */</span>
00481                 <span class="keywordflow">if</span>(<a class="code" href="tcp_8c.html#a6">tcp_connect</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.remip, <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.remport, 0) &gt;= 0)
00482                         smtpc_changestate(<a class="code" href="smtp__client_8h.html#a4">SMTP_CONNECTIONOPEN_SENT</a>);
00483                 
00484                 <span class="keywordflow">return</span>;
00485         }
00486         
00487         
00488 
00489         <span class="keywordflow">if</span>( <a class="code" href="tcp_8c.html#a9">tcp_getstate</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle) != <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a> ) {
00490                 <span class="keywordflow">return</span>;
00491         }
00492         
00493         <span class="keywordflow">if</span>( <a class="code" href="tcp_8c.html#a10">tcp_checksend</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle) &lt; 0 )
00494                 <span class="keywordflow">return</span>;
00495         
00496         <span class="comment">/* It's connected and no unacked data so try to send    */</span>
00497         
00498         
00499         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a6">SMTP_SERVER_READY</a>) {
00500                 <span class="comment">/* Send HELO    */</span>
00501                 smtpc_sendhelo();
00502                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a7">SMTP_HELO_SENT</a>);
00503                 DEBUGOUT(<span class="stringliteral">"SMTP HELO packet sent\r\n"</span>);
00504                 <span class="keywordflow">return</span>;
00505         }
00506         
00507         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a8">SMTP_HELO_ACKED</a>) {
00508                 <span class="comment">/* Send MAIL FROM       */</span>
00509                 smtpc_sendmailfrom();
00510                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a9">SMTP_MAILFROM_SENT</a>);
00511                 DEBUGOUT(<span class="stringliteral">"SMTP MAIL FROM packet sent\r\n"</span>);
00512                 <span class="keywordflow">return</span>;
00513         }       
00514         
00515         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a10">SMTP_MAILFROM_ACKED</a>) {
00516                 <span class="comment">/* Send RCPT TO */</span>
00517                 smtpc_sendrcptto();
00518                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a11">SMTP_RCPTTO_SENT</a>);
00519                 DEBUGOUT(<span class="stringliteral">"SMTP RCPT TO packet sent\r\n"</span>);
00520                 <span class="keywordflow">return</span>;
00521         }       
00522         
00523         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a12">SMTP_RCPTTO_ACKED</a>) {
00524                 <span class="comment">/* Send DATA    */</span>
00525                 smtpc_senddatareq();
00526                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a13">SMTP_DATAREQ_SENT</a>);
00527                 DEBUGOUT(<span class="stringliteral">"SMTP DATA packet sent\r\n"</span>);
00528                 <span class="keywordflow">return</span>;
00529         }       
00530         
00531         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a14">SMTP_DATAREQ_ACKED</a>)     {
00532                 <span class="comment">/* Send BODY    */</span>
00533                 smtpc_sendbody();
00534                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a15">SMTP_BODY_SENT</a>);
00535                 DEBUGOUT(<span class="stringliteral">"SMTP BODY packet sent\r\n"</span>);
00536                 <span class="keywordflow">return</span>;
00537         }       
00538         
00539         
00540         <span class="comment">/* Body is part of plain text so we just make internal state change     */</span>
00541         <span class="comment">/* when TCP has acked the body packet. This pseudo-state just helps */</span>
00542         <span class="comment">/* us to regenerate the body when needed                                                        */</span>
00543         
00544         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a15">SMTP_BODY_SENT</a>)
00545                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a16">SMTP_SENDING_DATA</a>);
00546         
00547         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a16">SMTP_SENDING_DATA</a>) {
00548                 <span class="comment">/* Inform user app that old data is acked now   */</span>
00549                 
00550                 <a class="code" href="smtpc__callbacks_8c.html#a45">smtpc_dataacked</a>();              
00551         
00552                 <span class="keywordflow">if</span> (smtpc_senddata() &lt; 0) {
00553                         <span class="comment">/* End of data, send CRLF.CRLF  */</span>
00554                         
00555                         DEBUGOUT(<span class="stringliteral">"SMTP End of data reached\r\n"</span>);
00556                         smtpc_senddataend();
00557                         smtpc_changestate(<a class="code" href="smtp__client_8h.html#a18">SMTP_DATAEND_SENT</a>);
00558                         
00559                 }
00560                 <span class="keywordflow">return</span>;
00561         }       
00562         
00563                 
00564         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a19">SMTP_DATAEND_ACKED</a>) {
00565                 <span class="comment">/* Send QUIT    */</span>
00566                 smtpc_sendquit();
00567                 smtpc_changestate(<a class="code" href="smtp__client_8h.html#a20">SMTP_QUIT_SENT</a>);
00568                 DEBUGOUT(<span class="stringliteral">"SMTP QUIT packet sent\r\n"</span>);
00569                 <span class="keywordflow">return</span>;
00570         }               
00571 
00572 
00573         <span class="keywordflow">if</span>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state == <a class="code" href="smtp__client_8h.html#a21">SMTP_QUIT_ACKED</a>) {
00574         
00575                 <span class="comment">/* Inform application that data is sent OK      */</span>
00576                 
00577                 <a class="code" href="smtpc__callbacks_8c.html#a47">smtpc_allok</a>();
00578         
00579                 <span class="comment">/* Try to close TCP     */</span>
00580                 
00581                 <span class="keywordflow">if</span>(<a class="code" href="tcp_8c.html#a8">tcp_close</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle) &gt;= 0) {
00582                         smtpc_changestate(<a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a>);
00583                         DEBUGOUT(<span class="stringliteral">"SMTP connection closed OK\r\n"</span>);
00584                         <span class="keywordflow">return</span>;
00585                 }
00586                 
00587                 <span class="comment">/* Close is not accepted by TCP. See if timeout */</span>
00588                 
00589                 <span class="keywordflow">if</span>(<a class="code" href="timers_8c.html#a7">check_timer</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.tmrhandle) == 0) {
00590                         <span class="comment">/* Use brute force              */</span>
00591                         
00592                         <a class="code" href="tcp_8c.html#a11">tcp_abort</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle);
00593                         smtpc_changestate(<a class="code" href="smtp__client_8h.html#a2">SMTP_CLOSED</a>);
00594                         DEBUGOUT(<span class="stringliteral">"SMTP connection closed by ABORT\r\n"</span>);
00595                         <span class="keywordflow">return</span>;
00596                 }
00597                 
00598                 <span class="comment">/* Keep trying untill timeout   */</span>
00599                 
00600                 <span class="keywordflow">return</span>;
00601                 
00602         }       
00603         
00604         <span class="keywordflow">return</span>;
00605 
00606 }
00607 
00608 
00609 <span class="keywordtype">void</span> smtpc_sendhelo (<span class="keywordtype">void</span>)
00610 {
00611         INT8 i;
00612         UINT8* buf;
00613 
00614         <span class="comment">/* Fill TCP Tx buffer with "HELO " and use callback function    */</span>
00615         <span class="comment">/* smtp_getdomain in order to get domain from systems and send  */</span>
00616         <span class="comment">/* that combined "HELO domainnname" to SMTP server                              */</span>
00617         
00618         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
00619         
00620         *buf++ = <span class="charliteral">'H'</span>;
00621         *buf++ = <span class="charliteral">'E'</span>;
00622         *buf++ = <span class="charliteral">'L'</span>;
00623         *buf++ = <span class="charliteral">'O'</span>;
00624         *buf++ = <span class="charliteral">' '</span>; 
00625         
00626         i = <a class="code" href="smtpc__callbacks_8c.html#a2">smtpc_getdomain</a>(buf);
00627         
00628         <span class="keywordflow">if</span>(i &lt; 0)
00629                 <span class="keywordflow">return</span>;
00630         
00631         buf += i;       
00632         
00633         <span class="comment">/* Insert CRLF  */</span>
00634         
00635         *buf++ = <span class="charliteral">'\r'</span>;
00636         *buf = <span class="charliteral">'\n'</span>;
00637                 
00638 
00639         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 7);
00640 
00641 }
00642 
00643 
00644 
00645 <span class="keywordtype">void</span> smtpc_sendmailfrom (<span class="keywordtype">void</span>)
00646 {
00647         INT8 i;
00648         UINT8* buf;
00649 
00650         <span class="comment">/* Fill TCP Tx buffer with "MAIL FROM: &lt;" and use callback function                             */</span>
00651         <span class="comment">/* smtp_getsender in order to get local e-mail address from user and send               */</span>
00652         <span class="comment">/* that combined "MAIL FROM: &lt;myadr&gt;" to SMTP server                                                    */</span>
00653         
00654         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
00655         
00656         *buf++ = <span class="charliteral">'M'</span>;
00657         *buf++ = <span class="charliteral">'A'</span>;
00658         *buf++ = <span class="charliteral">'I'</span>;
00659         *buf++ = <span class="charliteral">'L'</span>;
00660         *buf++ = <span class="charliteral">' '</span>; 
00661         *buf++ = <span class="charliteral">'F'</span>;
00662         *buf++ = <span class="charliteral">'R'</span>;
00663         *buf++ = <span class="charliteral">'O'</span>;
00664         *buf++ = <span class="charliteral">'M'</span>;
00665         *buf++ = <span class="charliteral">':'</span>;
00666         *buf++ = <span class="charliteral">' '</span>;
00667         *buf++ = <span class="charliteral">'&lt;'</span>;   
00668         
00669         i = <a class="code" href="smtpc__callbacks_8c.html#a3">smtpc_getsender</a>(buf);
00670         
00671         <span class="keywordflow">if</span>(i &lt; 0)
00672                 <span class="keywordflow">return</span>;
00673         
00674         buf += i;
00675         
00676         <span class="comment">/* Insert &gt;CRLF */</span>
00677         
00678         *buf++ = <span class="charliteral">'&gt;'</span>;
00679         *buf++ = <span class="charliteral">'\r'</span>;
00680         *buf = <span class="charliteral">'\n'</span>;
00681                 
00682 
00683         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 15);
00684 
00685 }
00686 
00687 
00688 
00689 <span class="keywordtype">void</span> smtpc_sendrcptto (<span class="keywordtype">void</span>)
00690 {
00691         INT8 i;
00692         UINT8* buf;
00693 
00694         <span class="comment">/* Fill TCP Tx buffer with "RCPT TO: &lt;" and use callback function                       */</span>
00695         <span class="comment">/* smtp_getreceiver in order to get receiver address from user and send         */</span>
00696         <span class="comment">/* that combined "RCPT To: &lt;rcvadr&gt;" to SMTP server                                                     */</span>
00697         
00698         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
00699         
00700         *buf++ = <span class="charliteral">'R'</span>;
00701         *buf++ = <span class="charliteral">'C'</span>;
00702         *buf++ = <span class="charliteral">'P'</span>;
00703         *buf++ = <span class="charliteral">'T'</span>;
00704         *buf++ = <span class="charliteral">' '</span>; 
00705         *buf++ = <span class="charliteral">'T'</span>;
00706         *buf++ = <span class="charliteral">'O'</span>;
00707         *buf++ = <span class="charliteral">':'</span>;
00708         *buf++ = <span class="charliteral">' '</span>;
00709         *buf++ = <span class="charliteral">'&lt;'</span>;   
00710         
00711         i = <a class="code" href="smtpc__callbacks_8c.html#a4">smtpc_getreceiver</a>(buf);
00712         
00713         <span class="keywordflow">if</span>(i &lt; 0)
00714                 <span class="keywordflow">return</span>;
00715                 
00716         buf += i;       
00717         
00718         <span class="comment">/* Insert &gt;CRLF */</span>
00719         
00720         *buf++ = <span class="charliteral">'&gt;'</span>;
00721         *buf++ = <span class="charliteral">'\r'</span>;
00722         *buf = <span class="charliteral">'\n'</span>;
00723                 
00724 
00725         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 13);
00726 
00727 }
00728 
00729 <span class="keywordtype">void</span> smtpc_senddatareq (<span class="keywordtype">void</span>)
00730 {
00731         UINT8* buf;
00732 
00733         <span class="comment">/* Fill TCP Tx buffer with "DATA" and send to SMTP server       */</span>
00734         
00735         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
00736         
00737         *buf++ = <span class="charliteral">'D'</span>;
00738         *buf++ = <span class="charliteral">'A'</span>;
00739         *buf++ = <span class="charliteral">'T'</span>;
00740         *buf++ = <span class="charliteral">'A'</span>;
00741 
00742         <span class="comment">/* Insert CRLF  */</span>
00743         
00744         *buf++ = <span class="charliteral">'\r'</span>;
00745         *buf = <span class="charliteral">'\n'</span>;
00746                 
00747         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, 6);
00748 
00749 }
00750 
00751 <span class="keywordtype">void</span> smtpc_sendbody (<span class="keywordtype">void</span>)
00752 {
00753         UINT8* buf;
00754         INT8 i;
00755         UINT8 j;
00756 
00757         <span class="comment">/* Fill TCP Tx buffer with RFC 822 body and send to SMTP server */</span>
00758         
00759         j = 0;
00760         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
00761         
00762         *buf++ = <span class="charliteral">'T'</span>;
00763         *buf++ = <span class="charliteral">'o'</span>;
00764         *buf++ = <span class="charliteral">':'</span>;
00765         *buf++ = <span class="charliteral">' '</span>;
00766         
00767         i = <a class="code" href="smtpc__callbacks_8c.html#a4">smtpc_getreceiver</a>(buf);
00768         
00769         <span class="keywordflow">if</span>(i &lt; 0)
00770                 <span class="keywordflow">return</span>;
00771                 
00772         buf += i;       
00773                 
00774         j += i;
00775 
00776         <span class="comment">/* Insert CRLF  */</span>
00777         
00778         *buf++ = <span class="charliteral">'\r'</span>;
00779         *buf++ = <span class="charliteral">'\n'</span>;
00780         
00781         *buf++ = <span class="charliteral">'S'</span>;
00782         *buf++ = <span class="charliteral">'u'</span>;
00783         *buf++ = <span class="charliteral">'b'</span>;
00784         *buf++ = <span class="charliteral">'j'</span>;
00785         *buf++ = <span class="charliteral">'e'</span>;
00786         *buf++ = <span class="charliteral">'c'</span>;
00787         *buf++ = <span class="charliteral">'t'</span>;
00788         *buf++ = <span class="charliteral">':'</span>;
00789         *buf++ = <span class="charliteral">' '</span>;
00790         
00791         i = <a class="code" href="smtpc__callbacks_8c.html#a5">smtpc_getsubject</a>(buf);
00792         
00793         <span class="keywordflow">if</span>(i &lt; 0)
00794                 <span class="keywordflow">return</span>;
00795         
00796         buf += i;
00797         
00798         j += i;
00799 
00800         <span class="comment">/* Insert CRLF  */</span>
00801         
00802         *buf++ = <span class="charliteral">'\r'</span>;
00803         *buf++ = <span class="charliteral">'\n'</span>;  
00804         
00805         *buf++ = <span class="charliteral">'F'</span>;
00806         *buf++ = <span class="charliteral">'r'</span>;
00807         *buf++ = <span class="charliteral">'o'</span>;
00808         *buf++ = <span class="charliteral">'m'</span>;
00809         *buf++ = <span class="charliteral">':'</span>;
00810         *buf++ = <span class="charliteral">' '</span>;
00811         
00812         i = <a class="code" href="smtpc__callbacks_8c.html#a3">smtpc_getsender</a>(buf);
00813         
00814         <span class="keywordflow">if</span>(i &lt; 0)
00815                 <span class="keywordflow">return</span>;
00816         
00817         buf += i;
00818         
00819         j += i;
00820 
00821         <span class="comment">/* Insert CRLF  */</span>
00822         
00823         *buf++ = <span class="charliteral">'\r'</span>;
00824         *buf++ = <span class="charliteral">'\n'</span>;  
00825         
00826         <span class="comment">/* Insert emty row      */</span>
00827         
00828         *buf++ = <span class="charliteral">'\r'</span>;
00829         *buf = <span class="charliteral">'\n'</span>;
00830                 
00831         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, j + 27);
00832 
00833 }
00834 
00835 
00836 <span class="keywordtype">void</span> smtpc_senddataend (<span class="keywordtype">void</span>)
00837 {
00838         UINT8* buf;
00839 
00840         <span class="comment">/* Fill TCP Tx buffer with CRLF.CRLF and send to SMTP server    */</span>
00841         
00842         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
00843         
00844         *buf++ = <span class="charliteral">'\r'</span>;
00845         *buf++ = <span class="charliteral">'\n'</span>;
00846         *buf++ = <span class="charliteral">'.'</span>;
00847         *buf++ = <span class="charliteral">'\r'</span>;
00848         *buf = <span class="charliteral">'\n'</span>;
00849                 
00850         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, 5);
00851 
00852 }
00853 
00854 
00855 <span class="keywordtype">void</span> smtpc_sendquit (<span class="keywordtype">void</span>)
00856 {
00857         UINT8* buf;
00858 
00859         <span class="comment">/* Fill TCP Tx buffer with "QUIT" and send to SMTP server       */</span>
00860         
00861         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
00862         
00863         *buf++ = <span class="charliteral">'Q'</span>;
00864         *buf++ = <span class="charliteral">'U'</span>;
00865         *buf++ = <span class="charliteral">'I'</span>;
00866         *buf++ = <span class="charliteral">'T'</span>;
00867 
00868         <span class="comment">/* Insert CRLF  */</span>
00869         
00870         *buf++ = <span class="charliteral">'\r'</span>;
00871         *buf = <span class="charliteral">'\n'</span>;
00872                 
00873         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, 6);
00874 
00875 }
00876 
00877 
00878 INT16 smtpc_senddata (<span class="keywordtype">void</span>)
00879 {
00880 
00881         INT16 len;
00882 
00883         <span class="comment">/* Use callback smtpc_getdata in order to fill Tx buffer with user data */</span>
00884         <span class="comment">/* Normally user callback should return number of bytes assembled but   */</span>
00885         <span class="comment">/* when end of data is reached no bytes are written but (-1) returned   */</span>
00886         
00887         len = <a class="code" href="smtpc__callbacks_8c.html#a6">smtpc_getdata</a>(&amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>);
00888         
00889         <span class="keywordflow">if</span>(len &lt; 0)
00890                 <span class="keywordflow">return</span>(-1);
00891                 
00892         <span class="keywordflow">if</span>(len &gt; 0)     
00893                 <a class="code" href="tcp_8c.html#a7">tcp_send</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.sochandle, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, (UINT16)len);
00894         
00895         <span class="keywordflow">return</span>(len);
00896         
00897 }
00898 
00899 <span class="keywordtype">void</span> smtpc_changestate (UINT8 nstate)
00900 {
00901         
00902         <a class="code" href="timers_8c.html#a6">init_timer</a>(<a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.tmrhandle, <a class="code" href="smtp__client_8h.html#a0">SMTPC_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
00903         <a class="code" href="smtp__client_8c.html#a8">smtp_client</a>.state = nstate;
00904 
00905 }
00906 
00907 
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:33:00 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
