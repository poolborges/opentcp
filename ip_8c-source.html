<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/ip.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/ip.c</h1><a href="ip_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright </span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright </span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the </span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if </span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola </span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself, </span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to </span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior </span>
00026 <span class="comment"> *written permission. For written permission, please contact </span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP", </span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written </span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED </span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE </span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR </span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE </span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, </span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series </span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to </span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see </span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00070 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00071 <span class="preprocessor">#include &lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00072 <span class="preprocessor">#include &lt;<a class="code" href="ethernet_8h.html">inet/ethernet.h</a>&gt;</span>
00073 <span class="preprocessor">#include &lt;<a class="code" href="arp_8h.html">inet/arp.h</a>&gt;</span>
00074 <span class="preprocessor">#include &lt;<a class="code" href="ip_8h.html">inet/ip.h</a>&gt;</span>
00075 <span class="preprocessor">#include &lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00076 
00077 
<a name="l00085"></a><a class="code" href="ip_8c.html#a0">00085</a> <span class="keyword">struct </span><a class="code" href="structip__frame.html">ip_frame</a> received_ip_packet;
00086 
<a name="l00095"></a><a class="code" href="ip_8c.html#a1">00095</a> <span class="keyword">struct </span><a class="code" href="structip__frame.html">ip_frame</a> send_ip_packet;
00096 
<a name="l00097"></a><a class="code" href="ip_8c.html#a2">00097</a> UINT16 <a class="code" href="ip_8c.html#a2">ip_id</a>;   
<a name="l00115"></a><a class="code" href="ip_8c.html#a3">00115</a> INT16 <a class="code" href="ip_8c.html#a3">process_ip_in</a> (<span class="keyword">struct</span> <a class="code" href="structethernet__frame.html">ethernet_frame</a>* frame)
00116 {
00117 
00118         UINT8 olen;
00119         UINT8 i;
00120         
00121         <span class="comment">/* Check for Protocol                                                           */</span>
00122         
00123         IP_DEBUGOUT(<span class="stringliteral">"Checking if IP Protocol\n\r"</span>);
00124         
00125         <span class="keywordflow">if</span>( frame-&gt;<a class="code" href="structethernet__frame.html#m3">protocol</a> != <a class="code" href="ethernet_8h.html#a4">PROTOCOL_IP</a> )
00126                 <span class="keywordflow">return</span>(-1);
00127         
00128         
00129         IP_DEBUGOUT(<span class="stringliteral">"It's IP\n\r"</span>);
00130         
00131         <span class="keywordflow">if</span>( frame-&gt;<a class="code" href="structethernet__frame.html#m2">frame_size</a> &lt; ETH_HEADER_LEN )
00132                 <span class="keywordflow">return</span>(-1);
00133                 
00134         <span class="keywordflow">if</span>( (frame-&gt;<a class="code" href="structethernet__frame.html#m2">frame_size</a> - ETH_HEADER_LEN) &lt; IP_HLEN )
00135                 <span class="keywordflow">return</span>(-1); 
00136                                 
00137         <span class="comment">/* Get IP Header Information                                            */</span>
00138                 
00139         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(frame-&gt;<a class="code" href="structethernet__frame.html#m4">buf_index</a>);
00140                 
00141         received_ip_packet.<a class="code" href="structip__frame.html#m0">vihl</a> = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00142                 
00143         <span class="comment">/* Is it IPv4?  */</span>
00144                 
00145         <span class="keywordflow">if</span>( (received_ip_packet.<a class="code" href="structip__frame.html#m0">vihl</a> &amp; 0xF0) != 0x40 ) {
00146                 IP_DEBUGOUT(<span class="stringliteral">"ERROR: IP is not version 4!\n\r"</span>);
00147                 <span class="keywordflow">return</span>(-1);
00148         }
00149                 
00150         IP_DEBUGOUT(<span class="stringliteral">"IP Version 4 OK!\n\r"</span>);    
00151                 
00152         received_ip_packet.<a class="code" href="structip__frame.html#m1">tos</a> = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();                                           
00153         
00154         received_ip_packet.<a class="code" href="structip__frame.html#m2">tlen</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
00155         received_ip_packet.<a class="code" href="structip__frame.html#m2">tlen</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00156                 
00157         received_ip_packet.<a class="code" href="structip__frame.html#m3">id</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
00158         received_ip_packet.<a class="code" href="structip__frame.html#m3">id</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00159                 
00160         received_ip_packet.<a class="code" href="structip__frame.html#m4">frags</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
00161         received_ip_packet.<a class="code" href="structip__frame.html#m4">frags</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00162                 
00163         received_ip_packet.<a class="code" href="structip__frame.html#m5">ttl</a>= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00164                 
00165         received_ip_packet.<a class="code" href="structip__frame.html#m6">protocol</a>= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00166                 
00167         received_ip_packet.<a class="code" href="structip__frame.html#m7">checksum</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
00168         received_ip_packet.<a class="code" href="structip__frame.html#m7">checksum</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00169                 
00170         received_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> = (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 24);
00171         received_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> |= (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 16);
00172         received_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> |= (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8);
00173         received_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00174                 
00175         received_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> = (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 24);
00176         received_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> |= (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 16);
00177         received_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> |= (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8);
00178         received_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00179 
00180         <span class="comment">/* Is that packet for us?                       */</span>
00181 
00182 
00183         <span class="keywordflow">if</span>((received_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> != localmachine.localip )&amp;&amp;
00184                 (received_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> != IP_BROADCAST_ADDRESS)) {
00185 
00186                 <span class="comment">/* It's not for us. Check still if ICMP with rigth physical     */</span>
00187                 <span class="comment">/* address that migth be used to set temporary IP                       */</span>
00188                 
00189                 IP_DEBUGOUT(<span class="stringliteral">"IP address does not match!\n\r"</span>);
00190                 
00191                 <span class="keywordflow">if</span>( received_ip_packet.<a class="code" href="structip__frame.html#m6">protocol</a> != <a class="code" href="ip_8h.html#a1">IP_ICMP</a>) 
00192                         <span class="keywordflow">return</span>(-1);
00193                         
00194                 <span class="comment">/* Check physical address                       */</span>
00195                 
00196                 <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="ip_8h.html#a0">PHY_ADR_LEN</a>; i++)
00197                 {
00198                         <span class="keywordflow">if</span>(frame-&gt;<a class="code" href="structethernet__frame.html#m0">destination</a>[i] != localmachine.localHW[i])
00199                                 <span class="keywordflow">return</span>(-1);
00200                 }       
00201 
00202         }
00203         
00204         
00205         <span class="comment">/* Is there options to copy?            */</span>
00206                 
00207         olen = ((received_ip_packet.<a class="code" href="structip__frame.html#m0">vihl</a> &amp; 0x0F) &lt;&lt; 2) - IP_MIN_HLEN;
00208         
00209         <span class="comment">/* Somebody bluffing with too long option field?        */</span>
00210         
00211         <span class="keywordflow">if</span>(olen &gt; MAX_IP_OPTLEN) {
00212                 IP_DEBUGOUT(<span class="stringliteral">"ERROR:Size of maximum allowed IP option lengt exceeded!\n\r"</span>);
00213                 <span class="keywordflow">return</span>(-1);
00214         }
00215         
00216         <span class="keywordflow">if</span>( olen &gt; (frame-&gt;<a class="code" href="structethernet__frame.html#m2">frame_size</a> - ETH_HEADER_LEN - IP_HLEN) )     {
00217                 IP_DEBUGOUT(<span class="stringliteral">"ERROR:IP option field too long!\n\r"</span>);
00218                 <span class="keywordflow">return</span>(-1);
00219         }
00220                 
00221         <span class="keywordflow">for</span>( i=0; i &lt; olen; i++ ) {
00222                 received_ip_packet.<a class="code" href="structip__frame.html#m10">opt</a>[i] = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();        
00223                 IP_DEBUGOUT(<span class="stringliteral">"IP Options..\n\r"</span>);
00224         }
00225         
00226         <span class="keywordflow">if</span>(received_ip_packet.<a class="code" href="structip__frame.html#m2">tlen</a> &gt;  (frame-&gt;<a class="code" href="structethernet__frame.html#m2">frame_size</a> - ETH_HEADER_LEN) ) {
00227                 IP_DEBUGOUT(<span class="stringliteral">"ERROR: Total len too long\r\n"</span>);
00228                 <span class="keywordflow">return</span>(-1);
00229         }
00230         
00231         <span class="comment">/* Is the checksum OK?  */</span>
00232         
00233         IP_DEBUGOUT(<span class="stringliteral">"Validating the IP checksum..\n\r"</span>);
00234         
00235         <span class="keywordflow">if</span> ( <a class="code" href="ip_8c.html#a6">ip_check_cs</a>(&amp;received_ip_packet) != <a class="code" href="system_8h.html#a1">TRUE</a> ) {
00236                 IP_DEBUGOUT(<span class="stringliteral">"IP Checksum Corrupted..\n\r"</span>);
00237                 <span class="keywordflow">return</span>(-1);
00238         }       
00239         
00240         IP_DEBUGOUT(<span class="stringliteral">"..Checksum OK!\n\r"</span>);      
00241         
00242         <span class="comment">/* Add the address to ARP cache */</span>
00243         
00244         <span class="keywordflow">if</span>( received_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> != IP_BROADCAST_ADDRESS)
00245                 <a class="code" href="arp_8c.html#a7">arp_add</a>( received_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a>, &amp;frame-&gt;<a class="code" href="structethernet__frame.html#m1">source</a>[0], <a class="code" href="arp_8h.html#a17">ARP_TEMP_IP</a>);
00246         
00247         <span class="comment">/* Calculate the start of next layer data       */</span>
00248         
00249         received_ip_packet.<a class="code" href="structip__frame.html#m11">buf_index</a> = frame-&gt;<a class="code" href="structethernet__frame.html#m4">buf_index</a> + IP_HLEN + olen;
00250         
00251         <span class="comment">/* Is this packet fragmented?                                           */</span>
00252         <span class="comment">/* We don't deal with those                                                     */</span>
00253         <span class="comment">/* TODO: Implement Stub handler for more mem. uP's      */</span>
00254         
00255         <span class="keywordflow">if</span>( received_ip_packet.<a class="code" href="structip__frame.html#m4">frags</a> &amp; (IP_MOREFRAGS | IP_FRAGOFF) ) {
00256                 IP_DEBUGOUT(<span class="stringliteral">"Fragmented IP packet\r\n"</span>);
00257                 <span class="keywordflow">return</span>(-1);
00258         }
00259         <span class="comment">/* checking moved upwards!</span>
00260 <span class="comment">        if( received_ip_packet.frags &amp; IP_FRAGOFF )     {</span>
00261 <span class="comment">                IP_DEBUGOUT("Fragmented IP packet\r\n");</span>
00262 <span class="comment">                return(-1);</span>
00263 <span class="comment">        }</span>
00264 <span class="comment">        */</span>
00265         
00266         IP_DEBUGOUT(<span class="stringliteral">"Leaving IP succesfully..\n\r"</span>);
00267         
00268         <span class="keywordflow">return</span>(received_ip_packet.<a class="code" href="structip__frame.html#m2">tlen</a> - IP_HLEN - olen);
00269         
00270 }
00271 
<a name="l00300"></a><a class="code" href="ip_8c.html#a4">00300</a> INT16 <a class="code" href="ip_8c.html#a4">process_ip_out</a> (UINT32 ipadr, UINT8 pcol, UINT8 tos, UINT8 ttl, UINT8* dat, UINT16 len)
00301 {
00302         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00303         UINT16 i;
00304         
00305         <span class="comment">/* Try to get MAC address from ARP cache        */</span>
00306         
00307         qstruct = <a class="code" href="arp_8c.html#a8">arp_find</a>(ipadr, &amp;localmachine, <a class="code" href="arp_8h.html#a17">ARP_TEMP_IP</a>);
00308         
00309         <span class="keywordflow">if</span>( qstruct == 0 )              <span class="comment">/* Not ready yet        */</span>
00310                 <span class="keywordflow">return</span>(-2);
00311                 
00312         <span class="comment">/* Select network buffer                                                */</span>
00313         <span class="comment">/* TODO: This network related stuff should              */</span>
00314         <span class="comment">/* be moved and abstracted to Ethernet layer    */</span>
00315         
00316         <span class="keywordflow">switch</span>(pcol) {
00317                 <span class="keywordflow">case</span> <a class="code" href="ip_8h.html#a1">IP_ICMP</a>:
00318                 
00319                         <a class="code" href="system_8h.html#a17">NETWORK_SEND_INITIALIZE</a>(<a class="code" href="ethernet_8h.html#a36">ICMP_BUF</a>);
00320                         IP_DEBUGOUT(<span class="stringliteral">"Assembling IP packet to ICMP buffer\n\r"</span>);
00321                         
00322                         <span class="keywordflow">break</span>;
00323                         
00324                 <span class="keywordflow">case</span> <a class="code" href="ip_8h.html#a2">IP_UDP</a>:
00325                 
00326                         <a class="code" href="system_8h.html#a17">NETWORK_SEND_INITIALIZE</a>(<a class="code" href="ethernet_8h.html#a38">UDP_BUF</a>);
00327                         IP_DEBUGOUT(<span class="stringliteral">"Assembling IP packet to UDP buffer\n\r"</span>);
00328                         
00329                         <span class="keywordflow">break</span>;
00330                         
00331                 <span class="keywordflow">case</span> <a class="code" href="ip_8h.html#a3">IP_TCP</a>:
00332                 
00333                         <a class="code" href="system_8h.html#a17">NETWORK_SEND_INITIALIZE</a>(<a class="code" href="ethernet_8h.html#a37">TCP_BUF</a>);
00334                         IP_DEBUGOUT(<span class="stringliteral">"Assembling IP packet to TCP buffer\n\r"</span>);
00335                         
00336                         <span class="keywordflow">break</span>;
00337         
00338                 <span class="keywordflow">default</span>:                        <span class="comment">/* Unknown protocol     */</span>
00339                         <span class="keywordflow">return</span>(-1);
00340         }
00341         
00342         <span class="comment">/* Fill the Ethernet information        */</span>
00343         
00344         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>; i++)     {
00345                 send_frame.destination[i] = qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[i];
00346                 send_frame.source[i] = localmachine.localHW[i];
00347         }
00348         
00349         send_frame.protocol = <a class="code" href="ethernet_8h.html#a4">PROTOCOL_IP</a>;
00350         
00351         <a class="code" href="system_8h.html#a18">NETWORK_ADD_DATALINK</a>(&amp;send_frame);
00352         
00353         <span class="comment">/* Construct the IP header      */</span>
00354         
00355         send_ip_packet.<a class="code" href="structip__frame.html#m0">vihl</a> = IP_DEF_VIHL;
00356         send_ip_packet.<a class="code" href="structip__frame.html#m1">tos</a> = tos;
00357         send_ip_packet.<a class="code" href="structip__frame.html#m2">tlen</a> = IP_HLEN + len;
00358         send_ip_packet.<a class="code" href="structip__frame.html#m3">id</a> = <a class="code" href="ip_8c.html#a2">ip_id</a>++;
00359         send_ip_packet.<a class="code" href="structip__frame.html#m4">frags</a> = 0;
00360         send_ip_packet.<a class="code" href="structip__frame.html#m5">ttl</a> = ttl;
00361         send_ip_packet.<a class="code" href="structip__frame.html#m6">protocol</a> = pcol;
00362         send_ip_packet.<a class="code" href="structip__frame.html#m7">checksum</a> = 0;
00363         send_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> = localmachine.localip;
00364         send_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> = ipadr;
00365         
00366         <span class="comment">/* Calculate checksum for the IP header */</span>
00367         
00368         send_ip_packet.<a class="code" href="structip__frame.html#m7">checksum</a> = <a class="code" href="ip_8c.html#a5">ip_construct_cs</a>( &amp;send_ip_packet );
00369         
00370         <span class="comment">/* Assemble bytes to network    */</span>
00371         
00372         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(send_ip_packet.<a class="code" href="structip__frame.html#m0">vihl</a>);
00373         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(send_ip_packet.<a class="code" href="structip__frame.html#m1">tos</a>);
00374         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m2">tlen</a> &gt;&gt; 8) );
00375         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)send_ip_packet.<a class="code" href="structip__frame.html#m2">tlen</a> );           
00376         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m3">id</a> &gt;&gt; 8) );
00377         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)send_ip_packet.<a class="code" href="structip__frame.html#m3">id</a> );
00378         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m4">frags</a> &gt;&gt; 8) );
00379         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)send_ip_packet.<a class="code" href="structip__frame.html#m4">frags</a> );
00380         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(send_ip_packet.<a class="code" href="structip__frame.html#m5">ttl</a>);
00381         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(send_ip_packet.<a class="code" href="structip__frame.html#m6">protocol</a>);        
00382         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m7">checksum</a> &gt;&gt; 8) );
00383         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)send_ip_packet.<a class="code" href="structip__frame.html#m7">checksum</a> );
00384         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 24) );
00385         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 16) );
00386         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 8) );
00387         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)send_ip_packet.<a class="code" href="structip__frame.html#m8">sip</a> );
00388         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 24) );
00389         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 16) );
00390         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)(send_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 8) );
00391         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (UINT8)send_ip_packet.<a class="code" href="structip__frame.html#m9">dip</a> );
00392         
00393         <span class="comment">/* Assemble data        */</span>
00394         
00395         <a class="code" href="system_8h.html#a12">SEND_NETWORK_BUF</a>(dat,len);
00396                 
00397         <span class="comment">/* Launch it            */</span>
00398         
00399         <a class="code" href="system_8h.html#a16">NETWORK_COMPLETE_SEND</a>( send_ip_packet.<a class="code" href="structip__frame.html#m2">tlen</a> );
00400         
00401         <span class="keywordflow">return</span>(len);
00402         
00403         
00404 }
00405 
<a name="l00417"></a><a class="code" href="ip_8c.html#a5">00417</a> UINT32 <a class="code" href="ip_8c.html#a5">ip_construct_cs</a> (<span class="keyword">struct</span> <a class="code" href="structip__frame.html">ip_frame</a>* frame)
00418 {
00419         UINT16 ip_cs;
00420         UINT8 cs_cnt;
00421         UINT8 olen;
00422         UINT8 i;
00423         
00424         ip_cs = 0;
00425         cs_cnt = 0;
00426         
00427         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, frame-&gt;<a class="code" href="structip__frame.html#m0">vihl</a>, cs_cnt++);
00428         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, frame-&gt;<a class="code" href="structip__frame.html#m1">tos</a>, cs_cnt++);
00429         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m2">tlen</a> &gt;&gt; 8), cs_cnt++);
00430         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m2">tlen</a>, cs_cnt++);
00431         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m3">id</a> &gt;&gt; 8), cs_cnt++);
00432         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m3">id</a>, cs_cnt++);
00433         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m4">frags</a> &gt;&gt; 8), cs_cnt++);
00434         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m4">frags</a>, cs_cnt++);
00435         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, frame-&gt;<a class="code" href="structip__frame.html#m5">ttl</a>, cs_cnt++);
00436         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, frame-&gt;<a class="code" href="structip__frame.html#m6">protocol</a>, cs_cnt++);
00437         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 24), cs_cnt++);
00438         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 16), cs_cnt++);
00439         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 8), cs_cnt++);
00440         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>, cs_cnt++);
00441         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 24), cs_cnt++);
00442         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 16), cs_cnt++);
00443         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 8), cs_cnt++);
00444         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a>, cs_cnt++);        
00445         
00446         <span class="comment">/* Is there options?                            */</span>
00447                 
00448         olen = ((frame-&gt;<a class="code" href="structip__frame.html#m0">vihl</a> &amp; 0x0F) &lt;&lt; 2) - IP_MIN_HLEN;
00449         
00450         <span class="keywordflow">for</span>( i=0; i&lt;olen; i++)
00451                 ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m10">opt</a>[i], cs_cnt++);
00452         
00453         <span class="comment">/* Take complement      */</span>
00454         
00455         ip_cs = ~ ip_cs;
00456 
00457         <span class="keywordflow">return</span>(ip_cs);
00458 
00459 }
00460 
<a name="l00474"></a><a class="code" href="ip_8c.html#a6">00474</a> UINT8 <a class="code" href="ip_8c.html#a6">ip_check_cs</a> (<span class="keyword">struct</span> <a class="code" href="structip__frame.html">ip_frame</a>* frame)
00475 {
00476         UINT16 ip_cs;
00477         UINT8 cs_cnt;
00478         UINT8 olen;
00479         UINT8 i;
00480         
00481         ip_cs = 0;
00482         cs_cnt = 0;
00483         
00484         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, frame-&gt;<a class="code" href="structip__frame.html#m0">vihl</a>, cs_cnt++);
00485         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, frame-&gt;<a class="code" href="structip__frame.html#m1">tos</a>, cs_cnt++);
00486         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m2">tlen</a> &gt;&gt; 8), cs_cnt++);
00487         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m2">tlen</a>, cs_cnt++);
00488         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m3">id</a> &gt;&gt; 8), cs_cnt++);
00489         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m3">id</a>, cs_cnt++);
00490         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m4">frags</a> &gt;&gt; 8), cs_cnt++);
00491         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m4">frags</a>, cs_cnt++);
00492         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, frame-&gt;<a class="code" href="structip__frame.html#m5">ttl</a>, cs_cnt++);
00493         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, frame-&gt;<a class="code" href="structip__frame.html#m6">protocol</a>, cs_cnt++);
00494         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m7">checksum</a> &gt;&gt; 8), cs_cnt++);
00495         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m7">checksum</a>, cs_cnt++);
00496         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 24), cs_cnt++);
00497         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 16), cs_cnt++);
00498         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 8), cs_cnt++);
00499         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>, cs_cnt++);
00500         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 24), cs_cnt++);
00501         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 16), cs_cnt++);
00502         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 8), cs_cnt++);
00503         ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a>, cs_cnt++);        
00504         
00505         <span class="comment">/* Is there options?                            */</span>
00506                 
00507         olen = ((frame-&gt;<a class="code" href="structip__frame.html#m0">vihl</a> &amp; 0x0F) &lt;&lt; 2) - IP_MIN_HLEN;
00508         
00509         <span class="keywordflow">for</span>( i=0; i&lt;olen; i++)
00510                 ip_cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(ip_cs, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m10">opt</a>[i], cs_cnt++);
00511         
00512         <span class="comment">/* Analyze the result   */</span>
00513         
00514         ip_cs = ~ ip_cs;
00515         
00516         <span class="keywordflow">if</span>(ip_cs == IP_GOOD_CS)
00517                 <span class="keywordflow">return</span> 1;
00518         
00519         <span class="comment">/* Fuck, it failed!     */</span>
00520         
00521         <span class="keywordflow">return</span> 0;
00522         
00523 
00524 }
00525 
<a name="l00539"></a><a class="code" href="ip_8c.html#a7">00539</a> UINT16 <a class="code" href="ip_8c.html#a7">ip_checksum</a> (UINT16 cs, UINT8 dat, UINT8 count)
00540 {
00541         UINT8 b = dat;
00542         UINT8 cs_l;
00543         UINT8 cs_h;
00544         
00545         cs_h = (UINT8)(cs &gt;&gt; 8); 
00546         cs_l = (UINT8)cs;
00547 
00548         <span class="keywordflow">if</span>( count &amp; 0x01 ) {
00549                 <span class="comment">/* We are processing LSB        */</span>
00550                 
00551                 <span class="keywordflow">if</span>( (cs_l = cs_l + b) &lt; b ) {
00552                         <span class="keywordflow">if</span>( ++cs_h == 0 )
00553                                 cs_l++;
00554                 }
00555                 
00556         } <span class="keywordflow">else</span> {
00557                 <span class="comment">/* We are processing MSB        */</span>
00558                 
00559                 <span class="keywordflow">if</span>( (cs_h = cs_h + b) &lt; b )     {
00560                         <span class="keywordflow">if</span>( ++cs_l == 0 )
00561                                 cs_h++;
00562                 }
00563         }
00564 
00565         <span class="keywordflow">return</span>( ( (UINT16)cs_h &lt;&lt; 8 ) + cs_l);
00566 
00567 }
00568 
00569 
<a name="l00582"></a><a class="code" href="ip_8c.html#a8">00582</a> UINT32 <a class="code" href="ip_8c.html#a8">ip_checksum_buf</a> (UINT16 cs, UINT8* buf, UINT16 len)
00583 {
00584         UINT16 dat;
00585         UINT32 temp;
00586         
00587         temp = cs;
00588         
00589         <span class="keywordflow">while</span>(len&gt;1)
00590         {
00591                 len -= 2;
00592                 dat = *buf++;
00593                 dat &lt;&lt;= 8;
00594                 dat |= *buf++;
00595                 temp += dat;
00596         }
00597         
00598         temp = (temp &gt;&gt; 16) + (temp &amp; 0xFFFF);  <span class="comment">/* Add in carry         */</span>
00599         temp += (temp &gt;&gt;16);                                    <span class="comment">/* Maybe one more       */</span>
00600         
00601         <span class="keywordflow">if</span>(len)
00602                 temp = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(temp, *buf, 0);
00603         
00604         <span class="keywordflow">return</span>( (UINT16) temp );
00605 
00606 }
00607 
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:33:00 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
