<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/pop3/pop3_client.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/pop3/pop3_client.c</h1><a href="pop3__client_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright </span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright </span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the </span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if </span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola </span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself, </span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to </span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior </span>
00026 <span class="comment"> *written permission. For written permission, please contact </span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP", </span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written </span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED </span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE </span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR </span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE </span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, </span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series </span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to </span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see </span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00068 <span class="preprocessor">#include&lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00069 <span class="preprocessor">#include&lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00070 <span class="preprocessor">#include&lt;<a class="code" href="globalvariables_8h.html">inet/globalvariables.h</a>&gt;</span>
00071 <span class="preprocessor">#include&lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00072 <span class="preprocessor">#include&lt;<a class="code" href="timers_8h.html">inet/timers.h</a>&gt;</span>
00073 <span class="preprocessor">#include&lt;<a class="code" href="tcp__ip_8h.html">inet/tcp_ip.h</a>&gt;</span>
00074 <span class="preprocessor">#include&lt;<a class="code" href="pop3__client_8h.html">inet/pop3/pop3_client.h</a>&gt;</span>
00075 
00076 
<a name="l00077"></a><a class="code" href="pop3__client_8c.html#a0">00077</a> UINT8 <a class="code" href="pop3__client_8c.html#a0">pop3c_init_done</a> = 0; 
<a name="l00085"></a><a class="code" href="pop3__client_8c.html#a1">00085</a> <span class="keyword">struct </span><a class="code" href="structpop3c__struct.html">pop3c_struct</a> pop3_client; 
00086 
00087 
00088 <span class="comment">/* The applications that use TCP must implement following function stubs                        */</span>
00089 <span class="comment">/* void application_name_init (void) - call once when processor starts                          */</span>
00090 <span class="comment">/* void application_name_run (void) - call periodically on main loop                            */</span>
00091 <span class="comment">/* INT32 application_name_eventlistener (INT8, UINT8, UINT32, UINT32)                           */</span>
00092 <span class="comment">/* - called by TCP input process to inform arriving data, errors etc                            */</span>
00093 
00094 
00095 <span class="comment">/* POP3 Client application              */</span>
00096 
00097 
<a name="l00114"></a><a class="code" href="pop3__client_8c.html#a2">00114</a> INT8 <a class="code" href="pop3__client_8c.html#a2">pop3c_connect</a> (UINT32 ip, UINT16 port){
00115         <span class="comment">/* Do we have socket    */</span>
00116 
00117         <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a> &lt; 0 ) {
00118                 DEBUGOUT(<span class="stringliteral">"pop3c_connect() called but no socket\r\n"</span>);
00119                 <span class="keywordflow">return</span>(-1);
00120         }
00121         
00122         <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> &lt; <a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a> ) {
00123                 DEBUGOUT(<span class="stringliteral">"pop3c_connect() called but uninitialized\r\n"</span>);
00124                 <span class="keywordflow">return</span>(-1);
00125         }
00126         
00127         <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a> ) {
00128                 DEBUGOUT(<span class="stringliteral">"POP3 Connection request going to be processed\r\n"</span>);
00129                 pop3_client.<a class="code" href="structpop3c__struct.html#m1">remip</a> = ip;
00130                 pop3_client.<a class="code" href="structpop3c__struct.html#m2">remport</a> = port;
00131                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a5">POP3C_OPEN_REQUESTED</a>);
00132                 <span class="keywordflow">return</span>(1);
00133         }
00134         
00135         <span class="keywordflow">return</span>(-1);     
00136         
00137 }
00138 
<a name="l00148"></a><a class="code" href="pop3__client_8c.html#a3">00148</a> <span class="keywordtype">void</span> <a class="code" href="pop3__client_8c.html#a32">pop3c_init</a> (<span class="keywordtype">void</span>){
00149         
00150         <span class="keywordflow">if</span>(pop3c_init_done) {
00151                 DEBUGOUT(<span class="stringliteral">"POP3 client already initialized\r\n"</span>);
00152                 <span class="keywordflow">return</span>;
00153         }
00154         
00155         
00156         <span class="comment">/* Get timer handle     */</span>
00157         
00158         pop3_client.<a class="code" href="structpop3c__struct.html#m4">tmrhandle</a> = <a class="code" href="timers_8c.html#a2">get_timer</a>();
00159         
00160         <span class="comment">/* Get TCP Socket       */</span>
00161         
00162         pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a> = <a class="code" href="tcp_8c.html#a3">tcp_getsocket</a>(<a class="code" href="tcp__ip_8h.html#a40">TCP_TYPE_CLIENT</a>, <a class="code" href="tcp__ip_8h.html#a18">TCP_TOS_NORMAL</a>, <a class="code" href="group__opentcp__config.html#a14">TCP_DEF_TOUT</a>, pop3c_eventlistener);
00163         
00164         <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a> &lt; 0 ) {
00165                 DEBUGOUT(<span class="stringliteral">"pop3c_init() uncapable of getting socket\r\n"</span>);
00166                 <a class="code" href="system_8h.html#a6">RESET_SYSTEM</a>();
00167         }       
00168         
00169         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>);        
00170         pop3_client.<a class="code" href="structpop3c__struct.html#m1">remip</a> = 0;
00171         pop3_client.<a class="code" href="structpop3c__struct.html#m2">remport</a> = 0;
00172         pop3_client.<a class="code" href="structpop3c__struct.html#m5">unacked</a> = 0;
00173         pop3_client.<a class="code" href="structpop3c__struct.html#m6">msgtotal</a> = 0;
00174         pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a> = 0;
00175         pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> = 0;
00176         pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a> = 0;
00177         pop3_client.<a class="code" href="structpop3c__struct.html#m10">headerbuf</a>[0] = <span class="charliteral">'\0'</span>;
00178         pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00179         pop3_client.<a class="code" href="structpop3c__struct.html#m12">from</a>[0] = <span class="charliteral">'\0'</span>;
00180         pop3_client.<a class="code" href="structpop3c__struct.html#m13">subject</a>[0] = <span class="charliteral">'\0'</span>;
00181         
00182         <a class="code" href="pop3__client_8c.html#a0">pop3c_init_done</a> = 0x01;                         <span class="comment">/* We are initialized now       */</span>
00183 
00184 }
<a name="l00194"></a><a class="code" href="pop3__client_8c.html#a4">00194</a> UINT8 <a class="code" href="pop3__client_8c.html#a33">pop3c_getstate</a> (<span class="keywordtype">void</span>){
00195         <span class="keywordflow">return</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a>);
00196         
00197 }
00198 
00199 <span class="comment">/********************************************************************************</span>
00200 <span class="comment">Function:               pop3c_eventlistener</span>
00201 <span class="comment"></span>
00202 <span class="comment">Parameters:             INT8 cbhandle - handle to TCP socket where event is coming from </span>
00203 <span class="comment">                                UINT8 event - type of event</span>
00204 <span class="comment">                                UINT32 par1 - parameter the meaning of depends on event</span>
00205 <span class="comment">                                UINT32 par2 - parameter the meaning of depends on event</span>
00206 <span class="comment">                                </span>
00207 <span class="comment">Return val:             INT32 - depends on event but usually (-1) is error of some</span>
00208 <span class="comment">                                                kind and positive reply means OK</span>
00209 <span class="comment">                                </span>
00210 <span class="comment">Date:                   21.8.2002</span>
00211 <span class="comment"></span>
00212 <span class="comment">Desc:                   This function is given to TCP socket as function pointer to be</span>
00213 <span class="comment">                                used by TCP engine to make callbacks to inform about events</span>
00214 <span class="comment">                                on TCP e.g. arriving data. Main functionality of this function </span>
00215 <span class="comment">                                is to parse data from TCP to detect POP3 server reply commands,</span>
00216 <span class="comment">                                handling out retransmissions and making state changes</span>
00217 <span class="comment">*********************************************************************************/</span>
00218 
00219 
00220 INT32 pop3c_eventlistener (INT8 cbhandle, UINT8 event, UINT32 par1, UINT32 par2)
00221 {
00222         <span class="comment">/* This function is called by TCP stack to inform about events  */</span>
00223         
00224         UINT8 cmd;
00225         UINT16 i;
00226         <span class="keyword">static</span> UINT16 len;
00227         <span class="keyword">static</span> UINT16 match;
00228         <span class="keyword">static</span> UINT8  end_detect;
00229         UINT8 ch;
00230         UINT8 j;
00231         UINT8 endbuf[4];
00232                 
00233         
00234         <span class="keywordflow">if</span>( cbhandle != pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>)          <span class="comment">/* Not our handle       */</span>
00235                 <span class="keywordflow">return</span>(-1);
00236         
00237         <span class="keywordflow">switch</span>( event ) {
00238         
00239                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a54">TCP_EVENT_CONREQ</a>:
00240                 
00241                         <span class="comment">/* We don't allow incoming connections  */</span>
00242                         
00243                         <span class="keywordflow">return</span>(-1);
00244         
00245                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>:
00246                 
00247                         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> &gt; <a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>) {
00248                                 <span class="comment">/* Inform application   */</span>      
00249                                 <a class="code" href="pop3c__callbacks_8c.html#a47">pop3c_error</a>();  
00250                         }
00251                 
00252                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>);
00253                         pop3_client.<a class="code" href="structpop3c__struct.html#m5">unacked</a> = 0;
00254                         
00255                         <span class="keywordflow">return</span>(1);
00256                 
00257                         <span class="keywordflow">break</span>;
00258                 
00259                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a55">TCP_EVENT_CONNECTED</a>:
00260                 
00261                         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a6">POP3C_CONNECTIONOPEN_SENT</a>) {
00262                                 DEBUGOUT(<span class="stringliteral">"POP3 TCP connection opened\r\n"</span>);
00263                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a7">POP3C_CONNECTION_OPENED</a>);
00264                                 pop3_client.<a class="code" href="structpop3c__struct.html#m5">unacked</a> = 0;
00265                                 <span class="keywordflow">return</span>(-1);
00266                         }
00267                                 
00268                         <span class="keywordflow">break</span>;
00269                         
00270                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a56">TCP_EVENT_CLOSE</a>:
00271                 
00272                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>);
00273                         pop3_client.<a class="code" href="structpop3c__struct.html#m5">unacked</a> = 0;
00274                         <span class="keywordflow">return</span>(1);
00275                 
00276                         <span class="keywordflow">break</span>;
00277                         
00278                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a58">TCP_EVENT_ACK</a>:
00279                 
00280                         <span class="comment">/* Our message is acked */</span>
00281                         
00282                         pop3_client.<a class="code" href="structpop3c__struct.html#m5">unacked</a> = 0;
00283                         
00284                         <span class="keywordflow">break</span>;
00285                         
00286                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a60">TCP_EVENT_DATA</a>:
00287                 
00288                         <span class="comment">/* Do we have unacked data?     */</span>
00289                         
00290                         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m5">unacked</a>)
00291                                 <span class="keywordflow">return</span>(-1);
00292                 
00293                         <span class="comment">/* Get reply from server        */</span>
00294                         
00295                         <span class="keywordflow">if</span>(par1 &lt; 3)                                    <span class="comment">/* Long enough? */</span>
00296                                 <span class="keywordflow">return</span>(-1);
00297                 
00298                         <span class="comment">/* Get command                          */</span>
00299                         
00300                         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_tcp_packet.buf_index);
00301                         cmd = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00302                         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_tcp_packet.buf_index);
00303 
00304                         <span class="keywordflow">switch</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a>) {
00305                                 
00306                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a7">POP3C_CONNECTION_OPENED</a>:
00307                                 
00308                                         <span class="keywordflow">if</span>(cmd == POP3C_OK)     {
00309                                                 DEBUGOUT(<span class="stringliteral">"POP3 Server is ready\r\n"</span>);
00310                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a8">POP3C_SERVER_READY</a>);
00311                                                 <span class="keywordflow">return</span>(1);
00312                                         }
00313                                         
00314                                         <span class="keywordflow">break</span>;
00315                                 
00316                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a9">POP3C_USERNAME_SENT</a>:
00317                                 
00318                                         <span class="keywordflow">if</span>(cmd == POP3C_OK)     {       
00319                                                 DEBUGOUT(<span class="stringliteral">"USER +OK by POP3 server\r\n"</span>);
00320                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a10">POP3C_USERNAME_ACKED</a>);
00321                                                 <span class="keywordflow">return</span>(1);
00322                                         }
00323                                         
00324                                         <span class="keywordflow">break</span>;                          
00325                                         
00326                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a11">POP3C_PASSWORD_SENT</a>:
00327                                 
00328                                         <span class="keywordflow">if</span>(cmd == POP3C_OK) {
00329                                                 DEBUGOUT(<span class="stringliteral">"PASS +OK by POP3 server\r\n"</span>);
00330                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a12">POP3C_PASSWORD_ACKED</a>);
00331                                                 <span class="keywordflow">return</span>(1);
00332                                         }
00333                                         
00334                                         <span class="keywordflow">break</span>;                  
00335                                         
00336                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a13">POP3C_STAT_SENT</a>: 
00337                                 
00338                                         <span class="keywordflow">if</span>(cmd == POP3C_OK)     {
00339                                                 DEBUGOUT(<span class="stringliteral">"STAT get from POP3 server\r\n"</span>);
00340                                                 
00341                                                 <span class="comment">/* Parse number of messages     */</span>
00342                                                 
00343                                                 <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_tcp_packet.buf_index);
00344                                                         
00345                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m6">msgtotal</a> = 0;
00346                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a> = 0;
00347                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> = 0;
00348                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a> = 0;
00349                                                 <span class="keywordflow">if</span>( pop3c_parsestat() &lt; 0 )     {
00350                                                         <span class="comment">/* Error parsing STAT reply     */</span>
00351                                                         <span class="comment">/* Inform application           */</span>      
00352                                                         <a class="code" href="pop3c__callbacks_8c.html#a47">pop3c_error</a>();                                                  
00353                                                         <a class="code" href="tcp_8c.html#a11">tcp_abort</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>);
00354                                                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>);
00355                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m5">unacked</a> = 0;                                                        
00356                                                         <span class="keywordflow">return</span>(1);
00357                                                 }
00358                                                 
00359                                                 <span class="comment">/* Inform application about the nmbr of messages        */</span>
00360                                                 <a class="code" href="pop3c__callbacks_8c.html#a1">pop3c_messages</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m6">msgtotal</a>);
00361                                                 
00362                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a14">POP3C_STAT_GET</a>);
00363                                                 <span class="keywordflow">return</span>(1);
00364                                         }
00365                                         
00366                                         <span class="keywordflow">break</span>;  
00367                                         
00368                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a15">POP3C_LIST_SENT</a>:
00369                                 
00370                                         <span class="keywordflow">if</span>(cmd == POP3C_OK)     {
00371                                                 DEBUGOUT(<span class="stringliteral">"LIST get from POP3 server\r\n"</span>);
00372                                                 
00373                                                 <span class="comment">/* Parse message total len      */</span>
00374                                                 
00375                                                 <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_tcp_packet.buf_index);      
00376                                                 
00377                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> = 0;
00378                                                 
00379                                                 <span class="keywordflow">if</span>(pop3c_parselist() &lt; 0) {
00380                                                         <span class="comment">/* Error parsing LIST reply     */</span>
00381                                                         <span class="comment">/* Inform application           */</span>      
00382                                                         <a class="code" href="pop3c__callbacks_8c.html#a47">pop3c_error</a>();                                                  
00383                                                         <a class="code" href="tcp_8c.html#a11">tcp_abort</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>);
00384                                                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>);
00385                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m5">unacked</a> = 0;                                                        
00386                                                         <span class="keywordflow">return</span>(1);                                              
00387                                                 
00388                                                 }
00389                                                 
00390                                                 
00391                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a16">POP3C_LIST_GET</a>);
00392                                                 <span class="keywordflow">return</span>(1);
00393                                         }
00394                                         
00395                                         <span class="keywordflow">break</span>;                                                                          
00396                                 
00397                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a17">POP3C_TOP0_SENT</a>:
00398                                 
00399                                         <span class="keywordflow">if</span>(cmd == POP3C_OK) {
00400                                                 DEBUGOUT(<span class="stringliteral">"TOP x 0 get from POP3 server\r\n"</span>);
00401                                                 
00402                                                 <span class="comment">/* Continue imediately to receive header        */</span>
00403                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a> = 0;
00404                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m12">from</a>[0] = <span class="charliteral">'\0'</span>;
00405                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m13">subject</a>[0] = <span class="charliteral">'\0'</span>;
00406                                                 match = 0;
00407                                                 
00408                                                 <span class="comment">/* Receive untill LF found      */</span>
00409                                         
00410                                                 <span class="keywordflow">for</span>(i=0; i&lt;(UINT16)par1; i++)
00411                                                 {
00412                                                         ch = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00413                                                 
00414                                                         <span class="keywordflow">if</span>(ch == <span class="charliteral">'\n'</span>)
00415                                                         {       i++;
00416                                                                 <span class="keywordflow">break</span>;
00417                                                         }
00418                                                 }
00419                                 
00420                                                 par1 = i;                                               
00421                                                 
00422                                                 
00423                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>);      
00424                                         }<span class="keywordflow">else</span>
00425                                                 <span class="keywordflow">break</span>;
00426                                         
00427                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>:
00428                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a19">POP3C_RECEIVING_HDR_FROM</a>:
00429                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a20">POP3C_RECEIVING_HDR_SUBJ</a>:
00430                                 
00431                                         pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a> += (UINT16)par1;
00432                                         
00433                                         <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a> &gt; (pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> + 100) ) {
00434                                                 <span class="comment">/* Somebody tries to fool us    */</span>
00435                                                 <span class="comment">/* Move to next msg                             */</span>
00436                                                 
00437                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a25">POP3C_MESSAGE_RECEIVED</a>);
00438                                                 <span class="keywordflow">break</span>;  
00439                                                 
00440                                         }
00441                                         
00442                                         <span class="comment">/* We try to find 'from:', or 'subject:'        */</span>
00443                                         
00444                                         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_tcp_packet.buf_index);
00445                                         
00446                                         <span class="keywordflow">for</span>( i=0; i&lt;(UINT16)par1; i++) {
00447                                                 
00448                                                 ch = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00449                                                 
00450                                                 <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>) {
00451                                                 
00452                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">'\r'</span>) {
00453                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00454                                                                 <span class="keywordflow">continue</span>;
00455                                                         }
00456                                                 
00457                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">'\n'</span>) {
00458                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00459                                                                 <span class="keywordflow">continue</span>;
00460                                                         }
00461                                                 
00462                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">' '</span>)          <span class="comment">/* Remove spaces        */</span>
00463                                                                 <span class="keywordflow">continue</span>;
00464                                         
00465                                                         <span class="comment">/* Buffer already full for this line?   */</span>
00466                                         
00467                                                         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> &gt; 8)
00468                                                                 <span class="keywordflow">continue</span>;
00469                                         
00470                                                         <span class="comment">/* End of header? (parsing of that is not absolutely correct)   */</span>
00471                                                         <span class="comment">/* We detect it from CRLF. or LFCR. or CR. or LF.                               */</span>
00472                                                         <span class="comment">/* the correct indication being CRLF.CRLF                                               */</span>
00473                                                         
00474                                                         <span class="keywordflow">if</span>( (ch == <span class="charliteral">'.'</span>) &amp;&amp; (pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> == 0) ) {
00475                                                                 <span class="comment">/* Remove CRLF.CRLF from header length  */</span>
00476                                                                 
00477                                                                 <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a> &gt;= 5 )
00478                                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a> -= 5;
00479                                                                 
00480                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a21">POP3C_TOP0_GET</a>);
00481                                                                 <span class="keywordflow">break</span>;
00482                                                         }
00483                                         
00484                                         
00485                                                         ch = tolower(ch);
00486                                                 
00487                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m10">headerbuf</a>[pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>] = ch;
00488                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>++;
00489                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m10">headerbuf</a>[pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>] = <span class="charliteral">'\0'</span>;
00490                                                 
00491                                                         <span class="comment">/* Is it 'from:' ?      */</span>
00492                                                 
00493                                                         <span class="keywordflow">if</span>(bufsearch(&amp;pop3_client.<a class="code" href="structpop3c__struct.html#m10">headerbuf</a>[0],pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>,<span class="stringliteral">"from:"</span>) == 0) {
00494                                                                 <span class="comment">/* Continue imidiately to read sender   */</span>
00495                                                         
00496                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m12">from</a>[0] = <span class="charliteral">'\0'</span>;
00497                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00498                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a19">POP3C_RECEIVING_HDR_FROM</a>);    
00499                                                                 <span class="keywordflow">continue</span>;
00500                                                         }
00501                                                 
00502                                                         <span class="comment">/* Is it 'subject:' ?   */</span>
00503                                                 
00504                                                         <span class="keywordflow">if</span>(bufsearch(&amp;pop3_client.<a class="code" href="structpop3c__struct.html#m10">headerbuf</a>[0],pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>,<span class="stringliteral">"subject:"</span>) == 0) {
00505                                                                 <span class="comment">/* Continue imidiately to read subject  */</span>
00506                                                                         
00507                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m13">subject</a>[0] = <span class="charliteral">'\0'</span>;
00508                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00509                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a20">POP3C_RECEIVING_HDR_SUBJ</a>);    
00510                                                                 <span class="keywordflow">continue</span>;
00511                                                         }
00512                                                 
00513                                                 }       <span class="comment">/* of RECEIVING_HEADER  */</span>
00514                                                 
00515                                                 
00516                                                 <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a19">POP3C_RECEIVING_HDR_FROM</a>) {
00517                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">' '</span>){         <span class="comment">/* Remove spaces        */</span>
00518                                                                 <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> == 0)
00519                                                                         <span class="keywordflow">continue</span>;
00520                                                         }
00521                                                         
00522                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">'\r'</span>) {
00523                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00524                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>);
00525                                                                 <span class="keywordflow">continue</span>;
00526                                                         }
00527                                                         
00528                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">'\n'</span>) {
00529                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00530                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>);
00531                                                                 <span class="keywordflow">continue</span>;
00532                                                         }
00533                                                         
00534                                                         <span class="comment">/* Store it     */</span>
00535                                                         
00536                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m12">from</a>[pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>] = ch;
00537                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>++;
00538                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m12">from</a>[pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>] = <span class="charliteral">'\0'</span>;
00539                                                         
00540                                                         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> &gt;= <a class="code" href="pop3__client_8h.html#a0">POP3C_SENDERMAXLEN</a>) {
00541                                                                 <span class="comment">/* The buffer is exeeded        */</span>
00542                                                                 <span class="comment">/* Mark it corrupted            */</span>
00543                                                                 
00544                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m12">from</a>[0] = <span class="charliteral">'\0'</span>;
00545                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>);
00546                                                                 <span class="keywordflow">continue</span>;
00547                                                         }       
00548                                                                                                 
00549                                                 }       <span class="comment">/* of RECEIVING_HDR_FROM        */</span>
00550                                                 
00551                                                 
00552                                                 <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a20">POP3C_RECEIVING_HDR_SUBJ</a>) {
00553                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">' '</span>){         <span class="comment">/* Remove spaces        */</span>
00554                                                                 <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> == 0)
00555                                                                         <span class="keywordflow">continue</span>;
00556                                                         }
00557                                                         
00558                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">'\r'</span>) {
00559                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00560                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>);
00561                                                                 <span class="keywordflow">continue</span>;
00562                                                         }
00563                                                         
00564                                                         <span class="keywordflow">if</span>( ch == <span class="charliteral">'\n'</span>) {
00565                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> = 0;
00566                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>);
00567                                                                 <span class="keywordflow">continue</span>;
00568                                                         }
00569                                                         
00570                                                         <span class="comment">/* Store it     */</span>
00571                                                         
00572                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m13">subject</a>[pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>] = ch;
00573                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>++;
00574                                                         pop3_client.<a class="code" href="structpop3c__struct.html#m13">subject</a>[pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a>] = <span class="charliteral">'\0'</span>;
00575                                                         
00576                                                         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m11">charsinheaderbuf</a> &gt;= <a class="code" href="pop3__client_8h.html#a1">POP3C_SUBJECTMAXLEN</a>) {
00577                                                                 <span class="comment">/* The buffer is exeeded        */</span>
00578                                                                 <span class="comment">/* Mark it corrupted            */</span>
00579                                                                 
00580                                                                 pop3_client.<a class="code" href="structpop3c__struct.html#m13">subject</a>[0] = <span class="charliteral">'\0'</span>;
00581                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a18">POP3C_RECEIVING_HEADER</a>);
00582                                                                 <span class="keywordflow">continue</span>;
00583                                                         }       
00584                                                                                                 
00585                                                 }       <span class="comment">/* of RECEIVING_HDR_SUBJ        */</span>                                              
00586                                                 
00587                                         
00588                                         }
00589                                         
00590 
00591                                         <span class="keywordflow">break</span>;
00592                                                                                         
00593                                         
00594                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a22">POP3C_RETR_SENT</a>:
00595                                 
00596                                         <span class="keywordflow">if</span>(cmd == POP3C_OK)     {
00597                                                 DEBUGOUT(<span class="stringliteral">"RETR +OK by POP3 server\r\n"</span>);
00598                                                 
00599                                                 <span class="comment">/* Continue imidiately to receive message       */</span>
00600                                                 
00601                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a23">POP3C_RECEIVING_MSG_HEADER</a>);
00602                                         
00603                                         } <span class="keywordflow">else</span>
00604                                                 <span class="keywordflow">break</span>;
00605                                                 
00606                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a23">POP3C_RECEIVING_MSG_HEADER</a>:        
00607                                 
00608                                         <span class="comment">/* Try to find empty row to detect the start of actual message  */</span>
00609                                         
00610                                         match = 0;
00611                                         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_tcp_packet.buf_index);
00612                                         
00613                                         <span class="keywordflow">for</span>(i=0; i &lt; (UINT16)par1; i++) {                                       
00614                                                 ch = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00615                                                 
00616                                                 <span class="keywordflow">if</span>(match == 0)  {
00617                                                         <span class="keywordflow">if</span>( (ch == <span class="charliteral">'\r'</span>) || (ch == <span class="charliteral">'\n'</span>) )
00618                                                                 match++;
00619                                                         <span class="keywordflow">else</span>
00620                                                                 match = 0;
00621                                                         <span class="keywordflow">continue</span>;       
00622                                                 }
00623 
00624                                                 <span class="keywordflow">if</span>(match == 1) {
00625                                                         <span class="keywordflow">if</span>( (ch == <span class="charliteral">'\r'</span>) || (ch == <span class="charliteral">'\n'</span>))
00626                                                                 match++;
00627                                                         <span class="keywordflow">else</span>
00628                                                                 match = 0;
00629                                                         <span class="keywordflow">continue</span>;       
00630                                                 }                                               
00631                                                 
00632                                                 <span class="keywordflow">if</span>(match == 2) {
00633                                                         <span class="keywordflow">if</span>( (ch == <span class="charliteral">'\r'</span>) || (ch == <span class="charliteral">'\n'</span>))
00634                                                                 match++;
00635                                                         <span class="keywordflow">else</span>
00636                                                                 match = 0;
00637                                                         <span class="keywordflow">continue</span>;       
00638                                                 }                       
00639                                                 
00640                                                 <span class="keywordflow">if</span>(match == 3) {
00641                                                         <span class="keywordflow">if</span>( (ch == <span class="charliteral">'\r'</span>) || (ch == <span class="charliteral">'\n'</span>)) {
00642                                                                 match++;
00643                                                                 
00644                                                                 <span class="comment">/* Continue to read the actual msg      */</span>
00645                                                                 par1 -= (i + 1);
00646                                                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a24">POP3C_RECEIVING_MSG</a>);
00647                                                                 <span class="keywordflow">break</span>;
00648                                                         } <span class="keywordflow">else</span>
00649                                                                 match = 0;
00650                                                         <span class="keywordflow">continue</span>;       
00651                                                 }                                               
00652                                                                         
00653                                         }
00654                                         
00655                                         <span class="comment">/* If we don't find the end of header we will timeout   */</span>
00656                                         <span class="comment">/* on pop3c_run so no error handling here                               */</span>
00657                                 
00658                                         <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> != <a class="code" href="pop3__client_8h.html#a24">POP3C_RECEIVING_MSG</a>)
00659                                                 <span class="keywordflow">break</span>;
00660                                         
00661                                         end_detect = 0; 
00662                                         <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a24">POP3C_RECEIVING_MSG</a>:
00663                                         
00664                                                 <span class="comment">/* Search is this packet end of msg and do not give     */</span>
00665                                                 <span class="comment">/* CRLF.CRLF to application                                                     */</span>
00666                                                 <span class="keywordflow">for</span>(i=0; i &lt; (UINT16)par1; i++) {
00667                                                         ch = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00668                                                         
00669                                                         <a class="code" href="pop3c__callbacks_8c.html#a6">pop3c_data</a>(ch);
00670                                                         
00671                                                         <span class="keywordflow">if</span>( (ch == <span class="charliteral">'\r'</span>) &amp;&amp; (end_detect != 3))
00672                                                                 end_detect = 0;
00673                                                         
00674                                                         
00675                                                         <span class="keywordflow">if</span>( end_detect == 0 ) {
00676                                                                 <span class="keywordflow">if</span>(ch == <span class="charliteral">'\r'</span>)
00677                                                                         end_detect++;
00678                                                                 <span class="keywordflow">else</span>
00679                                                                         end_detect = 0;
00680                                                                 
00681                                                                 <span class="keywordflow">continue</span>;
00682                                                         }
00683                                                         
00684                                                         <span class="keywordflow">if</span>( end_detect == 1 ){
00685                                                                 <span class="keywordflow">if</span>(ch == <span class="charliteral">'\n'</span>)
00686                                                                         end_detect++;
00687                                                                 <span class="keywordflow">else</span>
00688                                                                         end_detect = 0;
00689                                                                 
00690                                                                 <span class="keywordflow">continue</span>;
00691                                                         }                                                       
00692                                                         
00693                                                         <span class="keywordflow">if</span>( end_detect == 2 ){
00694                                                                 <span class="keywordflow">if</span>(ch == <span class="charliteral">'.'</span>)
00695                                                                         end_detect++;
00696                                                                 <span class="keywordflow">else</span>
00697                                                                         end_detect = 0;
00698                                                                 
00699                                                                 <span class="keywordflow">continue</span>;
00700                                                         }       
00701                                                         
00702                                                         <span class="keywordflow">if</span>( end_detect == 3 ){
00703                                                                 <span class="keywordflow">if</span>(ch == <span class="charliteral">'\r'</span>)
00704                                                                         end_detect++;
00705                                                                 <span class="keywordflow">else</span>
00706                                                                         end_detect = 0;
00707                                                                 
00708                                                                 <span class="keywordflow">continue</span>;
00709                                                         }                                                                                                       
00710                                                         
00711                                                         <span class="keywordflow">if</span>( end_detect == 4 ){  
00712                                                                 <span class="keywordflow">if</span>(ch == <span class="charliteral">'\n'</span>) {                                                                                                        
00713                                                                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a25">POP3C_MESSAGE_RECEIVED</a>);
00714                                                                         <span class="keywordflow">return</span>(1);
00715                                                                 }
00716                                                                 <span class="keywordflow">else</span>
00717                                                                         end_detect = 0;
00718                                                                 
00719                                                                 <span class="keywordflow">continue</span>;
00720                                                         }
00721                                                 
00722                                                 }
00723                                                 
00724                                                 <span class="keywordflow">break</span>;
00725                                                 
00726                                         <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a26">POP3C_DELE_SENT</a>:
00727                                         
00728                                                 <span class="keywordflow">if</span>(cmd == POP3C_OK)     {
00729                                                         DEBUGOUT(<span class="stringliteral">"DELE +OK by POP3 server\r\n"</span>);
00730                                                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a27">POP3C_DELE_ACKED</a>);
00731                                                         <span class="keywordflow">return</span>(1);
00732                                                 }
00733                                         
00734                                                 <span class="keywordflow">break</span>;  
00735                                                 
00736                                         <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a28">POP3C_QUIT_SENT</a>:
00737                                         
00738                                                 <span class="keywordflow">if</span>(cmd == POP3C_OK)     {
00739                                                         DEBUGOUT(<span class="stringliteral">"QUIT +OK by POP3 server\r\n"</span>);
00740                                                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a29">POP3C_QUIT_ACKED</a>);
00741                                                         <span class="keywordflow">return</span>(1);
00742                                                 }
00743                                         
00744                                                 <span class="keywordflow">break</span>;                                                                          
00745                                         
00746                                                 
00747                                 <span class="keywordflow">default</span>:
00748                                         <span class="keywordflow">break</span>;
00749 
00750                         
00751                         }
00752 
00753                 
00754                         <span class="keywordflow">return</span>(1);
00755                 
00756                         
00757                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a59">TCP_EVENT_REGENERATE</a>:
00758                 
00759                         <span class="comment">/* Send last packet again       */</span>
00760                 
00761                         DEBUGOUT(<span class="stringliteral">"POP3C is regenerating...\r\n"</span>);
00762                 
00763                         <span class="keywordflow">switch</span> (pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a>) {
00764                         
00765                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a9">POP3C_USERNAME_SENT</a>:
00766                                         pop3c_senduser();
00767                                         <span class="keywordflow">return</span>(1);
00768                                 
00769                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a11">POP3C_PASSWORD_SENT</a>:
00770                                         pop3c_sendpassword();
00771                                         <span class="keywordflow">return</span>(1);
00772                                         
00773                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a13">POP3C_STAT_SENT</a>:
00774                                         pop3c_sendstat();
00775                                         <span class="keywordflow">return</span>(1);
00776                                 
00777                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a15">POP3C_LIST_SENT</a>:
00778                                         pop3c_sendlist(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00779                                         <span class="keywordflow">return</span>(1);
00780                                 
00781                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a17">POP3C_TOP0_SENT</a>:
00782                                         pop3c_sendtop(0);
00783                                         <span class="keywordflow">return</span>(1);      
00784                                 
00785                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a22">POP3C_RETR_SENT</a>:
00786                                         pop3c_sendretr(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00787                                         <span class="keywordflow">return</span>(1);
00788                                 
00789                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a26">POP3C_DELE_SENT</a>:   
00790                                         pop3c_senddele(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00791                                         <span class="keywordflow">return</span>(1);
00792                                 
00793                                 <span class="keywordflow">case</span> <a class="code" href="pop3__client_8h.html#a28">POP3C_QUIT_SENT</a>:
00794                                         pop3c_sendquit();
00795                                         <span class="keywordflow">return</span>(1);
00796                                         
00797                                 <span class="keywordflow">default</span>:
00798                                         <span class="keywordflow">return</span>(-1);
00799                         }
00800                 
00801                 
00802                         <span class="keywordflow">break</span>;
00803         
00804         
00805                 <span class="keywordflow">default</span>:
00806                         <span class="keywordflow">return</span>(-1);
00807         }       
00808 
00809         <span class="keywordflow">return</span>(-1);
00810 
00811 }
00812 
00813 
00814 <span class="comment">/********************************************************************************</span>
00815 <span class="comment">Function:               pop3c_run</span>
00816 <span class="comment"></span>
00817 <span class="comment">Parameters:             void            </span>
00818 <span class="comment">                                </span>
00819 <span class="comment">Return val:             void</span>
00820 <span class="comment">                                </span>
00821 <span class="comment">Date:                   11.9.2002</span>
00822 <span class="comment"></span>
00823 <span class="comment">Desc:                   This function should be called periodically from main loop</span>
00824 <span class="comment">                                in order to run pop3 client 'thread'.</span>
00825 <span class="comment">*********************************************************************************/</span>
00826 
00827 <span class="keywordtype">void</span> pop3c_run (<span class="keywordtype">void</span>)
00828 {
00829         INT16 i;
00830 
00831         <span class="comment">/* On that function we can send data when called by main loop   */</span>
00832         
00833         <span class="keywordflow">if</span>( <a class="code" href="pop3__client_8c.html#a0">pop3c_init_done</a> == 0 )
00834                 <span class="keywordflow">return</span>;
00835         
00836         <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> &lt; <a class="code" href="pop3__client_8h.html#a5">POP3C_OPEN_REQUESTED</a>)
00837                 <span class="keywordflow">return</span>;
00838                 
00839         <span class="comment">/* Is there timeout of some sort?       */</span>
00840                 
00841         <span class="keywordflow">if</span>(<a class="code" href="timers_8c.html#a7">check_timer</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m4">tmrhandle</a>) == 0) {
00842                 <span class="comment">/* Yep  */</span>
00843                 <a class="code" href="tcp_8c.html#a11">tcp_abort</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>);
00844                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>);
00845                         
00846                 <span class="comment">/* Make user callback   */</span>
00847                 <a class="code" href="pop3c__callbacks_8c.html#a47">pop3c_error</a>();
00848                 <span class="keywordflow">return</span>;
00849                 
00850         }
00851         
00852         <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a5">POP3C_OPEN_REQUESTED</a>) {
00853                 <span class="comment">/* We are on this state because user has requested connection   */</span>
00854                 <span class="comment">/* but connection is not yet opened.                                                    */</span>
00855                 <span class="comment">/* Try to get TCP stack to accept our connection request                */</span>
00856                 
00857                 <a class="code" href="tcp_8c.html#a11">tcp_abort</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>);               <span class="comment">/* Release old connection       */</span>
00858                 <span class="keywordflow">if</span>(<a class="code" href="tcp_8c.html#a6">tcp_connect</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, pop3_client.<a class="code" href="structpop3c__struct.html#m1">remip</a>, pop3_client.<a class="code" href="structpop3c__struct.html#m2">remport</a>, 0) &gt;= 0)
00859                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a6">POP3C_CONNECTIONOPEN_SENT</a>);
00860                 
00861                 <span class="keywordflow">return</span>;
00862         }
00863         
00864         <span class="keywordflow">if</span>( <a class="code" href="tcp_8c.html#a9">tcp_getstate</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>) != <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a> ) {
00865                 <span class="keywordflow">return</span>;
00866         }       
00867         
00868         <span class="keywordflow">if</span>( <a class="code" href="tcp_8c.html#a10">tcp_checksend</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>) &lt; 0 )
00869                 <span class="keywordflow">return</span>;
00870         
00871         <span class="comment">/* It's connected and no unacked data so try to send    */</span>      
00872         
00873         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a8">POP3C_SERVER_READY</a>) {
00874                 <span class="comment">/* Send USER    */</span>
00875                 pop3c_senduser();
00876                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a9">POP3C_USERNAME_SENT</a>);
00877                 DEBUGOUT(<span class="stringliteral">"POP3C USER packet sent\r\n"</span>);
00878                 <span class="keywordflow">return</span>;
00879         }       
00880         
00881         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a10">POP3C_USERNAME_ACKED</a>) {
00882                 <span class="comment">/* Send PASS    */</span>
00883                 pop3c_sendpassword();
00884                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a11">POP3C_PASSWORD_SENT</a>);
00885                 DEBUGOUT(<span class="stringliteral">"POP3C PASS packet sent\r\n"</span>);
00886                 <span class="keywordflow">return</span>;
00887         }       
00888         
00889         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a12">POP3C_PASSWORD_ACKED</a>) {
00890                 <span class="comment">/* Send STAT    */</span>
00891                 pop3c_sendstat();
00892                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a13">POP3C_STAT_SENT</a>);
00893                 DEBUGOUT(<span class="stringliteral">"POP3C STAT packet sent\r\n"</span>);
00894                 <span class="keywordflow">return</span>;
00895         }
00896         
00897         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a14">POP3C_STAT_GET</a>) {
00898                 <span class="comment">/* Still messages?              */</span>
00899                 <span class="keywordflow">if</span>( pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a> &lt; pop3_client.<a class="code" href="structpop3c__struct.html#m6">msgtotal</a> ) {
00900                         pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>++;
00901                         pop3c_sendlist(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00902                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a15">POP3C_LIST_SENT</a>);
00903                         DEBUGOUT(<span class="stringliteral">"POP3C LIST packet sent\r\n"</span>);
00904                         <span class="keywordflow">return</span>;
00905                 }
00906                 
00907                 <span class="comment">/* End of messages      */</span>
00908                 
00909                 pop3c_sendquit();
00910                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a28">POP3C_QUIT_SENT</a>);
00911                 DEBUGOUT(<span class="stringliteral">"POP3C QUIT packet sent\r\n"</span>);
00912                 <span class="keywordflow">return</span>;         
00913                 
00914         }
00915         
00916         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a16">POP3C_LIST_GET</a>) {
00917                 <span class="comment">/* Now we have the whole length of current message. Receive body        */</span>
00918                 
00919                 pop3c_sendtop(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00920                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a17">POP3C_TOP0_SENT</a>);
00921                 DEBUGOUT(<span class="stringliteral">"POP3C TOP packet sent\r\n"</span>);
00922                 <span class="keywordflow">return</span>;
00923         }
00924         
00925         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a21">POP3C_TOP0_GET</a>) {
00926                 <span class="comment">/* Offer the e-mail to sender   */</span>
00927                 
00928                 <span class="keywordflow">if</span>((pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> + 100 )&gt; pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a>) {
00929                         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> &lt; pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a>)
00930                                 i = <a class="code" href="pop3c__callbacks_8c.html#a2">pop3c_msgoffer</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>, 0, &amp;pop3_client.<a class="code" href="structpop3c__struct.html#m12">from</a>[0], &amp;pop3_client.<a class="code" href="structpop3c__struct.html#m13">subject</a>[0]);
00931                         <span class="keywordflow">else</span>
00932                                 i = <a class="code" href="pop3c__callbacks_8c.html#a2">pop3c_msgoffer</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>, pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> - pop3_client.<a class="code" href="structpop3c__struct.html#m9">curmsghlen</a>, &amp;pop3_client.<a class="code" href="structpop3c__struct.html#m12">from</a>[0], &amp;pop3_client.<a class="code" href="structpop3c__struct.html#m13">subject</a>[0]);
00933                         
00934                         <span class="keywordflow">if</span>( i == (-2) ) {
00935                                 <span class="comment">/* User want's the mail to be deleted directly  */</span>
00936                                 
00937                                 pop3c_senddele(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00938                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a26">POP3C_DELE_SENT</a>);
00939                                 DEBUGOUT(<span class="stringliteral">"POP3C deleting the e-mail\r\n"</span>);
00940                                 <span class="keywordflow">return</span>;
00941                         }
00942                         
00943                         <span class="keywordflow">if</span>( i == (-1) ) {
00944                                 <span class="comment">/* User want's the mail to be left on server without reading it */</span>
00945                                 <span class="comment">/* So goto next one                                                                                             */</span>
00946                                 
00947                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a14">POP3C_STAT_GET</a>);
00948                                 <span class="keywordflow">return</span>;
00949                         }
00950                         
00951                         <span class="keywordflow">if</span>( i &gt;= 0 ) {
00952                                 <span class="comment">/* User wants to read and delete the mail normally      */</span>
00953                                 
00954                                 pop3c_sendretr(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00955                                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a22">POP3C_RETR_SENT</a>);
00956                                 DEBUGOUT(<span class="stringliteral">"POP3C reading the e-mail\r\n"</span>);
00957                                 <span class="keywordflow">return</span>; 
00958                         
00959                         }
00960                         
00961                         <span class="keywordflow">return</span>;         
00962                 }
00963                 
00964                 <span class="comment">/* The mail is somehow corrupted, just delete it        */</span>
00965                 
00966                 pop3c_senddele(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00967                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a26">POP3C_DELE_SENT</a>);
00968                 DEBUGOUT(<span class="stringliteral">"POP3C deleting CORRUPTED e-mail\r\n"</span>);
00969                 <span class="keywordflow">return</span>;
00970                 
00971         
00972         }
00973         
00974         
00975         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a25">POP3C_MESSAGE_RECEIVED</a>) {
00976                 <span class="comment">/* Delete the readed message    */</span>
00977                 
00978                 pop3c_senddele(pop3_client.<a class="code" href="structpop3c__struct.html#m7">curmsgindex</a>);
00979                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a26">POP3C_DELE_SENT</a>);
00980                 DEBUGOUT(<span class="stringliteral">"POP3C deleting readed e-mail\r\n"</span>);
00981                 <span class="keywordflow">return</span>;
00982         }
00983         
00984         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a27">POP3C_DELE_ACKED</a>) {
00985                 <span class="comment">/* Goto next one        */</span>
00986                 pop3c_changestate(<a class="code" href="pop3__client_8h.html#a14">POP3C_STAT_GET</a>);
00987                 <span class="keywordflow">return</span>;
00988         }
00989         
00990         <span class="keywordflow">if</span>(pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> == <a class="code" href="pop3__client_8h.html#a29">POP3C_QUIT_ACKED</a>) {     
00991         
00992                 <span class="comment">/* Try to close TCP     */</span>
00993                 
00994                 <span class="keywordflow">if</span>(<a class="code" href="tcp_8c.html#a8">tcp_close</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>) &gt;= 0) {
00995                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>);
00996                         <a class="code" href="pop3c__callbacks_8c.html#a49">pop3c_allok</a>();
00997                         DEBUGOUT(<span class="stringliteral">"POP3C connection closed OK\r\n"</span>);
00998                         <span class="keywordflow">return</span>;
00999                 }
01000                 
01001                 <span class="comment">/* Close is not accepted by TCP. See if timeout */</span>
01002                 
01003                 <span class="keywordflow">if</span>(<a class="code" href="timers_8c.html#a7">check_timer</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m4">tmrhandle</a>) == 0) {
01004                         <span class="comment">/* Use brute force              */</span>
01005                         
01006                         <a class="code" href="tcp_8c.html#a11">tcp_abort</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>);
01007                         pop3c_changestate(<a class="code" href="pop3__client_8h.html#a4">POP3C_CLOSED</a>);
01008                         <a class="code" href="pop3c__callbacks_8c.html#a49">pop3c_allok</a>();
01009                         DEBUGOUT(<span class="stringliteral">"POP3C connection closed by ABORT\r\n"</span>);
01010                         <span class="keywordflow">return</span>;
01011                 }
01012                 
01013                 <span class="comment">/* Keep trying untill timeout   */</span>
01014                 
01015                 <span class="keywordflow">return</span>; 
01016                 
01017         }
01018         
01019         <span class="keywordflow">return</span>;
01020         
01021 }
01022 
01023 
01024 
01025 
01026 <span class="keywordtype">void</span> pop3c_senduser (<span class="keywordtype">void</span>)
01027 {
01028         INT8 i;
01029         UINT8* buf;
01030 
01031         <span class="comment">/* Fill TCP Tx buffer with "USER " and use callback function    */</span>
01032         <span class="comment">/* pop3c_getusername in order to get the username                               */</span>
01033         <span class="comment">/* that combined "USER username" to POP3 server                                 */</span>
01034         
01035         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
01036         
01037         *buf++ = <span class="charliteral">'U'</span>;
01038         *buf++ = <span class="charliteral">'S'</span>;
01039         *buf++ = <span class="charliteral">'E'</span>;
01040         *buf++ = <span class="charliteral">'R'</span>;
01041         *buf++ = <span class="charliteral">' '</span>;   
01042         
01043         i = <a class="code" href="pop3c__callbacks_8c.html#a3">pop3c_getusername</a>(buf);
01044         
01045         <span class="keywordflow">if</span>(i &lt; 0)
01046                 <span class="keywordflow">return</span>;
01047                 
01048         buf += i;       
01049         
01050         <span class="comment">/* Insert &gt;CRLF */</span>
01051         
01052         *buf++ = <span class="charliteral">'\r'</span>;
01053         *buf = <span class="charliteral">'\n'</span>;
01054                 
01055 
01056         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 7);
01057 
01058 }
01059 
01060 
01061 
01062 <span class="keywordtype">void</span> pop3c_sendpassword (<span class="keywordtype">void</span>)
01063 {
01064         INT8 i;
01065         UINT8* buf;
01066 
01067         <span class="comment">/* Fill TCP Tx buffer with "PASS " and use callback function    */</span>
01068         <span class="comment">/* pop3c_getpassword in order to get the password                               */</span>
01069         <span class="comment">/* that combined "PASS password" to POP3 server                                 */</span>
01070         
01071         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
01072         
01073         *buf++ = <span class="charliteral">'P'</span>;
01074         *buf++ = <span class="charliteral">'A'</span>;
01075         *buf++ = <span class="charliteral">'S'</span>;
01076         *buf++ = <span class="charliteral">'S'</span>;
01077         *buf++ = <span class="charliteral">' '</span>;   
01078         
01079         i = <a class="code" href="pop3c__callbacks_8c.html#a4">pop3c_getpassword</a>(buf);
01080         
01081         <span class="keywordflow">if</span>(i &lt; 0)
01082                 <span class="keywordflow">return</span>;
01083                 
01084         buf += i;       
01085         
01086         <span class="comment">/* Insert &gt;CRLF */</span>
01087         
01088         *buf++ = <span class="charliteral">'\r'</span>;
01089         *buf = <span class="charliteral">'\n'</span>;
01090                 
01091 
01092         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 7);
01093 
01094 }
01095 
01096 
01097 
01098 <span class="keywordtype">void</span> pop3c_sendstat (<span class="keywordtype">void</span>)
01099 {
01100         UINT8* buf;
01101 
01102         <span class="comment">/* Fill TCP Tx buffer with "STAT\r\n" and send it to POP3 server        */</span>
01103         
01104         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
01105         
01106         *buf++ = <span class="charliteral">'S'</span>;
01107         *buf++ = <span class="charliteral">'T'</span>;
01108         *buf++ = <span class="charliteral">'A'</span>;
01109         *buf++ = <span class="charliteral">'T'</span>;
01110         *buf++ = <span class="charliteral">'\r'</span>;
01111         *buf = <span class="charliteral">'\n'</span>;
01112                 
01113 
01114         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, 6);
01115 
01116 }
01117 
01118 <span class="keywordtype">void</span> pop3c_sendlist (UINT16 msgnbr)
01119 {
01120         UINT8* buf;
01121         INT16 i;
01122 
01123         <span class="comment">/* Ask LIST of given message number in order to get the total len of it */</span>
01124         
01125         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
01126         
01127         *buf++ = <span class="charliteral">'L'</span>;
01128         *buf++ = <span class="charliteral">'I'</span>;
01129         *buf++ = <span class="charliteral">'S'</span>;
01130         *buf++ = <span class="charliteral">'T'</span>;
01131         *buf++ = <span class="charliteral">' '</span>;
01132         
01133         ltoa( (UINT32)msgnbr, buf);
01134         
01135         i = strlen(buf,40);
01136         
01137         <span class="keywordflow">if</span>(i&lt;0)
01138                 <span class="keywordflow">return</span>;
01139         
01140         buf += i;       
01141         
01142         *buf++ = <span class="charliteral">'\r'</span>;
01143         *buf = <span class="charliteral">'\n'</span>;
01144                 
01145 
01146         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 7);
01147 
01148 }
01149 
01150 
01151 <span class="keywordtype">void</span> pop3c_sendtop (UINT16 msgnbr)
01152 {
01153         UINT8* buf;
01154         INT16 i;
01155 
01156         <span class="comment">/* Ask TOP msgnbr 0 in order to get the header of msg   */</span>
01157         
01158         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
01159         
01160         *buf++ = <span class="charliteral">'T'</span>;
01161         *buf++ = <span class="charliteral">'O'</span>;
01162         *buf++ = <span class="charliteral">'P'</span>;
01163         *buf++ = <span class="charliteral">' '</span>;
01164         
01165         ltoa( (UINT32)msgnbr, buf);
01166         
01167         i = strlen(buf,40);
01168         
01169         <span class="keywordflow">if</span>(i&lt;0)
01170                 <span class="keywordflow">return</span>;
01171         
01172         buf += i;       
01173         
01174         *buf++ = <span class="charliteral">' '</span>;
01175         *buf++ = <span class="charliteral">'0'</span>;
01176         
01177         *buf++ = <span class="charliteral">'\r'</span>;
01178         *buf = <span class="charliteral">'\n'</span>;
01179                 
01180 
01181         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 8);
01182 
01183 }
01184 
01185 <span class="keywordtype">void</span> pop3c_sendretr (UINT16 msgnbr)
01186 {
01187         UINT8* buf;
01188         INT16 i;
01189 
01190         <span class="comment">/* Ask RETR of given message number in order to get the message */</span>
01191         
01192         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
01193         
01194         *buf++ = <span class="charliteral">'R'</span>;
01195         *buf++ = <span class="charliteral">'E'</span>;
01196         *buf++ = <span class="charliteral">'T'</span>;
01197         *buf++ = <span class="charliteral">'R'</span>;
01198         *buf++ = <span class="charliteral">' '</span>;
01199         
01200         ltoa( (UINT32)msgnbr, buf);
01201         
01202         i = strlen(buf,40);
01203         
01204         <span class="keywordflow">if</span>(i&lt;0)
01205                 <span class="keywordflow">return</span>;
01206         
01207         buf += i;       
01208         
01209         *buf++ = <span class="charliteral">'\r'</span>;
01210         *buf = <span class="charliteral">'\n'</span>;
01211                 
01212 
01213         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 7);
01214 
01215 }
01216 
01217 
01218 <span class="keywordtype">void</span> pop3c_senddele (UINT16 msgnbr)
01219 {
01220         UINT8* buf;
01221         INT16 i;
01222 
01223         <span class="comment">/* Ask DELE of given message number in order to delete it       */</span>
01224         
01225         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
01226         
01227         *buf++ = <span class="charliteral">'D'</span>;
01228         *buf++ = <span class="charliteral">'E'</span>;
01229         *buf++ = <span class="charliteral">'L'</span>;
01230         *buf++ = <span class="charliteral">'E'</span>;
01231         *buf++ = <span class="charliteral">' '</span>;
01232         
01233         ltoa( (UINT32)msgnbr, buf);
01234         
01235         i = strlen(buf,40);
01236         
01237         <span class="keywordflow">if</span>(i&lt;0)
01238                 <span class="keywordflow">return</span>;
01239         
01240         buf += i;       
01241         
01242         *buf++ = <span class="charliteral">'\r'</span>;
01243         *buf = <span class="charliteral">'\n'</span>;
01244                 
01245 
01246         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, i + 7);
01247 
01248 }
01249 
01250 
01251 
01252 <span class="keywordtype">void</span> pop3c_sendquit (<span class="keywordtype">void</span>)
01253 {
01254         UINT8* buf;
01255 
01256         <span class="comment">/* Fill TCP Tx buffer with "QUIT\r\n" and send it to POP3 server        */</span>
01257         
01258         buf = &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>];
01259         
01260         *buf++ = <span class="charliteral">'Q'</span>;
01261         *buf++ = <span class="charliteral">'U'</span>;
01262         *buf++ = <span class="charliteral">'I'</span>;
01263         *buf++ = <span class="charliteral">'T'</span>;
01264         *buf++ = <span class="charliteral">'\r'</span>;
01265         *buf = <span class="charliteral">'\n'</span>;
01266 
01267         <a class="code" href="tcp_8c.html#a7">tcp_send</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m3">sochandle</a>, &amp;net_buf[<a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>], <a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a> - <a class="code" href="tcp__ip_8h.html#a61">TCP_APP_OFFSET</a>, 6);
01268 
01269 }
01270 
01271 
01272 INT16 pop3c_parsestat (<span class="keywordtype">void</span>)
01273 {
01274         <span class="comment">/* Parse total number of messages       */</span>
01275         
01276         UINT8 i;
01277         UINT8 ch;
01278         
01279         <span class="keywordflow">if</span>( <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>() != <span class="charliteral">'+'</span>)
01280                 <span class="keywordflow">return</span>(-1);
01281         <span class="keywordflow">if</span>( tolower(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) != <span class="charliteral">'o'</span>)
01282                 <span class="keywordflow">return</span>(-1);     
01283         <span class="keywordflow">if</span>( tolower(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) != <span class="charliteral">'k'</span>)
01284                 <span class="keywordflow">return</span>(-1);     
01285         <span class="keywordflow">if</span>( <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>() != <span class="charliteral">' '</span>)
01286                 <span class="keywordflow">return</span>(-1);             
01287 
01288         pop3_client.<a class="code" href="structpop3c__struct.html#m6">msgtotal</a> = 0;
01289 
01290         <span class="keywordflow">for</span>(i=0; i&lt;5; i++) {
01291                 ch = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01292                 
01293                 <span class="keywordflow">if</span>(ch == <span class="charliteral">' '</span>)
01294                         <span class="keywordflow">return</span>(1);
01295                 
01296                 <span class="keywordflow">if</span>(     isnumeric(ch) == 0)
01297                         <span class="keywordflow">return</span>(-1);
01298                 
01299                 ch = asciitohex(ch);
01300                 
01301                 pop3_client.<a class="code" href="structpop3c__struct.html#m6">msgtotal</a> *= 10;
01302                 pop3_client.<a class="code" href="structpop3c__struct.html#m6">msgtotal</a> += ch;     
01303                                 
01304         }
01305         
01306         <span class="comment">/* If we get there the number of messages is too big    */</span>
01307         
01308         <span class="keywordflow">return</span>(-1);
01309         
01310 
01311 }
01312 
01313 INT16 pop3c_parselist (<span class="keywordtype">void</span>)
01314 {
01315         <span class="comment">/* Parse total length of current message        */</span>
01316 
01317         UINT8 i;
01318         UINT8 ch;
01319 
01320         <span class="keywordflow">if</span>( <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>() != <span class="charliteral">'+'</span>)
01321                 <span class="keywordflow">return</span>(-1);
01322         <span class="keywordflow">if</span>( tolower(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) != <span class="charliteral">'o'</span>)
01323                 <span class="keywordflow">return</span>(-1);     
01324         <span class="keywordflow">if</span>( tolower(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) != <span class="charliteral">'k'</span>)
01325                 <span class="keywordflow">return</span>(-1);     
01326         <span class="keywordflow">if</span>( <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>() != <span class="charliteral">' '</span>)
01327                 <span class="keywordflow">return</span>(-1);
01328         
01329         <span class="comment">/* Receive untill next space    */</span>
01330         
01331         <span class="keywordflow">for</span>(i=0; i&lt;5; i++) {
01332                 ch = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01333                 
01334                 <span class="keywordflow">if</span>( ch == <span class="charliteral">' '</span>)
01335                         <span class="keywordflow">break</span>;
01336         }       
01337 
01338         <span class="comment">/* Space not found?     */</span>
01339 
01340         <span class="keywordflow">if</span>( ch != <span class="charliteral">' '</span>)
01341                 <span class="keywordflow">return</span>(-1);
01342         
01343         pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> = 0;
01344                 
01345         <span class="keywordflow">for</span>(i=0; i&lt;9; i++) {
01346                 ch = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();       
01347                 
01348                 <span class="keywordflow">if</span>(ch == <span class="charliteral">'\r'</span>)
01349                         <span class="keywordflow">return</span>(1);
01350                 <span class="keywordflow">if</span>(ch == <span class="charliteral">'\n'</span>)
01351                         <span class="keywordflow">return</span>(1);      
01352                 
01353                 <span class="keywordflow">if</span>(     isnumeric(ch) == 0)
01354                         <span class="keywordflow">return</span>(-1);
01355                 
01356                 ch = asciitohex(ch);
01357                 
01358                 pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> *= 10;
01359                 pop3_client.<a class="code" href="structpop3c__struct.html#m8">curmsgtotlen</a> += ch;         
01360                 
01361         }       
01362         
01363         <span class="comment">/* If all OK we are NOT here    */</span>
01364         
01365         <span class="keywordflow">return</span>(-1);
01366 
01367 }
01368 
01369 
01370 
01371 
01372 
01373 <span class="keywordtype">void</span> pop3c_changestate (UINT8 nstate)
01374 {
01375         
01376         <a class="code" href="timers_8c.html#a6">init_timer</a>(pop3_client.<a class="code" href="structpop3c__struct.html#m4">tmrhandle</a>, <a class="code" href="pop3__client_8h.html#a2">POP3C_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
01377         pop3_client.<a class="code" href="structpop3c__struct.html#m0">state</a> = nstate;
01378 
01379 }
01380 
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:33:00 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
