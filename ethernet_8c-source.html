<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/ethernet.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/ethernet.c</h1><a href="ethernet_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright </span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright </span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the </span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if </span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola </span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself, </span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to </span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior </span>
00026 <span class="comment"> *written permission. For written permission, please contact </span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP", </span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written </span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED </span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE </span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR </span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE </span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, </span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series </span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to </span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see </span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00071 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00072 <span class="preprocessor">#include &lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00073 <span class="preprocessor">#include &lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00074 <span class="preprocessor">#include &lt;<a class="code" href="ethernet_8h.html">inet/ethernet.h</a>&gt;</span>
00075 
00076 
00077 <span class="preprocessor">#include &lt;<a class="code" href="config_8h.html">inet/arch/config.h</a>&gt;</span>
00078 
<a name="l00079"></a><a class="code" href="ethernet_8c.html#a0">00079</a> UINT8   <a class="code" href="ethernet_8c.html#a0">NE2000NextPktPtr</a>;                       
<a name="l00080"></a><a class="code" href="ethernet_8c.html#a1">00080</a> UINT8   <a class="code" href="ethernet_8c.html#a1">NE2000CurrPktPtr</a>;                       
<a name="l00082"></a><a class="code" href="ethernet_8c.html#a2">00082</a> UINT8   <a class="code" href="ethernet_8c.html#a2">EtherSleep</a> = 0; 
<a name="l00093"></a><a class="code" href="ethernet_8c.html#a3">00093</a> <span class="keyword">struct </span><a class="code" href="structethernet__frame.html">ethernet_frame</a> received_frame;
00094 
<a name="l00105"></a><a class="code" href="ethernet_8c.html#a4">00105</a> <span class="keyword">struct </span><a class="code" href="structethernet__frame.html">ethernet_frame</a> send_frame;
00106 
00107 
<a name="l00118"></a><a class="code" href="ethernet_8c.html#a5">00118</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a5">outNE2000</a> (UINT8 reg , UINT8 dat)
00119 {
00120 
00121         UINT8 temp = reg;
00122         
00123         <a class="code" href="config_8h.html#a4">DATADIR</a> = <a class="code" href="config_8h.html#a1">DDR_OUT</a>;                              <span class="comment">/* datapins = output */</span>
00124         <a class="code" href="config_8h.html#a3">DATABUS</a> = dat;                          <span class="comment">/* data to bus */</span>
00125         <a class="code" href="config_8h.html#a5">ADRBUS</a> =  (temp | 0x60);        <span class="comment">/* dont change R,W,Reset pins */</span>
00126         
00127         <span class="comment">/* Wait until bus free */</span>
00128         
00129         <a class="code" href="config_8h.html#a6">IOW</a> = 0;                                        <span class="comment">/* do writestrobe */</span>
00130         <span class="keywordflow">while</span>(<a class="code" href="config_8h.html#a8">IOCHRDY</a> == 0);
00131         <a class="code" href="config_8h.html#a6">IOW</a> = 1;
00132 
00133 }       
00134 
<a name="l00148"></a><a class="code" href="ethernet_8c.html#a6">00148</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a6">outNE2000again</a> (UINT8 dat)
00149 {
00150         <span class="comment">/* Write data to same reg as outNE2000 before */</span>
00151         
00152         <a class="code" href="config_8h.html#a3">DATABUS</a> = dat;
00153         
00154         <span class="comment">/* Wait until bus free */</span>
00155 
00156         <a class="code" href="config_8h.html#a6">IOW</a> = 0;                                <span class="comment">/* do writestrobe */</span>
00157         <span class="keywordflow">while</span>(<a class="code" href="config_8h.html#a8">IOCHRDY</a> == 0);
00158         <a class="code" href="config_8h.html#a6">IOW</a> = 1;
00159 }
00160 
<a name="l00175"></a><a class="code" href="ethernet_8c.html#a7">00175</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a7">outNE2000againbuf</a> (UINT8* buf, UINT16 len)
00176 {
00177 
00178         <span class="keywordflow">while</span>(len--)
00179         {
00180                 <a class="code" href="config_8h.html#a3">DATABUS</a> = *buf++;
00181                 <a class="code" href="config_8h.html#a6">IOW</a> = 0;
00182                 <span class="keywordflow">while</span>(<a class="code" href="config_8h.html#a8">IOCHRDY</a> == 0);            <span class="comment">/* Wait until bus free */</span>
00183                 <a class="code" href="config_8h.html#a6">IOW</a> = 1;
00184         }
00185 }
00186 
00187 
<a name="l00198"></a><a class="code" href="ethernet_8c.html#a8">00198</a> UINT8 <a class="code" href="ethernet_8c.html#a8">inNE2000</a> (UINT8 reg)
00199 {
00200         UINT8 temp = reg;
00201         <a class="code" href="config_8h.html#a4">DATADIR</a> = <a class="code" href="config_8h.html#a2">DDR_IN</a>;                               <span class="comment">/* port input */</span>
00202         <a class="code" href="config_8h.html#a5">ADRBUS</a> = (temp | 0x60);
00203         
00204         <span class="comment">/* Wait until bus free */</span>
00205         
00206         <a class="code" href="config_8h.html#a7">IOR</a> = 0;                                        <span class="comment">/* do readstrobe */</span>
00207         <span class="keywordflow">while</span>(<a class="code" href="config_8h.html#a8">IOCHRDY</a> == 0);
00208         temp = <a class="code" href="config_8h.html#a3">DATABUS</a>;
00209         <a class="code" href="config_8h.html#a7">IOR</a> = 1;
00210         
00211         <span class="keywordflow">return</span> temp;
00212 }
00213 
<a name="l00226"></a><a class="code" href="ethernet_8c.html#a9">00226</a> UINT8 <a class="code" href="ethernet_8c.html#a9">inNE2000again</a> (<span class="keywordtype">void</span>)
00227 {
00228         UINT8 temp;
00229         
00230         <span class="comment">/* Wait until bus free */</span>
00231 
00232         <a class="code" href="config_8h.html#a7">IOR</a> = 0;        
00233         <span class="keywordflow">while</span>(<a class="code" href="config_8h.html#a8">IOCHRDY</a> == 0);
00234         temp = <a class="code" href="config_8h.html#a3">DATABUS</a>;
00235         <a class="code" href="config_8h.html#a7">IOR</a> = 1;
00236         
00237         <span class="keywordflow">return</span>(temp);
00238  
00239 }
00240 
<a name="l00252"></a><a class="code" href="ethernet_8c.html#a10">00252</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a10">inNE2000againbuf</a> (UINT8* buf, UINT16 len)
00253 {
00254         <span class="keywordflow">while</span>(len--)
00255         {
00256                 <a class="code" href="config_8h.html#a7">IOR</a> = 0;
00257                 <span class="keywordflow">while</span>(<a class="code" href="config_8h.html#a8">IOCHRDY</a> == 0);            <span class="comment">/* Wait until bus free */</span>                               
00258                 *buf++ = <a class="code" href="config_8h.html#a3">DATABUS</a>;
00259                 <a class="code" href="config_8h.html#a7">IOR</a> = 1;        
00260         }
00261 }
00262 
<a name="l00274"></a><a class="code" href="ethernet_8c.html#a11">00274</a> UINT8 <a class="code" href="ethernet_8c.html#a11">NE2000CheckRxFrame</a> (<span class="keywordtype">void</span>)
00275 {
00276         <span class="comment">/* Checks to see if ethernet frame has been received */</span>
00277         
00278         UINT8 temp;
00279         
00280         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a> ,0x62);                   <span class="comment">/* page 1, abort DMA */</span>
00281         temp = <a class="code" href="ethernet_8c.html#a8">inNE2000</a>( <a class="code" href="ethernet_8h.html#a29">CURR</a> );
00282         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x02 );                  <span class="comment">/* page 0 */</span>
00283         
00284         <span class="keywordflow">if</span>( temp != <a class="code" href="ethernet_8c.html#a8">inNE2000</a>( <a class="code" href="ethernet_8h.html#a9">BOUNDARY</a> ) ) {
00285                 <span class="comment">/* Boundary != Current =&gt; packet exists */</span>
00286                 
00287                 <span class="comment">/* Check still for receive status       */</span>
00288                 <span class="keywordflow">if</span>(<a class="code" href="ethernet_8c.html#a8">inNE2000</a>(<a class="code" href="ethernet_8h.html#a19">RCR</a>) &amp; 0x01)
00289                         <span class="keywordflow">return</span>(TRUE);
00290 
00291         }       
00292         
00293         <span class="keywordflow">return</span>(FALSE); 
00294 }
00295 
<a name="l00304"></a><a class="code" href="ethernet_8c.html#a12">00304</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a12">NE2000DumpRxFrame</a> (<span class="keywordtype">void</span>)
00305 {
00306  
00307         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );                  <span class="comment">/* page0, abort DMA */</span>
00308         
00309         <span class="comment">/* Set boundary to start of next packet */</span>
00310         
00311         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a9">BOUNDARY</a>, <a class="code" href="ethernet_8c.html#a0">NE2000NextPktPtr</a> );        
00312 
00313  
00314 }
00315  
00316  
<a name="l00327"></a><a class="code" href="ethernet_8c.html#a1">00327</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a1">NE2000Init</a> (UINT8* mac)
00328 {
00329 
00330         <span class="comment">/* Give HW Reset        */</span>
00331         
00332         <a class="code" href="config_8h.html#a9">RESETPIN_NE2000</a> = 1;
00333         wait(10000);
00334         <a class="code" href="config_8h.html#a9">RESETPIN_NE2000</a> = 0;
00335         wait(10000);
00336         
00337         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RESETPORT, 0 );              <span class="comment">/* reset NE2000*/</span>
00338         <span class="comment">/* Wait for a while */</span>
00339         
00340         wait(30000);
00341 
00342         
00343         <span class="comment">/* Goto page 3 and set registers */</span>
00344         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0xC1 );                  <span class="comment">/* page3, stop */</span>
00345         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( 0x01, 0xC0 );                <span class="comment">/* config reg. write enble */</span>
00346         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( 0x05, 0 );                   <span class="comment">/* link test enable */</span>
00347         <span class="comment">/* outNE2000( 0x06, 0x70 );             //Full duplex, leds */</span>
00348         
00349         <span class="comment">/* Goto page 1 and set registers */</span>
00350         
00351         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x41 );                                                          <span class="comment">/* page1, stop */</span>
00352         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( PAR5, *mac++);                       <span class="comment">/* Set MAC Address  */</span>
00353         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( PAR4, *mac++);
00354         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( PAR3, *mac++);
00355         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( PAR2, *mac++);
00356         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( PAR1, *mac++);
00357         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a23">PAR0</a>, *mac); 
00358         
00359         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a29">CURR</a>, <a class="code" href="ethernet_8h.html#a33">RXBUF_START</a> ); <span class="comment">/* Current address */</span>
00360         <a class="code" href="ethernet_8c.html#a0">NE2000NextPktPtr</a> = <a class="code" href="ethernet_8h.html#a33">RXBUF_START</a>;
00361         <a class="code" href="ethernet_8c.html#a1">NE2000CurrPktPtr</a> = <a class="code" href="ethernet_8h.html#a33">RXBUF_START</a>;
00362         
00363         <span class="comment">/* Goto page 0 and set registers */</span>
00364         
00365         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0 );                                             <span class="comment">/* page0, Stop */</span>
00366         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a7">PSTART</a>, <a class="code" href="ethernet_8h.html#a33">RXBUF_START</a>);                <span class="comment">/* Rx buffer start address */</span>
00367         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a8">PSTOP</a>, <a class="code" href="ethernet_8h.html#a34">RXBUF_END</a> );                  <span class="comment">/* Rx buffer end address */</span>
00368         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a9">BOUNDARY</a>, <a class="code" href="ethernet_8h.html#a33">RXBUF_START</a> );             <span class="comment">/* Boundary */</span>
00369         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a14">ISR</a>, 0xFF );                                 <span class="comment">/* Interrupt services */</span>
00370         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a19">RCR</a>, 0xC4);                                  <span class="comment">/* Rx config (Accept all), was C4 */</span>
00371         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a20">TCR</a>, 0xE0);                                  <span class="comment">/* Tx config */</span>
00372         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a21">DCR</a>, 0xB8);                                  <span class="comment">/* Dataconfig */</span>
00373         
00374         <span class="comment">/* Start action ! */</span>
00375         
00376         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );                   <span class="comment">/* Page0, start */</span>
00377         
00378 }
00379 
00380 
<a name="l00393"></a><a class="code" href="ethernet_8c.html#a1">00393</a> <span class="keywordtype">void</span> <a class="code" href="group__periodic__functions.html#a1">NE2000CheckOverFlow</a> (<span class="keywordtype">void</span>)
00394 {
00395         <span class="comment">/* Checks if Receive Buffer overflow has happened */</span>
00396         <span class="comment">/* and re-initializes the NIC if needed                   */</span>
00397         
00398         UINT8 temp;
00399 
00400         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );                  <span class="comment">/* page0, abort DMA */</span>
00401 
00402         <span class="keywordflow">if</span>( <a class="code" href="ethernet_8c.html#a8">inNE2000</a>( <a class="code" href="ethernet_8h.html#a14">ISR</a> ) &amp; 0x10 ) {
00403         
00404                 <span class="comment">/* OverFlow occured!! */</span>
00405         
00406                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x21 );          <span class="comment">/* Issue Stop-command           */</span>
00407  
00408                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a17">RBCR0</a>, 0x00 );       <span class="comment">/* Clear remote Byte Count      */</span>
00409                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RBCR1, 0x00 );
00410         
00411                 <span class="comment">/* Poll the interrupt status register for RST bit */</span>
00412         
00413                 kick_WD();
00414                 <span class="keywordflow">while</span>( ( <a class="code" href="ethernet_8c.html#a8">inNE2000</a>( <a class="code" href="ethernet_8h.html#a14">ISR</a> ) &amp; 0x80 ) == 0 );
00415 
00416                 <span class="comment">/* RST was set, NIC is in Stop mode     */</span>
00417                 <span class="comment">/* Enter to LOOPBACK mode now           */</span>
00418         
00419                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a20">TCR</a>, 0x02 );
00420         
00421                 <span class="comment">/* Issue Start Command                                                  */</span>
00422                 <span class="comment">/* NIC is still inactive because LOOPBACK on    */</span>
00423         
00424                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>(<a class="code" href="ethernet_8h.html#a6">CR</a>,0x22);
00425         
00426                 <span class="comment">/* Remove Packet from buffer */</span>
00427         
00428                 <span class="keywordflow">if</span>(<a class="code" href="ethernet_8c.html#a8">inNE2000</a>(<a class="code" href="ethernet_8h.html#a9">BOUNDARY</a>) != <a class="code" href="ethernet_8c.html#a0">NE2000NextPktPtr</a>) {
00429                         ETH_DEBUGOUT(<span class="stringliteral">"\r\n*********Normal Overflow**********\r\n"</span>);
00430                         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a9">BOUNDARY</a>, <a class="code" href="ethernet_8c.html#a0">NE2000NextPktPtr</a> );
00431                 } <span class="keywordflow">else</span> {
00432                         <span class="comment">/* There has been an overflow after we have received the packet */</span>
00433                         <span class="comment">/* last time                                                                                                    */</span>
00434                 
00435                         ETH_DEBUGOUT(<span class="stringliteral">"???????????????????????????????????\r\n"</span>);
00436                         ETH_DEBUGOUT(<span class="stringliteral">"Unrecognized overflow!!\r\n"</span>);
00437                         ETH_DEBUGOUT(<span class="stringliteral">"中中中中中中中中中中中中中中中中中么r\n"</span>);
00438                 
00439                         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>(<a class="code" href="ethernet_8h.html#a6">CR</a> ,0x62);                    <span class="comment">/* page 1, abort DMA */</span>
00440                         temp = <a class="code" href="ethernet_8c.html#a8">inNE2000</a>(<a class="code" href="ethernet_8h.html#a29">CURR</a>);
00441                         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );                  <span class="comment">/* page0, abort DMA */</span>
00442                 
00443                         <span class="comment">/* Dischard the whole buffer    */</span>
00444                 
00445                         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a9">BOUNDARY</a>, temp);
00446                         
00447                         <a class="code" href="ethernet_8c.html#a0">NE2000NextPktPtr</a> = temp;
00448                         <a class="code" href="ethernet_8c.html#a1">NE2000CurrPktPtr</a> = temp;                        
00449                 
00450                 }
00451  
00452                 
00453                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a14">ISR</a>, 0xFF );                  <span class="comment">/* Interrupt services */</span>
00454         
00455                 <span class="comment">/* Exit from loopback to normal mode */</span>
00456         
00457                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a20">TCR</a>, 0xE0);                   <span class="comment">/* Tx config */</span>
00458         
00459         }
00460  
00461 }
00462 
<a name="l00482"></a><a class="code" href="ethernet_8c.html#a15">00482</a> UINT8 <a class="code" href="ethernet_8c.html#a15">NE2000ReceiveFrame</a> (<span class="keywordtype">void</span>)
00483 {
00484 
00485         
00486         <span class="keywordflow">if</span>( <a class="code" href="ethernet_8c.html#a11">NE2000CheckRxFrame</a>() == <a class="code" href="system_8h.html#a2">FALSE</a> ) 
00487                 <span class="keywordflow">return</span>(FALSE);
00488 
00489         
00490         <span class="comment">/* There is data, receive Ethernet info */</span>
00491         
00492         <a class="code" href="ethernet_8c.html#a1">NE2000CurrPktPtr</a> = <a class="code" href="ethernet_8c.html#a8">inNE2000</a>(<a class="code" href="ethernet_8h.html#a9">BOUNDARY</a>);  <span class="comment">/* Store pointer */</span>
00493         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );                                  <span class="comment">/* page0, abort DMA */</span>
00494         
00495         <span class="comment">/* Initialize DMA  to Start of the packet       */</span>
00496         
00497         
00498         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a15">RSAR0</a>, 0 );
00499         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RSAR1, <a class="code" href="ethernet_8c.html#a1">NE2000CurrPktPtr</a> );
00500         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a17">RBCR0</a>, 0xFF );                               <span class="comment">/* Set DMA length for */</span>
00501         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RBCR1, 0x0F );                               <span class="comment">/* definitely sufficient */</span>
00502 
00503         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x0A );                                  <span class="comment">/* page 0, remote read */</span>
00504         
00505         <a class="code" href="ethernet_8c.html#a8">inNE2000</a>( <a class="code" href="ethernet_8h.html#a31">IOPORT</a> );                                             <span class="comment">/* ignore receive status */</span>
00506         
00507         <a class="code" href="ethernet_8c.html#a0">NE2000NextPktPtr</a> = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();             <span class="comment">/* Store pointer */</span>
00508         
00509         <span class="comment">/* Record Frame Size                                    */</span>
00510         
00511         received_frame.<a class="code" href="structethernet__frame.html#m2">frame_size</a> = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();                                    
00512         received_frame.<a class="code" href="structethernet__frame.html#m2">frame_size</a> |= ((UINT16)<a class="code" href="ethernet_8c.html#a9">inNE2000again</a>()) &lt;&lt; 8;
00513         
00514         <span class="keywordflow">if</span>(received_frame.<a class="code" href="structethernet__frame.html#m2">frame_size</a> &gt; 4)
00515                 received_frame.<a class="code" href="structethernet__frame.html#m2">frame_size</a> -= 4;                 <span class="comment">/* Remove chip specific bytes   */</span>
00516         <span class="keywordflow">else</span>
00517                 <span class="keywordflow">return</span>(FALSE);
00518         
00519         <span class="comment">/* Record destination Ethernet Address  */</span>
00520         
00521         received_frame.<a class="code" href="structethernet__frame.html#m0">destination</a>[5] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();                                                
00522         received_frame.<a class="code" href="structethernet__frame.html#m0">destination</a>[4] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00523         received_frame.<a class="code" href="structethernet__frame.html#m0">destination</a>[3] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00524         received_frame.<a class="code" href="structethernet__frame.html#m0">destination</a>[2] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00525         received_frame.<a class="code" href="structethernet__frame.html#m0">destination</a>[1] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00526         received_frame.<a class="code" href="structethernet__frame.html#m0">destination</a>[0] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00527         
00528         <span class="comment">/* Record senders Ethernet address              */</span>
00529         
00530         received_frame.<a class="code" href="structethernet__frame.html#m1">source</a>[5] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00531         received_frame.<a class="code" href="structethernet__frame.html#m1">source</a>[4] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00532         received_frame.<a class="code" href="structethernet__frame.html#m1">source</a>[3] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00533         received_frame.<a class="code" href="structethernet__frame.html#m1">source</a>[2] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00534         received_frame.<a class="code" href="structethernet__frame.html#m1">source</a>[1] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00535         received_frame.<a class="code" href="structethernet__frame.html#m1">source</a>[0] = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>(); 
00536         
00537         <span class="comment">/* Record Protocol      */</span>
00538         
00539         received_frame.<a class="code" href="structethernet__frame.html#m3">protocol</a> = <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00540         received_frame.<a class="code" href="structethernet__frame.html#m3">protocol</a> &lt;&lt;= 8;
00541         received_frame.<a class="code" href="structethernet__frame.html#m3">protocol</a> |= <a class="code" href="ethernet_8c.html#a9">inNE2000again</a>();
00542         
00543         <span class="comment">/* Give the next layer data start buffer index from the start   */</span>
00544         
00545         received_frame.<a class="code" href="structethernet__frame.html#m4">buf_index</a> = ETH_HEADER_LEN;
00546         
00547         <span class="comment">/* Stop DMA */</span>
00548         
00549         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );  
00550         
00551         ETH_DEBUGOUT(<span class="stringliteral">"Ethernet Frame Received\n\r"</span>);
00552         
00553         <span class="keywordflow">return</span>(TRUE);                                           <span class="comment">/* Indicate we got packet */</span>
00554         
00555 }
00556 
<a name="l00570"></a><a class="code" href="ethernet_8c.html#a16">00570</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a16">InitTransmission</a> (UINT8 page)
00571 {
00572         <span class="comment">/* Initializes NE2000 for remote write                                          */</span>
00573         
00574         <span class="keywordflow">while</span>( (<a class="code" href="ethernet_8c.html#a8">inNE2000</a>(<a class="code" href="ethernet_8h.html#a6">CR</a>) &amp; 0x04) ) ;                <span class="comment">/* wait Tx to complete */</span>
00575         
00576         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );                          <span class="comment">/* page0, abort DMA */</span>
00577         
00578         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a10">TPSR</a>, page );                        <span class="comment">/* Tx buffer Start */</span>
00579         
00580         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a15">RSAR0</a>, 0x00 );                       <span class="comment">/* Remote DMA start */</span>
00581         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RSAR1, page );
00582         
00583         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a17">RBCR0</a>, 0xEA );                       <span class="comment">/* Max.Ethernet frame */</span>
00584         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RBCR1, 0x05 );                       <span class="comment">/* size */</span>
00585         
00586         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x12 );                          <span class="comment">/* page0, remote write */</span>
00587         
00588         <span class="comment">/* Set Address lines to be ready        */</span>
00589         
00590         <a class="code" href="config_8h.html#a4">DATADIR</a> = <a class="code" href="config_8h.html#a1">DDR_OUT</a>;                              <span class="comment">/* datapins = output */</span>
00591         <a class="code" href="config_8h.html#a5">ADRBUS</a> =  (<a class="code" href="ethernet_8h.html#a31">IOPORT</a> | 0x60);      <span class="comment">/* dont change R,W,Reset pins */</span>
00592                 
00593         
00594 }
00595 
<a name="l00608"></a><a class="code" href="ethernet_8c.html#a17">00608</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a17">NE2000WriteEthernetHeader</a> (<span class="keyword">struct</span> <a class="code" href="structethernet__frame.html">ethernet_frame</a>* frame)
00609 {
00610         INT8 i;
00611         
00612         <span class="comment">/* Write destination Ethernet Address   */</span>
00613         
00614         <span class="keywordflow">for</span>(i=ETH_ADDRESS_LEN-1; i &gt;= 0; i--) {
00615                 <a class="code" href="ethernet_8c.html#a6">outNE2000again</a>(frame-&gt;<a class="code" href="structethernet__frame.html#m0">destination</a>[i]);
00616         }
00617 
00618         <span class="comment">/* Write sender (our) Ethernet address  */</span>
00619         
00620         <span class="keywordflow">for</span>(i=ETH_ADDRESS_LEN-1; i &gt;= 0; i--) {
00621                 <a class="code" href="ethernet_8c.html#a6">outNE2000again</a>(frame-&gt;<a class="code" href="structethernet__frame.html#m1">source</a>[i]);
00622         }
00623         
00624         <span class="comment">/* Write protocol                                               */</span>
00625         
00626         <a class="code" href="ethernet_8c.html#a6">outNE2000again</a>( (UINT8)(frame-&gt;<a class="code" href="structethernet__frame.html#m3">protocol</a> &gt;&gt; 8) );
00627         <a class="code" href="ethernet_8c.html#a6">outNE2000again</a>( (UINT8)frame-&gt;<a class="code" href="structethernet__frame.html#m3">protocol</a> );
00628 
00629 }
00630 
<a name="l00639"></a><a class="code" href="ethernet_8c.html#a18">00639</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a18">NE2000DMAInit</a> (UINT8 page)
00640 {
00641         
00642         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );                  <span class="comment">/* page0, abort DMA  */</span>
00643         
00644         <span class="comment">/* Initialize DMA  to address field in Ethernet Frame   */</span>
00645         <span class="comment">/* That is, isolate chip specific fields from                   */</span>
00646         <span class="comment">/* actual Ethernet Frame                                                                */</span>
00647         
00648         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a15">RSAR0</a>, 4 );
00649         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RSAR1, page );
00650         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a17">RBCR0</a>, 0xFF );               <span class="comment">/* Set DMA length for */</span>
00651         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RBCR1, 0x0F );               <span class="comment">/* definitely sufficient */</span>
00652         
00653 }
00654 
<a name="l00665"></a><a class="code" href="ethernet_8c.html#a19">00665</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a19">NE2000DMAInit_position</a> (UINT16 pos)
00666 {
00667         
00668         UINT16 abspos;
00669         UINT16 page;
00670         UINT8 offset;
00671         
00672         <span class="comment">/* Calculate start page */</span>
00673         
00674         abspos = pos + 4;
00675         
00676         page = (UINT8)(abspos &gt;&gt; 8);
00677         page += <a class="code" href="ethernet_8c.html#a1">NE2000CurrPktPtr</a>;
00678         
00679         <span class="comment">/* Check we are not exceeding the Rx buffer space       */</span>
00680         
00681         <span class="keywordflow">if</span>( page &gt;= <a class="code" href="ethernet_8h.html#a34">RXBUF_END</a> ) {
00682                 page = <a class="code" href="ethernet_8h.html#a33">RXBUF_START</a> + (page - <a class="code" href="ethernet_8h.html#a34">RXBUF_END</a>);
00683         } 
00684         
00685         offset = (UINT8)(abspos &amp; 0xFF);
00686         
00687         <span class="comment">/* Make settings                */</span>
00688          
00689         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x22 );                  <span class="comment">/* page0, abort DMA */</span>
00690         
00691         <span class="comment">/* Initialize DMA  to address field in Ethernet Frame   */</span>
00692         <span class="comment">/* That is, isolate chip specific fields from                   */</span>
00693         <span class="comment">/* actual Ethernet Frame                                                                */</span>
00694         
00695         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a15">RSAR0</a>, offset );
00696         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RSAR1, (UINT8)page );
00697         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a17">RBCR0</a>, 0xFF );               <span class="comment">/* Set DMA length for */</span>
00698         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( RBCR1, 0x0F );               <span class="comment">/* definitely sufficient */</span>
00699         
00700         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0x0A );                  <span class="comment">/* page 0, remote read */</span>
00701         
00702         <span class="comment">/* Init Address bus     */</span>
00703 
00704         <a class="code" href="config_8h.html#a4">DATADIR</a> = <a class="code" href="config_8h.html#a2">DDR_IN</a>;                               <span class="comment">/* port input */</span>
00705         <a class="code" href="config_8h.html#a5">ADRBUS</a> = (<a class="code" href="ethernet_8h.html#a31">IOPORT</a> | 0x60);
00706         
00707         <span class="comment">/* Now just read by inNE2000again()             */</span>
00708 }
00709 
00710 
00711 
<a name="l00725"></a><a class="code" href="ethernet_8c.html#a20">00725</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a20">NE2000SendFrame</a> ( UINT16 len )
00726 {
00727         <span class="comment">/* After filling Tx buffer, call this function to send it */</span>
00728         <span class="comment">/* Input:       Len: packet length                                                        */</span>
00729 
00730         
00731         <span class="comment">/* Check if we need to insert Pad bytes */</span>
00732         
00733         <span class="keywordflow">while</span>(len &lt; 50) {
00734                 <a class="code" href="ethernet_8c.html#a6">outNE2000again</a>((BYTE)0x00);
00735                 len++;
00736         }
00737         
00738         len += 6 + 6 + 2;
00739         
00740         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, (BYTE)0x22 );                            <span class="comment">/* Page0, abort DMA */</span>
00741         
00742         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a12">TBCR0</a>, (BYTE)(len) );
00743         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a13">TBCR1</a>, (BYTE)(len &gt;&gt; 8 ) );
00744         
00745         <span class="comment">/* Transmit packet to Ether */</span>
00746         
00747         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, (BYTE)0x06 );            <span class="comment">/* Page0, transmit */</span>
00748         
00749         
00750 }
00751 
<a name="l00760"></a><a class="code" href="ethernet_8c.html#a21">00760</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a21">NE2000EnterSleep</a> (<span class="keywordtype">void</span>) 
00761 {
00762         <span class="keywordflow">if</span> (EtherSleep)
00763                 <span class="keywordflow">return</span>;
00764 
00765         <a class="code" href="ethernet_8c.html#a2">EtherSleep</a> = 1;
00766         
00767         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0xE2 );                  <span class="comment">/* page3, abort DMA      */</span>
00768         <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( 0x06, 0x04);                 <span class="comment">/* Sleep */</span>
00769 }
00770 
<a name="l00779"></a><a class="code" href="ethernet_8c.html#a22">00779</a> <span class="keywordtype">void</span> <a class="code" href="ethernet_8c.html#a22">NE2000ExitSleep</a> (<span class="keywordtype">void</span>) 
00780 {
00781         <span class="keywordflow">if</span> (EtherSleep) {
00782                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( <a class="code" href="ethernet_8h.html#a6">CR</a>, 0xE2 );                  <span class="comment">/* age3, abort DMA       */</span>
00783                 <a class="code" href="ethernet_8c.html#a5">outNE2000</a>( 0x06, 0x00);                 <span class="comment">/* Wake up */</span>
00784                 <a class="code" href="ethernet_8c.html#a2">EtherSleep</a> = 0;
00785         }
00786                 
00787 }
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:32:59 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
