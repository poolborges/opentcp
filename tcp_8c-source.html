<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/tcp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/tcp.c</h1><a href="tcp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright </span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright </span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the </span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if </span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola </span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself, </span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to </span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior </span>
00026 <span class="comment"> *written permission. For written permission, please contact </span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP", </span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written </span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED </span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE </span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR </span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE </span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, </span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series </span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to </span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see </span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00085 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00086 <span class="preprocessor">#include &lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00087 <span class="preprocessor">#include &lt;<a class="code" href="timers_8h.html">inet/timers.h</a>&gt;</span>
00088 <span class="preprocessor">#include &lt;<a class="code" href="ethernet_8h.html">inet/ethernet.h</a>&gt;</span>
00089 <span class="preprocessor">#include &lt;<a class="code" href="ip_8h.html">inet/ip.h</a>&gt;</span>
00090 <span class="preprocessor">#include &lt;<a class="code" href="tcp__ip_8h.html">inet/tcp_ip.h</a>&gt;</span>
00091 <span class="preprocessor">#include &lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00092 
<a name="l00102"></a><a class="code" href="tcp_8c.html#a0">00102</a> <span class="keyword">struct </span><a class="code" href="structtcp__frame.html">tcp_frame</a> received_tcp_packet;
00103 
<a name="l00118"></a><a class="code" href="tcp_8c.html#a1">00118</a> <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a> tcp_socket[NO_OF_TCPSOCKETS + 1]; 
00119 
<a name="l00120"></a><a class="code" href="tcp_8c.html#a2">00120</a> UINT8 <a class="code" href="tcp_8c.html#a2">tcp_tempbuf</a>[MIN_TCP_HLEN + 1]; 
00123 <span class="comment">/***********************************************************************/</span>
00124 <span class="comment">/*******        TCP API functions                                                                       ********/</span>
00125 <span class="comment">/***********************************************************************/</span>
00126 
<a name="l00155"></a><a class="code" href="tcp_8c.html#a3">00155</a> INT8 <a class="code" href="tcp_8c.html#a3">tcp_getsocket</a> (UINT8 soctype, UINT8 tos, UINT16 tout, INT32 (*listener)(INT8, UINT8, UINT32, UINT32) )
00156 {
00157         INT8 i;
00158         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00159         
00160         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
00161                 <span class="keywordflow">return</span>(-1);
00162         
00163         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
00164                 <span class="keywordflow">return</span>(-1);
00165         
00166         <span class="keywordflow">if</span>( (soctype != <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>) &amp;&amp;
00167                 (soctype != <a class="code" href="tcp__ip_8h.html#a40">TCP_TYPE_CLIENT</a>) &amp;&amp;
00168                 (soctype != <a class="code" href="tcp__ip_8h.html#a41">TCP_TYPE_CLIENT_SERVER</a>) &amp;&amp;
00169                 (soctype != <a class="code" href="tcp__ip_8h.html#a38">TCP_TYPE_NONE</a>)                              ) {
00170                 TCP_DEBUGOUT(<span class="stringliteral">"Invalid socket type requested\r\n"</span>);
00171                 <span class="keywordflow">return</span>(-1);
00172         }
00173         
00174         <span class="keywordflow">if</span>(listener == 0) {
00175                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Event listener function not specified\r\n"</span>);
00176                 <span class="keywordflow">return</span>(-1);
00177         }
00178         
00179         TCP_DEBUGOUT(<span class="stringliteral">"Searching for free TCP socket...\r\n"</span>);
00180         
00181         <span class="keywordflow">for</span>(i=0; i &lt; NO_OF_TCPSOCKETS; i++)     {
00182                 soc = &amp;tcp_socket[i];                   <span class="comment">/* Get Socket   */</span>
00183         
00184                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a> == <a class="code" href="tcp__ip_8h.html#a42">TCP_STATE_FREE</a>) {
00185                         <span class="comment">/* We found it  */</span>
00186                         
00187                         TCP_DEBUGOUT(<span class="stringliteral">"Free socket found\r\n"</span>);
00188                         
00189                         soc-&gt;<a class="code" href="structtcb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a43">TCP_STATE_RESERVED</a>;
00190                         soc-&gt;<a class="code" href="structtcb.html#m1">type</a> = soctype;
00191                         soc-&gt;<a class="code" href="structtcb.html#m11">tos</a> = tos;
00192                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a> = listener;
00193                         soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> = 0;
00194                         soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> = 0;
00195                         soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> = 0;
00196                         soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> = 0;
00197                         soc-&gt;<a class="code" href="structtcb.html#m10">tout</a> = tout*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>;
00198                         
00199                         <span class="keywordflow">return</span>(i);
00200                 }
00201         
00202         }
00203         
00204         <span class="comment">/* We are there so no socket found      */</span>
00205         
00206         TCP_DEBUGOUT(<span class="stringliteral">"No socket found\r\n"</span>);
00207         <span class="keywordflow">return</span>(-1);
00208 
00209 }
00210 
<a name="l00228"></a><a class="code" href="tcp_8c.html#a4">00228</a> INT8 <a class="code" href="tcp_8c.html#a4">tcp_releasesocket</a> (INT8 sochandle)
00229 {
00230         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00231         
00232         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
00233                 <span class="keywordflow">return</span>(-1);
00234         
00235         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
00236                 <span class="keywordflow">return</span>(-1);
00237         
00238         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_TCPSOCKETS ) {
00239                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00240                 <span class="keywordflow">return</span>(-1);
00241         }
00242         
00243         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00244                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00245                 <span class="keywordflow">return</span>(-1);
00246         }
00247         
00248         soc = &amp;tcp_socket[sochandle];           <span class="comment">/* Get referense        */</span>
00249         
00250         <span class="keywordflow">if</span>( (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a42">TCP_STATE_FREE</a>) &amp;&amp;
00251                 (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a43">TCP_STATE_RESERVED</a>) &amp;&amp;
00252                 (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>)                ) {
00253                 TCP_DEBUGOUT(<span class="stringliteral">"Socket is not on valid state to be released\r\n"</span>);
00254                 <span class="keywordflow">return</span>(-1);
00255         }
00256         
00257         <span class="comment">/* We are there so all OK       */</span>
00258         
00259         soc-&gt;<a class="code" href="structtcb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a42">TCP_STATE_FREE</a>;
00260         soc-&gt;<a class="code" href="structtcb.html#m1">type</a> = <a class="code" href="tcp__ip_8h.html#a38">TCP_TYPE_NONE</a>;
00261         soc-&gt;<a class="code" href="structtcb.html#m11">tos</a> = 0;
00262         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a> = 0;
00263         soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> = 0;
00264         soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> = 0;
00265         soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> = 0;
00266         soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> = 0;
00267         
00268         <span class="keywordflow">return</span>(sochandle);
00269 
00270 }
00271 
<a name="l00290"></a><a class="code" href="tcp_8c.html#a5">00290</a> INT8 <a class="code" href="tcp_8c.html#a5">tcp_listen</a> (INT8 sochandle, UINT16 port)
00291 {
00292         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00293 
00294         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
00295                 <span class="keywordflow">return</span>(-1);
00296         
00297         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
00298                 <span class="keywordflow">return</span>(-1);
00299         
00300         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_TCPSOCKETS ) {
00301                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00302                 <span class="keywordflow">return</span>(-1);
00303         }
00304         
00305         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00306                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00307                 <span class="keywordflow">return</span>(-1);
00308         }
00309         
00310         soc = &amp;tcp_socket[sochandle];           <span class="comment">/* Get referense        */</span>
00311                 
00312         <span class="keywordflow">if</span>( (soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>) == 0 ) {
00313                 TCP_DEBUGOUT(<span class="stringliteral">"Socket has no server properties\r\n"</span>);
00314                 <span class="keywordflow">return</span>(-1);
00315         }
00316         
00317         <span class="keywordflow">if</span>( soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a> == 0) {
00318                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:No event listener function specified\r\n"</span>);
00319                 <span class="keywordflow">return</span>(-1);
00320         }
00321         
00322         
00323         <span class="keywordflow">if</span>( (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a43">TCP_STATE_RESERVED</a>) &amp;&amp;
00324                 (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>)     &amp;&amp;
00325                 (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>) &amp;&amp;             
00326                 (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>)            ) {
00327                 TCP_DEBUGOUT(<span class="stringliteral">"Not possible to listen, socket on connected state\r\n"</span>);
00328                 <span class="keywordflow">return</span>(-1);
00329         
00330         }
00331         
00332                         
00333         <span class="comment">/* Init socket          */</span>
00334                                 
00335         soc-&gt;<a class="code" href="structtcb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>;
00336         <span class="comment">/*soc-&gt;type = TCP_TYPE_SERVER;*/</span>
00337         soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> = 0;
00338         soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> = 0;
00339         soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> = 0;
00340         soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> = port;
00341         soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = 0;
00342         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = 0;
00343         soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> = 0xFFFFFFFF;
00344         soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a> = TCP_DEF_MTU;
00345         soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = 0;
00346         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> = 0;
00347                         
00348         TCP_DEBUGOUT(<span class="stringliteral">"TCP listening socket created\r\n"</span>);
00349                         
00350         <span class="keywordflow">return</span>(sochandle);
00351 
00352 }
00353 
00354 
<a name="l00377"></a><a class="code" href="tcp_8c.html#a6">00377</a> INT8 <a class="code" href="tcp_8c.html#a6">tcp_connect</a> (INT8 sochandle, UINT32 ip, UINT16 rport, UINT16 myport )
00378 {
00379         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00380         
00381         TCP_DEBUGOUT(<span class="stringliteral">"FUNCTION: tcp_connect\r\n"</span>);
00382 
00383         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
00384                 <span class="keywordflow">return</span>(-1);
00385         
00386         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
00387                 <span class="keywordflow">return</span>(-1);
00388         
00389         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_TCPSOCKETS ) {
00390                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00391                 <span class="keywordflow">return</span>(-1);
00392         }
00393         
00394         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00395                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00396                 <span class="keywordflow">return</span>(-1);
00397         }
00398         
00399         <span class="comment">/* Is the local port defined    */</span>
00400         
00401         <span class="keywordflow">if</span>( myport == 0 )
00402                 myport = <a class="code" href="tcp_8c.html#a89">tcp_getfreeport</a>();
00403         
00404         <span class="keywordflow">if</span>( myport == 0 )
00405                 <span class="keywordflow">return</span>(-1);
00406         
00407         soc = &amp;tcp_socket[sochandle];           <span class="comment">/* Get referense        */</span>
00408         
00409         <span class="comment">/* Do we have client properties?        */</span>
00410         
00411         <span class="keywordflow">if</span>( (soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a40">TCP_TYPE_CLIENT</a>) == 0 ) {
00412                 TCP_DEBUGOUT(<span class="stringliteral">"Socket has no client properties\r\n"</span>);
00413                 <span class="keywordflow">return</span>(-1);
00414         }
00415         
00416         <span class="keywordflow">if</span>( soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a> == 0) {
00417                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:No event listener function specified\r\n"</span>);
00418                 <span class="keywordflow">return</span>(-1);
00419         }
00420         
00421         <span class="comment">/* Are we on LISTENING, RESERVED or CLOSED state        */</span>
00422         
00423         <span class="keywordflow">if</span>( (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a43">TCP_STATE_RESERVED</a>) &amp;&amp;
00424                 (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>) &amp;&amp;
00425                 (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>)                ) {
00426                 TCP_DEBUGOUT(<span class="stringliteral">"Socket on unvalid state to initialize CONNECT\r\n"</span>);
00427                 <span class="keywordflow">return</span>(-1);
00428         }
00429         
00430         <span class="comment">/* Then just set parameters and send SYN        */</span>
00431         
00432         soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> = ip;
00433         soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> = rport;
00434         soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> = myport;
00435         soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> = 0;
00436         soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a> = TCP_DEF_MTU;
00437         
00438         <span class="comment">/* get initial sequence number  */</span>
00439         
00440         soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = <a class="code" href="tcp_8c.html#a79">tcp_initseq</a>(); 
00441         soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> = soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> + 1;
00442         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_SYN;
00443         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
00444         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a47">TCP_STATE_SYN_SENT</a>);
00445         
00446         <span class="keywordflow">return</span>(sochandle);
00447 }
00448 
00449 
00450 
<a name="l00481"></a><a class="code" href="tcp_8c.html#a7">00481</a> INT16 <a class="code" href="tcp_8c.html#a7">tcp_send</a> (INT8 sockethandle, UINT8* buf, UINT16 blen, UINT16 dlen)
00482 {
00483         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00484         UINT8 i;
00485 
00486         
00487         TCP_DEBUGOUT(<span class="stringliteral">"Entering to send TCP data packet\r\n"</span>);
00488         
00489         kick_WD();
00490         
00491         <span class="keywordflow">if</span>( sockethandle &lt; 0 ) {
00492                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Socket Handle not valid (&lt;0)\r\n"</span>);
00493                 <span class="keywordflow">return</span>(-1);
00494         }
00495         
00496         <span class="keywordflow">if</span>( sockethandle &gt; NO_OF_TCPSOCKETS ) {
00497                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Socket Handle not valid (&gt;NO_OF_TCPSOCKETS)\r\n"</span>);
00498                 <span class="keywordflow">return</span>(-1);
00499         }
00500         
00501         soc = &amp;tcp_socket[sockethandle];                                <span class="comment">/* Get socket   */</span>
00502         
00503         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>) {
00504                 TCP_DEBUGOUT(<span class="stringliteral">"TCP is not connected!!\r\n"</span>);
00505                 <span class="keywordflow">return</span>(-1);
00506         }
00507         
00508         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>) {
00509                 TCP_DEBUGOUT(<span class="stringliteral">"TCP contains unacked data, cannot send more\r\n"</span>);
00510                 <span class="keywordflow">return</span>(-1);
00511         }
00512         
00513         <span class="keywordflow">if</span>( dlen &gt; blen )
00514                 dlen = blen;
00515         
00516         <span class="keywordflow">if</span>(dlen + MIN_TCP_HLEN &gt; soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a>) {
00517                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a> &gt; MIN_TCP_HLEN)
00518                         dlen = soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a> - MIN_TCP_HLEN;
00519                 <span class="keywordflow">else</span>
00520                         <span class="keywordflow">return</span>(-1);
00521         }
00522         
00523         soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> += dlen;
00524         
00525         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK | TCP_FLAG_PUSH;
00526         <a class="code" href="tcp_8c.html#a15">process_tcp_out</a>(sockethandle, buf - MIN_TCP_HLEN, blen + MIN_TCP_HLEN + 1, dlen);
00527         
00528         <span class="keywordflow">return</span>(dlen);
00529 }
00530 
00531 
<a name="l00549"></a><a class="code" href="tcp_8c.html#a8">00549</a> INT8 <a class="code" href="tcp_8c.html#a8">tcp_close</a> (INT8 sochandle)
00550 {
00551         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00552         
00553         TCP_DEBUGOUT(<span class="stringliteral">"FUNCTION: tcp_close\r\n"</span>);
00554 
00555         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
00556                 <span class="keywordflow">return</span>(-1);
00557         
00558         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
00559                 <span class="keywordflow">return</span>(-1);
00560         
00561         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_TCPSOCKETS ) {
00562                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00563                 <span class="keywordflow">return</span>(-1);
00564         }
00565         
00566         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00567                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00568                 <span class="keywordflow">return</span>(-1);
00569         }
00570         
00571         soc = &amp;tcp_socket[sochandle];           <span class="comment">/* Get referense        */</span>      
00572         
00573         <span class="keywordflow">switch</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a>) {
00574                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>:
00575                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
00576                         <span class="keywordflow">break</span>;
00577                 
00578                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a46">TCP_STATE_SYN_RECEIVED</a>:
00579                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK | TCP_FLAG_FIN;
00580                         soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a>++;
00581                         soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>++;
00582                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
00583                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>);
00584                         <span class="keywordflow">break</span>;
00585                 
00586                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a47">TCP_STATE_SYN_SENT</a>:
00587                 
00588                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
00589                 
00590                         <span class="keywordflow">break</span>;
00591                 
00592                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>:
00593                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a49">TCP_STATE_FINW2</a>:
00594                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a50">TCP_STATE_CLOSING</a>:
00595                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>:
00596                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a51">TCP_STATE_LAST_ACK</a>:
00597                 
00598                         <span class="comment">/* We are closing already       */</span>
00599                         
00600                         <span class="keywordflow">break</span>;
00601                 
00602                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>:
00603                 
00604                         <span class="comment">/* Is there unacked data?       */</span>
00605                         
00606                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> == soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
00607                                 <span class="comment">/* There is no unacked data     */</span>
00608                                 
00609                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK | TCP_FLAG_FIN;
00610                                 soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>++;
00611                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
00612                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>);                             
00613                         } <span class="keywordflow">else</span> {
00614                                 <span class="comment">/* Can't do much but raise pollable flag to soc-&gt;flags          */</span>
00615                                 <span class="comment">/* and process it on tcp_poll                                                           */</span>
00616                                 
00617                                 soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> |= TCP_INTFLAGS_CLOSEPENDING;
00618                                 
00619                                 
00620                                 <span class="keywordflow">return</span>(sochandle);
00621                         }
00622                 
00623                         <span class="keywordflow">break</span>;
00624         
00625                 <span class="keywordflow">default</span>:
00626                         <span class="keywordflow">return</span>(-1);
00627         }
00628         
00629         <span class="keywordflow">return</span>(sochandle);
00630 
00631 }
00632 
00633 
00634 
<a name="l00648"></a><a class="code" href="tcp_8c.html#a9">00648</a> INT8 <a class="code" href="tcp_8c.html#a9">tcp_getstate</a> (INT8 sochandle)
00649 {
00650         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00651 
00652         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
00653                 <span class="keywordflow">return</span>(-1);
00654         
00655         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
00656                 <span class="keywordflow">return</span>(-1);
00657         
00658         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_TCPSOCKETS ) {
00659                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00660                 <span class="keywordflow">return</span>(-1);
00661         }
00662         
00663         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00664                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00665                 <span class="keywordflow">return</span>(-1);
00666         }
00667         
00668         soc = &amp;tcp_socket[sochandle];           <span class="comment">/* Get referense        */</span>      
00669 
00670         <span class="keywordflow">return</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a>);
00671 
00672 }
00673 
00674 
<a name="l00690"></a><a class="code" href="tcp_8c.html#a10">00690</a> INT16 <a class="code" href="tcp_8c.html#a10">tcp_checksend</a> (INT8 sochandle)
00691 {
00692         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00693 
00694         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
00695                 <span class="keywordflow">return</span>(-1);
00696         
00697         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
00698                 <span class="keywordflow">return</span>(-1);
00699         
00700         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_TCPSOCKETS ) {
00701                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00702                 <span class="keywordflow">return</span>(-1);
00703         }
00704         
00705         soc = &amp;tcp_socket[sochandle];           <span class="comment">/* Get referense        */</span>      
00706         
00707         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>)
00708                 <span class="keywordflow">return</span>(-1);
00709 
00710         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> == soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>)
00711                 <span class="keywordflow">return</span>(soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a>);
00712         
00713         <span class="keywordflow">return</span>(-1);
00714 
00715 
00716 }
00717 
00718 
00719 
<a name="l00736"></a><a class="code" href="tcp_8c.html#a11">00736</a> INT8 <a class="code" href="tcp_8c.html#a11">tcp_abort</a> (INT8 sochandle)
00737 {
00738         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00739         
00740         TCP_DEBUGOUT(<span class="stringliteral">"FUNCTION: tcp_abort\r\n"</span>);
00741 
00742         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
00743                 <span class="keywordflow">return</span>(-1);
00744         
00745         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
00746                 <span class="keywordflow">return</span>(-1);
00747         
00748         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_TCPSOCKETS ) {
00749                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00750                 <span class="keywordflow">return</span>(-1);
00751         }
00752         
00753         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00754                 TCP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00755                 <span class="keywordflow">return</span>(-1);
00756         }
00757         
00758         soc = &amp;tcp_socket[sochandle];           <span class="comment">/* Get referense        */</span>      
00759 
00760         <span class="keywordflow">switch</span> (soc-&gt;<a class="code" href="structtcb.html#m0">state</a>)     {
00761                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a42">TCP_STATE_FREE</a>:
00762                         <span class="keywordflow">return</span>(-1);
00763                         
00764                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a43">TCP_STATE_RESERVED</a>:
00765                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>:
00766                         <span class="keywordflow">return</span>(sochandle);
00767                 
00768                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>:
00769                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>:
00770                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
00771                         <span class="keywordflow">return</span>(sochandle);
00772                 
00773                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a47">TCP_STATE_SYN_SENT</a>:
00774                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a46">TCP_STATE_SYN_RECEIVED</a>:
00775                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>:
00776                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>:
00777                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a49">TCP_STATE_FINW2</a>:
00778                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a50">TCP_STATE_CLOSING</a>:
00779                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a51">TCP_STATE_LAST_ACK</a>:
00780                 
00781                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_RESET;
00782                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
00783                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
00784                         <span class="keywordflow">return</span>(sochandle);
00785                         
00786                 <span class="keywordflow">default</span>:
00787                         <span class="keywordflow">return</span>(-1);
00788         }
00789         
00790 
00791 }
00792 
00793 
00794 
<a name="l00808"></a><a class="code" href="tcp_8c.html#a12">00808</a> <span class="keywordtype">void</span> <a class="code" href="group__periodic__functions.html#a4">tcp_poll</a> (<span class="keywordtype">void</span>)
00809 {
00810         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
00811         <span class="keyword">static</span> UINT8 handle = 0;
00812         UINT8 i;
00813         INT32 temp;
00814         UINT8 old_retries;
00815         
00816         <span class="keywordflow">for</span>(i=0; i &lt; NO_OF_TCPSOCKETS; i++ ) {
00817                 
00818                 <span class="keywordflow">if</span>(handle &gt; NO_OF_TCPSOCKETS)
00819                         handle = 0;
00820 
00821                 soc = &amp;tcp_socket[handle];
00822                 
00823                 <span class="keywordflow">switch</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a>) {
00824                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a42">TCP_STATE_FREE</a>:
00825                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a43">TCP_STATE_RESERVED</a>:
00826                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>:
00827                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>:
00828                                 
00829                                 <span class="keywordflow">break</span>;
00830                                 
00831                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>:
00832                         
00833                                 <span class="comment">/* In CONNECTED State we have                                   */</span> 
00834                                 <span class="comment">/* something to do only if we have unacked data */</span>
00835                                 <span class="comment">/* or if connection has been IDLE too long or   */</span>
00836                                 <span class="comment">/* unserved close is isuued by user                             */</span>
00837                                 
00838                                 <span class="comment">/*if(soc-&gt;send_next &gt; soc-&gt;send_unacked)</span>
00839 <span class="comment">                                        temp = soc-&gt;send_next - soc-&gt;send_unacked;</span>
00840 <span class="comment">                                else</span>
00841 <span class="comment">                                        temp = soc-&gt;send_unacked - soc-&gt;send_next;</span>
00842 <span class="comment">                                */</span>
00843                                 
00844                                 temp = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> - soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a>;
00845                                 
00846                                 <span class="comment">/* Unserved Close?                      */</span>
00847                                 
00848                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> &amp; TCP_INTFLAGS_CLOSEPENDING) {
00849                                         <span class="comment">/* Can we send the close now    */</span>
00850                                         
00851                                         <span class="keywordflow">if</span>(temp == 0) {
00852                                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK | TCP_FLAG_FIN;
00853                                                 soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>++;
00854                                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
00855                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>);     
00856                                                 soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> ^= TCP_INTFLAGS_CLOSEPENDING;
00857                                                 
00858                                                 handle++;
00859                                                 
00860                                                 <span class="keywordflow">return</span>;         
00861                                                 
00862                                         }
00863                                 }
00864                                 
00865                                 <span class="comment">/* Socket timeout?                      */</span>
00866                                 
00867                                 <span class="keywordflow">if</span>(<a class="code" href="timers_8c.html#a7">check_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m13">persist_timerh</a>) == 0) {
00868                                 
00869                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK | TCP_FLAG_FIN;
00870                                         soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>++;
00871                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
00872                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>);     
00873                                         
00874                                         <span class="comment">/* Inform application   */</span>
00875                                         
00876                                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(handle, <a class="code" href="tcp__ip_8h.html#a56">TCP_EVENT_CLOSE</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
00877                                         
00878                                         handle++;
00879                 
00880                                         <span class="keywordflow">return</span>;                 
00881                                 }       
00882                                 
00883                                 <span class="comment">/* Is there unacked data?       */</span>
00884                                 
00885                                 <span class="keywordflow">if</span>(temp == 0)
00886                                         <span class="keywordflow">break</span>;
00887                                 
00888                                 <span class="comment">/* Is there timeout?                                    */</span>
00889                                 
00890                                 <span class="keywordflow">if</span>( <a class="code" href="timers_8c.html#a7">check_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>) != 0 )
00891                                         <span class="keywordflow">break</span>;
00892                                 
00893                                 <span class="comment">/* De we have retries left                              */</span>
00894                                 
00895                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> == 0) {
00896                                         <span class="comment">/* No retries, must reset       */</span>
00897                                         
00898                                         TCP_DEBUGOUT(<span class="stringliteral">"Retries used up, resetting\r\n"</span>);
00899                                         
00900                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_RESET;
00901                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
00902                                         
00903                                         <span class="comment">/* Inform application   */</span>
00904 
00905                                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(handle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
00906                                 
00907                                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a> )
00908                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
00909                                         <span class="keywordflow">else</span>
00910                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
00911                                         
00912                                         handle++;
00913                 
00914                                         <span class="keywordflow">return</span>;                                                                         
00915                                 }
00916                                 
00917                                 soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a>--;
00918                                 <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>, <a class="code" href="group__opentcp__config.html#a11">TCP_DEF_RETRY_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
00919                                                                 
00920                                 <span class="comment">/* Yep, there is unacked data                   */</span>
00921                                 <span class="comment">/* Application should send the old data */</span>
00922                                 
00923                                 <span class="keywordflow">if</span>(temp&gt;soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a>)
00924                                         temp = soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a>;
00925                                 
00926                                 <span class="comment">/* Rewind Send Next because the send process will adjust it                     */</span>
00927                                 <span class="comment">/* So cheat the tcp_send to think there is no unacked data                      */</span>
00928                                 
00929                                 soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> = soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a>;
00930                                 
00931                                 <span class="comment">/* tcp_send will set the retiries_left to maximum but this is           */</span>
00932                                 <span class="comment">/* retransmitting already so we need to retain it in order to           */</span>
00933                                 <span class="comment">/* avoid dead-lock                                                                                                      */</span>
00934                                 
00935                                 old_retries = soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a>;
00936                                 
00937                                 temp = soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(handle, <a class="code" href="tcp__ip_8h.html#a59">TCP_EVENT_REGENERATE</a>, (UINT32)temp, 0);
00938                         
00939                                 soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> = old_retries;
00940                         
00941                                 <span class="keywordflow">if</span>(temp &lt;= 0) {
00942                                         
00943                                         <span class="comment">/* No data by application, must be something wrong      */</span>
00944                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_RESET;
00945                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
00946                                         
00947                                         <span class="comment">/* Inform application   */</span>
00948 
00949                                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(handle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
00950                                                                         
00951                                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a> )
00952                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
00953                                         <span class="keywordflow">else</span>
00954                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
00955                                         
00956                                         handle++;
00957                 
00958                                         <span class="keywordflow">return</span>;                                 
00959                                         
00960                                 }
00961                                 
00962                                 <span class="comment">/* Application has send data    */</span>
00963                                 
00964                                 handle++;
00965                 
00966                                 <span class="keywordflow">return</span>;
00967                                 
00968                         
00969                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a47">TCP_STATE_SYN_SENT</a>:
00970                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a46">TCP_STATE_SYN_RECEIVED</a>:
00971                         
00972                                 <span class="comment">/* Is there timeout?    */</span>
00973                                 <span class="keywordflow">if</span>( <a class="code" href="timers_8c.html#a7">check_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>) != 0 )
00974                                         <span class="keywordflow">break</span>;
00975                                         
00976                                 TCP_DEBUGOUT(<span class="stringliteral">"Timeout\r\n"</span>);
00977                                         
00978                                 <span class="comment">/* Yep, timeout. Is there reties left?  */</span>
00979                                 <span class="keywordflow">if</span>( soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> ) {
00980                                         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a>--;
00981                                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a> == <a class="code" href="tcp__ip_8h.html#a47">TCP_STATE_SYN_SENT</a>)
00982                                                 <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>, <a class="code" href="group__opentcp__config.html#a13">TCP_SYN_RETRY_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
00983                                         <span class="keywordflow">else</span>
00984                                                 <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>, <a class="code" href="group__opentcp__config.html#a11">TCP_DEF_RETRY_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
00985 
00986                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
00987                                         
00988                                         handle++;
00989                 
00990                                         <span class="keywordflow">return</span>;                         
00991                                 } <span class="keywordflow">else</span> {
00992                                         <span class="comment">/* Retries used up      */</span>
00993                                         TCP_DEBUGOUT(<span class="stringliteral">"Retries used up, resetting\r\n"</span>);
00994                                         
00995                                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a> )
00996                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
00997                                         <span class="keywordflow">else</span>
00998                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
00999                                         
01000                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_RESET;
01001                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
01002                                         
01003                                         <span class="comment">/* Inform application   */</span>
01004 
01005                                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(handle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01006                                         
01007                                         handle++;
01008                 
01009                                         <span class="keywordflow">return</span>;
01010                                 }
01011                                 
01012                                 <span class="keywordflow">break</span>;
01013                                 
01014                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>:
01015                                 
01016                                 <span class="comment">/* Is there timeout?    */</span>
01017                                 
01018                                 <span class="keywordflow">if</span>( <a class="code" href="timers_8c.html#a7">check_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>) != 0 )
01019                                         <span class="keywordflow">break</span>;
01020                                         
01021                                 TCP_DEBUGOUT(<span class="stringliteral">"Timeout\r\n"</span>);
01022                                 
01023                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a>) {
01024                                         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a>--;
01025                                         <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>, <a class="code" href="group__opentcp__config.html#a11">TCP_DEF_RETRY_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
01026                                         <span class="keywordflow">break</span>;
01027                                 }
01028                                 
01029                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a> )
01030                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01031                                 <span class="keywordflow">else</span>
01032                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01033                                         
01034                                 <span class="keywordflow">break</span>;
01035                         
01036                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a51">TCP_STATE_LAST_ACK</a>:
01037                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>:
01038                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a50">TCP_STATE_CLOSING</a>:
01039                         
01040                                 <span class="comment">/* Is there timeout?    */</span>
01041                                 
01042                                 <span class="keywordflow">if</span>( <a class="code" href="timers_8c.html#a7">check_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>) != 0 )
01043                                         <span class="keywordflow">break</span>;
01044                                         
01045                                 TCP_DEBUGOUT(<span class="stringliteral">"Timeout\r\n"</span>);            
01046                                                 
01047                                 <span class="comment">/* Yep, timeout. Is there reties left?  */</span>
01048                                 
01049                                 <span class="keywordflow">if</span>( soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> ) {
01050                                         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a>--;
01051                                         <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>, <a class="code" href="group__opentcp__config.html#a11">TCP_DEF_RETRY_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
01052                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_FIN | TCP_FLAG_ACK;
01053                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
01054                                         
01055                                         handle++;
01056                 
01057 
01058                                         <span class="keywordflow">return</span>;                         
01059                                 } <span class="keywordflow">else</span> {
01060                                         <span class="comment">/* Retries used up      */</span>
01061                                         TCP_DEBUGOUT(<span class="stringliteral">"Retries used up, resetting\r\n"</span>);
01062                                         
01063                                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a> )
01064                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01065                                         <span class="keywordflow">else</span>
01066                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01067                                         
01068                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_RESET;
01069                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
01070                                         
01071                                         <span class="comment">/* Inform application   */</span>
01072 
01073                                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(handle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01074                                         
01075                                         handle++;
01076                 
01077                                         <span class="keywordflow">return</span>;
01078                                 }                       
01079                                 
01080                                 <span class="keywordflow">break</span>;
01081                         
01082                         <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a49">TCP_STATE_FINW2</a>:
01083                         
01084                                 <span class="comment">/* Is there timeout?    */</span>
01085                                 
01086                                 <span class="keywordflow">if</span>( <a class="code" href="timers_8c.html#a7">check_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>) != 0 )
01087                                         <span class="keywordflow">break</span>;
01088                                         
01089                                 TCP_DEBUGOUT(<span class="stringliteral">"Timeout\r\n"</span>);            
01090                                                 
01091                                 <span class="comment">/* Yep, timeout. Is there reties left?  */</span>
01092                                 
01093                                 <span class="keywordflow">if</span>( soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> ) {
01094                                         <span class="comment">/* Still keep waiting for FIN   */</span>
01095                                 
01096                                         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a>--;
01097                                         <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>, <a class="code" href="group__opentcp__config.html#a11">TCP_DEF_RETRY_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
01098                                         <span class="keywordflow">break</span>;                  
01099                                 } <span class="keywordflow">else</span> {
01100                                         <span class="comment">/* Retries used up      */</span>
01101                                         TCP_DEBUGOUT(<span class="stringliteral">"Retries used up, resetting\r\n"</span>);
01102                                         
01103                                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a> )
01104                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01105                                         <span class="keywordflow">else</span>
01106                                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01107                                         
01108                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_RESET;
01109                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(handle);
01110                                         
01111                                         <span class="comment">/* Inform application   */</span>
01112 
01113                                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(handle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01114                                 
01115                                         handle++;
01116                 
01117                                         <span class="keywordflow">return</span>;
01118                                 }       
01119                                 
01120                                 <span class="keywordflow">break</span>;
01121                         
01122                         <span class="keywordflow">default</span>:
01123                                 <span class="keywordflow">break</span>;  
01124                         
01125                 }
01126                 
01127                 <span class="comment">/* Go to next socket if there was no event      */</span>
01128                 
01129                 handle++;
01130                 
01131         }
01132         
01133 }
01134 
01135 
01136 
<a name="l01154"></a><a class="code" href="tcp_8c.html#a13">01154</a> INT8 <a class="code" href="group__core__initializer.html#a2">tcp_init</a> (<span class="keywordtype">void</span>)
01155 {
01156         UINT16 i;
01157         INT16 h;
01158         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
01159         
01160         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS &lt; 0 )
01161                 <span class="keywordflow">return</span>(-1);
01162         
01163         <span class="keywordflow">if</span>( NO_OF_TCPSOCKETS == 0 )
01164                 <span class="keywordflow">return</span>(0);
01165         
01166         TCP_DEBUGOUT(<span class="stringliteral">"Initializing TCP"</span>);
01167         
01168         <span class="keywordflow">for</span>(i=0; i &lt; NO_OF_TCPSOCKETS; i++) {
01169                 soc = &amp;tcp_socket[i];                   <span class="comment">/* Get Socket   */</span>
01170                 h = -1;
01171                 
01172                 soc-&gt;<a class="code" href="structtcb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a42">TCP_STATE_FREE</a>;
01173                 soc-&gt;<a class="code" href="structtcb.html#m1">type</a> = <a class="code" href="tcp__ip_8h.html#a38">TCP_TYPE_NONE</a>;
01174                 soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> = 0;
01175                 soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> = 0;
01176                 soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> = 0;
01177                 soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> = 0;
01178                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = 0;
01179                 soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a> = TCP_DEF_MTU;
01180                 soc-&gt;<a class="code" href="structtcb.html#m11">tos</a> = 0;
01181                 soc-&gt;<a class="code" href="structtcb.html#m10">tout</a> = 0;
01182                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a> = 0;
01183                 
01184                 <span class="comment">/* Reserve Timers       */</span>
01185                 
01186                 h = <a class="code" href="timers_8c.html#a2">get_timer</a>();
01187                 
01188                 <span class="comment">/*</span>
01189 <span class="comment">                if( h &lt; 0 ) {</span>
01190 <span class="comment">                        TCP_DEBUGOUT("\n\rERROR:Error getting timer for TCP Socket!\n\r");</span>
01191 <span class="comment">                        return(-1);</span>
01192 <span class="comment">                }</span>
01193 <span class="comment">                */</span>
01194                 
01195                 <a class="code" href="timers_8c.html#a6">init_timer</a>(h,0);                                        <span class="comment">/* No timeout   */</span>
01196                 
01197                 soc-&gt;<a class="code" href="structtcb.html#m13">persist_timerh</a> = h;
01198                 
01199                 h = <a class="code" href="timers_8c.html#a2">get_timer</a>();
01200                 
01201                 <span class="comment">/*</span>
01202 <span class="comment">                if( h &lt; 0 ) {</span>
01203 <span class="comment">                        TCP_DEBUGOUT("\n\rERROR:Error getting timer for TCP Socket!\n\r");</span>
01204 <span class="comment">                        return(-1);</span>
01205 <span class="comment">                }</span>
01206 <span class="comment">                */</span>
01207                 
01208                 <a class="code" href="timers_8c.html#a6">init_timer</a>(h,0);                                        <span class="comment">/* No timeout   */</span>
01209                 
01210                 soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a> = h;
01211                 
01212                 soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> = 0;           
01213                 
01214                 TCP_DEBUGOUT(<span class="stringliteral">"."</span>);
01215                 
01216         
01217         }
01218         
01219         TCP_DEBUGOUT(<span class="stringliteral">"\n\rTCP Initialized\n\r"</span>);
01220         
01221         <span class="comment">/* Return number of sockets initialized */</span>
01222         
01223         <span class="keywordflow">return</span>(i+1);
01224         
01225 
01226 }
01227 
01228 
01229 
01230 
01231 <span class="comment">/*******************************************************************************/</span>
01232 <span class="comment">/*******        TCP Internal functions                                                                          ********/</span>
01233 <span class="comment">/*******************************************************************************/</span>
01234 
01235 
<a name="l01250"></a><a class="code" href="tcp_8c.html#a14">01250</a> INT16 <a class="code" href="tcp_8c.html#a14">process_tcp_in</a> (<span class="keyword">struct</span> <a class="code" href="structip__frame.html">ip_frame</a>* frame, UINT16 len)
01251 {
01252         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
01253         UINT16 hlen;
01254         UINT8 olen;
01255         UINT16 dlen;
01256         UINT32 diff;
01257         UINT16 i;
01258         INT8 sochandle; 
01259         INT16 temp;
01260         
01261         <span class="comment">/* Is this TCP? */</span>
01262         
01263         TCP_DEBUGOUT(<span class="stringliteral">"Processing TCP...\n\r"</span>);
01264         
01265         <span class="keywordflow">if</span>( frame-&gt;<a class="code" href="structip__frame.html#m6">protocol</a> != <a class="code" href="ip_8h.html#a3">IP_TCP</a> ) {
01266                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR: The protocol is not TCP\n\r"</span>);
01267                 <span class="keywordflow">return</span>(-1);
01268         }
01269         
01270         <span class="comment">/* Calculate checksum for received packet       */</span>
01271 
01272         
01273         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(frame-&gt;<a class="code" href="structip__frame.html#m11">buf_index</a>);
01274         
01275         <span class="keywordflow">if</span>( <a class="code" href="tcp_8c.html#a22">tcp_check_cs</a>(frame, len) == 1) {
01276                 TCP_DEBUGOUT(<span class="stringliteral">"TCP Checksum OK\n\r"</span>);
01277         } <span class="keywordflow">else</span> {
01278                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:TCP Checksum failed\r\n"</span>);
01279                 <span class="keywordflow">return</span>(-1);
01280         } 
01281 
01282         <span class="comment">/* Get the header       */</span>
01283         
01284         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(frame-&gt;<a class="code" href="structip__frame.html#m11">buf_index</a>);
01285         
01286         received_tcp_packet.<a class="code" href="structtcp__frame.html#m0">sport</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
01287         received_tcp_packet.<a class="code" href="structtcp__frame.html#m0">sport</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01288         
01289         received_tcp_packet.<a class="code" href="structtcp__frame.html#m1">dport</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
01290         received_tcp_packet.<a class="code" href="structtcp__frame.html#m1">dport</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01291         
01292         received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a> = (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 24);
01293         received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a> |= (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 16);
01294         received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a> |= (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8);
01295         received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01296         
01297         received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> = (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 24);
01298         received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> |= (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 16);
01299         received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> |= (((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8);
01300         received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01301 
01302         received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
01303         received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01304         
01305         received_tcp_packet.<a class="code" href="structtcp__frame.html#m5">window</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
01306         received_tcp_packet.<a class="code" href="structtcp__frame.html#m5">window</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01307         
01308         received_tcp_packet.<a class="code" href="structtcp__frame.html#m6">checksum</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
01309         received_tcp_packet.<a class="code" href="structtcp__frame.html#m6">checksum</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01310         
01311         received_tcp_packet.<a class="code" href="structtcp__frame.html#m7">urgent</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
01312         received_tcp_packet.<a class="code" href="structtcp__frame.html#m7">urgent</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01313         
01314         <span class="comment">/* Little check for options     */</span>
01315         
01316         hlen = received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; 0xF000;
01317         hlen &gt;&gt;= 10;
01318         
01319         <span class="keywordflow">if</span>( hlen &lt; MIN_TCP_HLEN ) {
01320                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR: Received TCP Header too short\r\n"</span>);
01321                 <span class="keywordflow">return</span>(-1);
01322         }
01323         
01324         <span class="keywordflow">if</span>(hlen == MIN_TCP_HLEN)
01325                 TCP_DEBUGOUT(<span class="stringliteral">"TCP does not contain options\r\n"</span>);
01326         
01327         olen = hlen - MIN_TCP_HLEN;
01328         
01329         <span class="keywordflow">if</span>( olen &gt; MAX_TCP_OPTLEN ) {
01330                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR: Received TCP header contains too long option field\r\n"</span>);
01331                 <span class="keywordflow">return</span>(-1);
01332         }
01333         
01334         <span class="comment">/* Calculate data length        */</span>
01335         
01336         <span class="keywordflow">if</span>( hlen &gt; len ) {
01337                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR: TCP header longer than packet\r\n"</span>);
01338                 <span class="keywordflow">return</span>(-1);
01339         }
01340         
01341         dlen = len - hlen - olen;
01342         
01343         <span class="comment">/* Get options (if any) */</span>
01344         
01345         <span class="keywordflow">for</span>(i=0; i&lt;olen;i++)
01346                 received_tcp_packet.<a class="code" href="structtcp__frame.html#m8">opt</a>[i] = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
01347                 
01348         <span class="comment">/* Try to find rigth socket to process with             */</span>
01349         
01350         sochandle = <a class="code" href="tcp_8c.html#a19">tcp_mapsocket</a>(frame, &amp;received_tcp_packet);
01351         
01352         <span class="keywordflow">if</span>(sochandle &lt; 0) {
01353                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR: Processing TCP packet failed\r\n"</span>);
01354                 <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
01355                 <span class="keywordflow">return</span>(-1);
01356         }
01357         
01358         received_tcp_packet.<a class="code" href="structtcp__frame.html#m9">buf_index</a> = frame-&gt;<a class="code" href="structip__frame.html#m11">buf_index</a> + hlen;
01359         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m9">buf_index</a>);
01360         
01361         
01362         
01363         <span class="comment">/* Get socket reference */</span>
01364         
01365         soc = &amp;tcp_socket[sochandle];
01366         
01367         <span class="comment">/* Process the packet on TCP State Machine              */</span>
01368         
01369         <span class="keywordflow">switch</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a>) {
01370                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>:
01371                 
01372                         TCP_DEBUGOUT(<span class="stringliteral">"CONNECTED State\r\n"</span>);
01373                         
01374                         <span class="comment">/* Check for RESET      */</span>
01375                         
01376                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET)     {
01377                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
01378 
01379                                 <span class="comment">/* Inform application   */</span>
01380 
01381                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);                             
01382                                 
01383                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
01384                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01385                                 <span class="keywordflow">else</span>
01386                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01387                                         
01388                                 <span class="keywordflow">return</span>(-1);
01389                         }
01390                         
01391                         <span class="comment">/* Check for SYN (If the peer didn't get our SYN+ACK or ACK)    */</span>
01392                         
01393                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_SYN )     {
01394                                 <span class="comment">/* Is it the SYN+ACK we have already ACKed but maybe ACK lost?  */</span>
01395                                 
01396                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK )     {
01397                                         <span class="comment">/* It's SYN+ACK but how about sequence  */</span>
01398                                         
01399                                         <span class="keywordflow">if</span>( (received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a> + 1) == soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> ) {
01400                                         
01401                                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> == soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01402                                                 
01403                                                         TCP_DEBUGOUT(<span class="stringliteral">"Received SYN+ACK again\r\n"</span>);
01404                                                         
01405                                                         <span class="comment">/* ACK the SYN  */</span>
01406                                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01407                                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01408                                                         <span class="keywordflow">return</span>(0);
01409                                                 }
01410                                                 
01411                                         }
01412                                 
01413                                  <span class="comment">/* It is maybe SYN again so it haven't get our SYN + ACK       */</span>
01414                                  <span class="comment">/* Let our retransmission handle it                                            */</span>
01415                                  
01416                                  <span class="keywordflow">return</span>(0);
01417                                 
01418                                 
01419                                 }
01420                         
01421                         }
01422                         
01423                         <span class="comment">/* Do we have unacked data?             */</span>
01424                         
01425                         <span class="keywordflow">if</span>( soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01426                         
01427                                 <span class="comment">/* Yep, is the ACK valid?       */</span>
01428                                 
01429                                 <span class="keywordflow">if</span>( (received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK) == 0) {
01430                                 
01431                                         TCP_DEBUGOUT(<span class="stringliteral">"Packet without ACK and unacked data. Packet not processed\r\n"</span>);
01432                                         <span class="keywordflow">return</span>(0);
01433                                 }
01434                                 
01435                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> == soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01436                                 
01437                                         <span class="comment">/* We don't have unacked data now       */</span>
01438                                 
01439                                         soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>;
01440                                 
01441                                         <span class="comment">/* Inform application   */</span>
01442                                 
01443                                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a58">TCP_EVENT_ACK</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01444                                 
01445                                 }
01446 
01447                         
01448                         }
01449                         
01450                         <span class="comment">/* Is the sequence OK   */</span>
01451                         
01452                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> != received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>)
01453                         {
01454                                 <span class="comment">/* Out of range, inform what we except  */</span>
01455                         
01456                                 DEBUGOUT(<span class="stringliteral">"Too big sequence number received\r\n"</span>);
01457                                 
01458                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01459                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01460                                 <span class="keywordflow">return</span>(0);
01461                         }
01462                         
01463                         <span class="comment">/* Generate data event to application   */</span>
01464                                 
01465                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a60">TCP_EVENT_DATA</a>, dlen, 0);
01466                                 
01467                         soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> += dlen;                      
01468                                         
01469                         <span class="comment">/* Is the FIN flag set? */</span>
01470                         
01471                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_FIN )     {
01472                                 TCP_DEBUGOUT(<span class="stringliteral">"Other end want's to close\r\n"</span>);
01473                                 
01474                                 <span class="comment">/* Inform application if we don't have unacked data     */</span>
01475                                 
01476                                 <span class="keywordflow">if</span>( soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> == soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>) {
01477                                 
01478                                         soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a56">TCP_EVENT_CLOSE</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01479                                 
01480                                         <span class="comment">/* ACK FIN and set our own FIN  */</span>
01481                                 
01482                                         soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;
01483                                         soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>++;
01484                                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK | TCP_FLAG_FIN;
01485                                 
01486                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a51">TCP_STATE_LAST_ACK</a>);
01487                                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01488                                 
01489                                         <span class="keywordflow">return</span>(0);
01490                                 }
01491                         }
01492                         
01493                         <span class="comment">/* ACK the data if there was it */</span>
01494                         
01495                         <span class="keywordflow">if</span>(dlen) {
01496                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01497                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01498                         }
01499                         
01500                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>);                 
01501                         
01502 
01503                         <span class="keywordflow">return</span>(0);
01504                         
01505                 
01506                         <span class="keywordflow">break</span>;
01507         
01508                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a42">TCP_STATE_FREE</a>:
01509                         
01510                         <span class="comment">/* Reset connection     */</span>
01511                         <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
01512                         <span class="keywordflow">return</span>(-1);
01513                 
01514                         <span class="keywordflow">break</span>;
01515                 
01516                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>:
01517                         
01518                         <span class="comment">/* Reset connection     */</span>
01519                         <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
01520                         <span class="keywordflow">return</span>(-1);             
01521                 
01522                         <span class="keywordflow">break</span>;
01523                 
01524                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>:
01525                 
01526                         TCP_DEBUGOUT(<span class="stringliteral">"LISTENING State...\r\n"</span>);
01527                 
01528                         <span class="comment">/* Check Flags  */</span>
01529                         
01530                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET) {
01531                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
01532                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01533                                 <span class="keywordflow">return</span>(-1);
01534                         }
01535                         
01536                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK) {
01537                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Ack received\r\n"</span>);
01538                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01539                                 <span class="comment">/* Reset connection     */</span>
01540                                 <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
01541                                 <span class="keywordflow">return</span>(-1);     
01542                         }
01543                         
01544                         <span class="keywordflow">if</span>((received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_SYN) == 0) {
01545                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:No SYN set on packet\r\n"</span>);
01546                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01547                                 <span class="comment">/* Reset connection     */</span>
01548                                 <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
01549                                 <span class="keywordflow">return</span>(-1);
01550                         }
01551                         
01552                         <span class="comment">/* OK, SYN received     */</span>
01553                         
01554                         <span class="comment">/* Inform application and see if accepted       */</span>
01555                         
01556                         temp = (INT16)soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a54">TCP_EVENT_CONREQ</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01557                         
01558                         <span class="keywordflow">if</span>( temp == -1) {
01559                                 TCP_DEBUGOUT(<span class="stringliteral">"Application disregarded connection request\r\n"</span>);
01560                                 <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
01561                                 <span class="keywordflow">return</span>(-1);
01562                         }
01563                         
01564                         <span class="keywordflow">if</span>( temp == -2 ) {
01565                                 TCP_DEBUGOUT(<span class="stringliteral">"Application wants to think about accepting conreq\r\n"</span>);
01566                                 <span class="keywordflow">return</span>(1);
01567                         }
01568                         
01569                         <span class="comment">/* The connection request was accepted  */</span>
01570                         
01571                         TCP_DEBUGOUT(<span class="stringliteral">"Next state SYN_RECEIVED\r\n"</span>);
01572                         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> &amp; TCP_INTFLAGS_CLOSEPENDING)
01573                                 soc-&gt;<a class="code" href="structtcb.html#m2">flags</a> ^= TCP_INTFLAGS_CLOSEPENDING;
01574                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a46">TCP_STATE_SYN_RECEIVED</a>);
01575                         soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a> + 1;      <span class="comment">/* Ack SYN              */</span>
01576                         soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = <a class="code" href="tcp_8c.html#a79">tcp_initseq</a>();
01577                         
01578                         soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_SYN | TCP_FLAG_ACK;
01579                         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01580                         soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> = soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> + 1;
01581                         
01582                         <span class="keywordflow">return</span>(1);
01583                         
01584                         <span class="keywordflow">break</span>;
01585                         
01586                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a46">TCP_STATE_SYN_RECEIVED</a>:
01587                 
01588                         TCP_DEBUGOUT(<span class="stringliteral">"SYN_RECEIVED State...\r\n"</span>);
01589                         
01590                         <span class="comment">/* Check Flags  */</span>
01591                         
01592                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET)     {
01593                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
01594                                 
01595                                 <span class="comment">/* Inform application   */</span>
01596                                 
01597                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01598                                 
01599                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
01600                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01601                                 <span class="keywordflow">else</span>
01602                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01603                                         
01604                                 <span class="keywordflow">return</span>(-1);
01605                         }
01606                         
01607                         <span class="comment">/* Is it SYN+ACK (if we are the because of simultaneous open)   */</span>
01608                         
01609                         <span class="keywordflow">if</span>( (received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_SYN) &amp;&amp;
01610                                 (received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK) ) {                     
01611                                 
01612                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01613                                         TCP_DEBUGOUT(<span class="stringliteral">"SYN+ACK received but wrong Ack\n\r"</span>);
01614                                         <span class="keywordflow">return</span>(-1);
01615                                 }
01616                                 
01617                                 TCP_DEBUGOUT(<span class="stringliteral">"SYN+ACK received, this side established\n\r"</span>);
01618                                 
01619                                 <span class="comment">/* Get peer's seq number        */</span>
01620                                 
01621                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> =  received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
01622                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;                                                    <span class="comment">/* ACK SYN      */</span>
01623                                 
01624                                 <span class="comment">/* We have no unacked data      */</span>
01625                                 
01626                                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>;
01627                                 
01628                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>);
01629                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01630                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01631                                 
01632                                 <span class="comment">/* Inform application   */</span>
01633                                 
01634                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a55">TCP_EVENT_CONNECTED</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01635                                 
01636                                 <span class="keywordflow">return</span>(0);                                      
01637                                                                 
01638                         }
01639                         
01640                         <span class="comment">/* Is it ACK?           */</span>
01641                         
01642                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK )     {
01643                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01644                                         TCP_DEBUGOUT(<span class="stringliteral">"ACK received but wrong Ack\n\r"</span>);
01645                                         <span class="keywordflow">return</span>(-1);
01646                                 }
01647                                 
01648                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a> != soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> ) {
01649                                         TCP_DEBUGOUT(<span class="stringliteral">"ACK received but Wrong SEQ number\n\r"</span>);
01650                                         <span class="keywordflow">return</span>(-1);
01651                                 }
01652                                 
01653                                 TCP_DEBUGOUT(<span class="stringliteral">"ACK received, this side CONNECTED\r\n"</span>);
01654                                 
01655                                 <span class="comment">/* We have no unacked data      */</span>
01656                                 
01657                                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>;
01658                                 
01659                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>);
01660 
01661                                 <span class="comment">/* Inform application   */</span>
01662                                 
01663                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a55">TCP_EVENT_CONNECTED</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01664                                                                 
01665                                 <span class="keywordflow">return</span>(0);
01666                                         
01667                         }
01668                         
01669                         <span class="comment">/* Is it SYN?           */</span>
01670                         
01671                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_SYN ) {
01672                                 TCP_DEBUGOUT(<span class="stringliteral">"Repeated SYN\r\n"</span>);
01673                                 <span class="keywordflow">return</span>(0);
01674                         }
01675                         
01676                         <span class="comment">/* We didn't understood this one, keep on trying but info with RESET    */</span>
01677                         
01678                         TCP_DEBUGOUT(<span class="stringliteral">"Unrecognized packet\n\r"</span>);
01679                         
01680                         <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
01681                         
01682                         <span class="keywordflow">return</span>(-1);
01683                         
01684                         <span class="keywordflow">break</span>;
01685                         
01686                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a47">TCP_STATE_SYN_SENT</a>:
01687                 
01688                         TCP_DEBUGOUT(<span class="stringliteral">"SYN_SENT State\r\n"</span>);
01689                         
01690                         <span class="comment">/* Check for RESET      */</span>
01691                         
01692                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET) {
01693                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
01694                                 
01695                                 <span class="comment">/* Inform application   */</span>
01696 
01697                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01698                                                                 
01699                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
01700                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01701                                 <span class="keywordflow">else</span>
01702                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01703                                         
01704                                 <span class="keywordflow">return</span>(-1);
01705                         }
01706                         
01707                         <span class="comment">/* Is it SYN+ACK?       */</span>
01708                         
01709                         <span class="keywordflow">if</span>( (received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_SYN) &amp;&amp;
01710                                 (received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK) ) {
01711                                 <span class="comment">/* Rigth ACK?   */</span>
01712                                 
01713                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01714                                         TCP_DEBUGOUT(<span class="stringliteral">"SYN+ACK received but wrong Ack\n\r"</span>);
01715                                         <span class="keywordflow">return</span>(-1);
01716                                 }
01717                                 
01718                                 TCP_DEBUGOUT(<span class="stringliteral">"SYN+ACK received, this side established\n\r"</span>);
01719                                 
01720                                 <span class="comment">/* Get peer's seq number        */</span>
01721                                 
01722                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> =  received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
01723                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;                                                    <span class="comment">/* ACK SYN      */</span>
01724                                 
01725                                 <span class="comment">/* We have no unacked data      */</span>
01726                                 
01727                                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>;
01728                                 
01729                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>);
01730                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01731                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01732                                 
01733                                 <span class="comment">/* Inform application   */</span>
01734 
01735                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a55">TCP_EVENT_CONNECTED</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01736                                                                 
01737                                 <span class="keywordflow">return</span>(0);                      
01738                                 
01739                         }
01740                         
01741                         <span class="comment">/* Is it SYN (simultaneous open)        */</span>
01742                         
01743                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_SYN) {
01744                                 TCP_DEBUGOUT(<span class="stringliteral">"Simultaneous open, next SYN_RECEIVED\r\n"</span>);
01745                         
01746                                 <span class="comment">/* Get peer's seq number        */</span>
01747                                 
01748                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> =  received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
01749                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;                                                    <span class="comment">/* ACK SYN      */</span>                              
01750                                 
01751                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a46">TCP_STATE_SYN_RECEIVED</a>);
01752                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_SYN | TCP_FLAG_ACK;
01753                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01754                                 
01755                                 <span class="keywordflow">return</span>(0);
01756                         
01757                         }
01758                         
01759                         <span class="comment">/* This is something we didn't understood, maybe the other peer has     */</span>
01760                         <span class="comment">/* still old connection on or something                                                         */</span>
01761                         TCP_DEBUGOUT(<span class="stringliteral">"TCP packet out of nowhere received...\r\n"</span>);
01762                         <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
01763                         
01764                         <span class="keywordflow">return</span>(-1);
01765                 
01766                         <span class="keywordflow">break</span>;
01767                 
01768                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>:
01769                 
01770                         TCP_DEBUGOUT(<span class="stringliteral">"FINW1 State\r\n"</span>);
01771                         
01772                         <span class="comment">/* Check for RESET      */</span>
01773                         
01774                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET) {
01775                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
01776                                 
01777                                 <span class="comment">/* Inform application   */</span>
01778 
01779                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);
01780                                                                 
01781                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
01782                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01783                                 <span class="keywordflow">else</span>
01784                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01785                                         
01786                                 <span class="keywordflow">return</span>(-1);
01787                         }
01788                         
01789                         <span class="comment">/* Is it FIN+ACK?                       */</span>
01790                         
01791                         <span class="keywordflow">if</span>( (received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_FIN) &amp;&amp;
01792                                 (received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK) ) {
01793                                 <span class="comment">/* Rigth ACK?   */</span>
01794                                 
01795                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01796                                         TCP_DEBUGOUT(<span class="stringliteral">"FIN+ACK received but wrong Ack\n\r"</span>);
01797                                         <span class="keywordflow">return</span>(-1);
01798                                 }
01799                                 
01800                                 TCP_DEBUGOUT(<span class="stringliteral">"FIN+ACK received, next TIMED_WAIT\n\r"</span>);
01801                                 
01802                                 <span class="comment">/* ACK FIN and all data */</span>
01803                                 
01804                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
01805                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;
01806                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> += dlen;
01807                                 
01808                                 <span class="comment">/* We have no unacked data      */</span>
01809                                 
01810                                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>;
01811                                 
01812                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>);
01813                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01814                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
01815                                                         
01816                                 <span class="keywordflow">return</span>(0);
01817                         
01818                         }
01819                         
01820                         <span class="comment">/* Is it just FIN       */</span>
01821                         
01822                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_FIN       ) {
01823                                 
01824                                 TCP_DEBUGOUT(<span class="stringliteral">"Simultaneous close, next CLOSING\n\r"</span>);
01825                                 
01826                                 <span class="comment">/* ACK FIN and all data */</span>
01827                                 
01828                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
01829                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;
01830                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> += dlen;
01831                                 
01832                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a50">TCP_STATE_CLOSING</a>);
01833                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01834                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);                     
01835                                 <span class="keywordflow">return</span>(0);
01836                         
01837                         }                       
01838                         
01839                         <span class="comment">/* Is it just ACK?      */</span>
01840                         
01841                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK       ) {
01842                                 <span class="comment">/* Rigth ACK?   */</span>
01843                                 
01844                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01845                                         TCP_DEBUGOUT(<span class="stringliteral">"ACK received but wrong Ack\n\r"</span>);
01846                                         <span class="keywordflow">return</span>(-1);
01847                                 }
01848                                 
01849                                 TCP_DEBUGOUT(<span class="stringliteral">"Our FIN is ACKed but peer don't agree to disconnect yet\r\n"</span>);
01850                                 TCP_DEBUGOUT(<span class="stringliteral">"Next FINW2\r\n"</span>);
01851                                 
01852                                 <span class="comment">/* We have no unacked data      */</span>
01853                                 
01854                                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>;
01855                                 
01856                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a49">TCP_STATE_FINW2</a>);
01857                                 
01858                                 <span class="keywordflow">return</span>(0);
01859                                                         
01860                         }
01861                                                 
01862                         <span class="keywordflow">break</span>;
01863                         
01864                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a49">TCP_STATE_FINW2</a>:
01865                 
01866                         TCP_DEBUGOUT(<span class="stringliteral">"FINW2 State\r\n"</span>);
01867                         
01868                         <span class="comment">/* Check for RESET      */</span>
01869                         
01870                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET) {
01871                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
01872                                 
01873                                 <span class="comment">/* Inform application   */</span>
01874 
01875                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);                             
01876                                 
01877                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
01878                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01879                                 <span class="keywordflow">else</span>
01880                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01881                                         
01882                                 <span class="keywordflow">return</span>(-1);
01883                         }                       
01884                 
01885                         <span class="comment">/* Do we finally get FIN?       */</span>
01886                 
01887                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_FIN       ) {
01888                                 
01889                                 TCP_DEBUGOUT(<span class="stringliteral">"FIN received, next TIMED_WAIT\n\r"</span>);
01890                                 
01891                                 <span class="comment">/* ACK FIN and all data */</span>
01892                                 
01893                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
01894                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;
01895                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> += dlen;
01896                                 
01897                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>);
01898                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01899                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);                     
01900                                 <span class="keywordflow">return</span>(0);
01901                         
01902                         }               
01903                 
01904                         <span class="keywordflow">break</span>;
01905                         
01906                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a50">TCP_STATE_CLOSING</a>:
01907                 
01908                         TCP_DEBUGOUT(<span class="stringliteral">"CLOSING State...\r\n"</span>);
01909                         
01910                         <span class="comment">/* Check for RESET      */</span>
01911                         
01912                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET)     {
01913                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
01914 
01915                                 <span class="comment">/* Inform application   */</span>
01916 
01917                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);                             
01918                                 
01919                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
01920                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01921                                 <span class="keywordflow">else</span>
01922                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01923                                         
01924                                 <span class="keywordflow">return</span>(-1);
01925                         }                       
01926                         
01927                         <span class="comment">/* Is it ACK?                   */</span>
01928                         
01929                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK       ) {
01930                                 <span class="comment">/* Rigth ACK?   */</span>
01931                                 
01932                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01933                                         TCP_DEBUGOUT(<span class="stringliteral">"ACK received but wrong Ack\n\r"</span>);
01934                                         <span class="keywordflow">return</span>(-1);
01935                                 }
01936                                 
01937                                 TCP_DEBUGOUT(<span class="stringliteral">"Our FIN is ACKed and peer wants to close too\r\n"</span>);
01938                                 TCP_DEBUGOUT(<span class="stringliteral">"Next TIMED_WAIT\r\n"</span>);
01939 
01940                                 <span class="comment">/* We have no unacked data      */</span>
01941                                 
01942                                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>;
01943                                 
01944                                 <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>);
01945                                 
01946                                 <span class="keywordflow">return</span>(0);
01947                                                         
01948                         }
01949         
01950                         <span class="comment">/* Is it repeated FIN?  */</span>
01951                         
01952                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_FIN       ) {
01953                                 
01954                                 TCP_DEBUGOUT(<span class="stringliteral">"Repeated FIN, repeat ACK\n\r"</span>);
01955                                 
01956                                 <span class="comment">/* ACK FIN and all data */</span>
01957                                 
01958                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
01959                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;
01960                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> += dlen;
01961                                 
01962                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
01963                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);                     
01964                         
01965                                 <span class="keywordflow">return</span>(0);
01966                         
01967                         }
01968 
01969                 
01970                         <span class="keywordflow">break</span>;
01971                 
01972                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a51">TCP_STATE_LAST_ACK</a>:
01973                 
01974                         TCP_DEBUGOUT(<span class="stringliteral">"LAST_ACK State...\r\n"</span>);
01975                         
01976                         <span class="comment">/* Check for RESET      */</span>
01977                         
01978                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET) {
01979                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
01980                                 
01981                                 <span class="comment">/* Inform application   */</span>
01982 
01983                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);                             
01984                                 
01985                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
01986                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
01987                                 <span class="keywordflow">else</span>
01988                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
01989                                         
01990                                 <span class="keywordflow">return</span>(-1);
01991                         }                       
01992                         
01993                         <span class="comment">/* Is it ACK?   */</span>
01994                         
01995                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK       ) {
01996                                 <span class="comment">/* Rigth ACK?   */</span>
01997                                 
01998                                 <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m3">ackno</a> != soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a> ) {
01999                                         TCP_DEBUGOUT(<span class="stringliteral">"ACK received but wrong Ack\n\r"</span>);
02000                                         <span class="keywordflow">return</span>(-1);
02001                                 }
02002                                 
02003                                 TCP_DEBUGOUT(<span class="stringliteral">"Last ACK received, next LISTENING or CLOSED\r\n"</span>);
02004                                 
02005                                 <span class="comment">/* We have no unacked data      */</span>
02006                                 
02007                                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = soc-&gt;<a class="code" href="structtcb.html#m8">send_next</a>;                             
02008                                 
02009                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
02010                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
02011                                 <span class="keywordflow">else</span>
02012                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
02013                                                                                                 
02014                                 <span class="keywordflow">return</span>(0);
02015                                                         
02016                         }                       
02017 
02018                         <span class="comment">/* Is it repeated FIN?  */</span>
02019                         
02020                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_FIN       ) {
02021                                 
02022                                 TCP_DEBUGOUT(<span class="stringliteral">"Repeated FIN, repeat ACK\n\r"</span>);
02023                                 
02024                                 <span class="comment">/* ACK FIN and all data */</span>
02025                                 
02026                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
02027                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;
02028                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> += dlen;
02029                                         
02030                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_FIN | TCP_FLAG_ACK;
02031                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
02032                                                         
02033                                 <span class="keywordflow">return</span>(0);
02034                         
02035                         }                       
02036                         
02037                 
02038                         <span class="keywordflow">break</span>;
02039                         
02040                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>:
02041                 
02042                         TCP_DEBUGOUT(<span class="stringliteral">"TIMED_WAIT State...\r\n"</span>);
02043                         
02044                         <span class="comment">/* Check for RESET      */</span>
02045                         
02046                         <span class="keywordflow">if</span>(received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET) {
02047                                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Reset received\r\n"</span>);
02048 
02049                                 <span class="comment">/* Inform application   */</span>
02050 
02051                                 soc-&gt;<a class="code" href="structtcb.html#m16">event_listener</a>(sochandle, <a class="code" href="tcp__ip_8h.html#a57">TCP_EVENT_ABORT</a>, soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>);                             
02052                                 
02053                                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m1">type</a> &amp; <a class="code" href="tcp__ip_8h.html#a39">TCP_TYPE_SERVER</a>)
02054                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>);
02055                                 <span class="keywordflow">else</span>
02056                                         <a class="code" href="tcp_8c.html#a20">tcp_newstate</a>(soc, <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>);
02057                                         
02058                                 <span class="keywordflow">return</span>(-1);
02059                         }                       
02060                         
02061                         <span class="comment">/* Is it repeated FIN?  */</span>
02062                         
02063                         <span class="keywordflow">if</span>( received_tcp_packet.<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_FIN       ) {
02064                                 
02065                                 TCP_DEBUGOUT(<span class="stringliteral">"Repeated FIN, repeat ACK\n\r"</span>);
02066                                 
02067                                 <span class="comment">/* ACK FIN and all data */</span>
02068                                 
02069                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = received_tcp_packet.<a class="code" href="structtcp__frame.html#m2">seqno</a>;
02070                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>++;
02071                                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> += dlen;
02072                                         
02073                                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_ACK;
02074                                 <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(sochandle);
02075                                                         
02076                                 <span class="keywordflow">return</span>(0);
02077                         
02078                         }
02079                 
02080                         
02081                 
02082                         <span class="keywordflow">break</span>;
02083         
02084         
02085                 <span class="keywordflow">default</span>:
02086                 
02087                         TCP_DEBUGOUT(<span class="stringliteral">"ERROR:TCP State machine in unknown state!!\r\n"</span>);
02088                         
02089                         <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a>(&amp;received_tcp_packet, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>);
02090                         
02091                         <a class="code" href="system_8h.html#a6">RESET_SYSTEM</a>();
02092         
02093         }
02094         
02095         TCP_DEBUGOUT(<span class="stringliteral">"Should not be there!\r\n"</span>);
02096         
02097         <span class="keywordflow">return</span>(-1);
02098                 
02099 }
02100 
02101 
<a name="l02119"></a><a class="code" href="tcp_8c.html#a15">02119</a> INT16 <a class="code" href="tcp_8c.html#a15">process_tcp_out</a> (INT8 sockethandle, UINT8* buf, UINT16 blen, UINT16 dlen)
02120 {
02121         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
02122         UINT16 cs;
02123         UINT8 cs_cnt;
02124         UINT16 i;
02125         UINT8* buf_start;
02126         
02127         TCP_DEBUGOUT(<span class="stringliteral">"Entering to send TCP packet\r\n"</span>);
02128         
02129         <span class="keywordflow">if</span>( sockethandle &lt; 0 ) {
02130                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Socket Handle not valid (&lt;0)\r\n"</span>);
02131                 <span class="keywordflow">return</span>(-1);
02132         }
02133         
02134         <span class="keywordflow">if</span>( sockethandle &gt; NO_OF_TCPSOCKETS ) {
02135                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Socket Handle not valid (&gt;NO_OF_TCPSOCKETS)\r\n"</span>);
02136                 <span class="keywordflow">return</span>(-1);
02137         }
02138         
02139         <span class="keywordflow">if</span>( (dlen + MIN_TCP_HLEN) &gt; blen ) {
02140                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Transmit buffer too small for TCP header\r\n"</span>);
02141                 <span class="keywordflow">return</span>(-1);
02142         } 
02143         
02144         soc = &amp;tcp_socket[sockethandle];                                <span class="comment">/* Get socket   */</span>
02145         
02146         buf_start = buf;
02147         
02148         <span class="keywordflow">if</span>( (dlen + MIN_TCP_HLEN) &gt; soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a> ) {
02149                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Send MTU exceeded\r\n"</span>);
02150                 <span class="keywordflow">return</span>(-1);
02151         }
02152         
02153         <span class="comment">/* Assemble TCP header to buffer        */</span>
02154         
02155         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> &gt;&gt; 8);
02156         *buf++ = (UINT8)soc-&gt;<a class="code" href="structtcb.html#m5">locport</a>;
02157         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> &gt;&gt; 8);
02158         *buf++ = (UINT8)soc-&gt;<a class="code" href="structtcb.html#m4">remport</a>;
02159         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> &gt;&gt;24);
02160         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> &gt;&gt;16);
02161         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> &gt;&gt;8);
02162         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a>);
02163         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> &gt;&gt;24);
02164         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> &gt;&gt;16);
02165         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> &gt;&gt;8);
02166         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a>);
02167         *buf =  MIN_TCP_HLEN &gt;&gt; 2;
02168         *buf &lt;&lt;= 4;
02169         buf++;
02170         *buf++ = soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a>;
02171         *buf++ = (UINT8)(TCP_DEF_MTU &gt;&gt; 8);
02172         *buf++ = (UINT8)TCP_DEF_MTU;
02173         *buf++ = 0;                                                             <span class="comment">/* Checksum     */</span>
02174         *buf++ = 0;
02175         *buf++ = 0;                                                             <span class="comment">/* Urgent       */</span>
02176         *buf++ = 0;
02177         
02178          
02179         <span class="comment">/* Calculate checksum   */</span>
02180         
02181         cs = 0;
02182         cs_cnt = 0;
02183         
02184         <span class="comment">/* Do it firstly to IP pseudo header    */</span>
02185         
02186         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(localmachine.localip &gt;&gt; 24), cs_cnt++);    
02187         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(localmachine.localip &gt;&gt; 16), cs_cnt++);
02188         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(localmachine.localip &gt;&gt; 8), cs_cnt++);
02189         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)localmachine.localip, cs_cnt++);
02190         
02191         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> &gt;&gt; 24), cs_cnt++);     
02192         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> &gt;&gt; 16), cs_cnt++);
02193         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> &gt;&gt; 8), cs_cnt++);
02194         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, cs_cnt++);     
02195         
02196         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, 0, cs_cnt++);
02197         
02198         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)<a class="code" href="ip_8h.html#a3">IP_TCP</a>, cs_cnt++);
02199                 
02200         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)((dlen + MIN_TCP_HLEN) &gt;&gt; 8), cs_cnt++);
02201         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(dlen + MIN_TCP_HLEN), cs_cnt++);
02202         
02203         <span class="comment">/* Go to TCP header + data      */</span>
02204         
02205         buf = buf_start;
02206         
02207         cs = <a class="code" href="ip_8c.html#a8">ip_checksum_buf</a>(cs, buf, dlen + MIN_TCP_HLEN);
02208                 
02209         cs = ~ cs;
02210 
02211 <span class="preprocessor">#if 0</span>
02212 <span class="preprocessor"></span>        <span class="comment">/* Is the padding required?     */</span>
02213         
02214         <span class="keywordflow">if</span>(dlen &amp; 0x01) {
02215                 TCP_DEBUGOUT(<span class="stringliteral">"Padding required\r\n"</span>);
02216                 *buf = 0;
02217                 dlen++;
02218         }
02219 <span class="preprocessor">#endif</span>
02220 <span class="preprocessor"></span>        
02221         <span class="comment">/* Save checksum in correct place       */</span>
02222         
02223         buf = buf_start + 16;
02224         *buf++ = (UINT8)(cs &gt;&gt; 8);
02225         *buf = (UINT8)cs;
02226         
02227         <span class="comment">/* Send it to IP        */</span>
02228         
02229         TCP_DEBUGOUT(<span class="stringliteral">"Sending TCP...\r\n"</span>);
02230         
02231         <a class="code" href="ip_8c.html#a4">process_ip_out</a>(soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a>, <a class="code" href="ip_8h.html#a3">IP_TCP</a>, soc-&gt;<a class="code" href="structtcb.html#m11">tos</a>, 100, buf_start, dlen + MIN_TCP_HLEN);
02232         
02233         TCP_DEBUGOUT(<span class="stringliteral">"TCP packet sent\r\n"</span>);
02234         
02235         <span class="keywordflow">return</span>(0);
02236         
02237 
02238 }
02239 
02240 
02241 
<a name="l02253"></a><a class="code" href="tcp_8c.html#a16">02253</a> <span class="keywordtype">void</span> <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a> (INT8 sockethandle)
02254 {
02255         UINT8 i;
02256 
02257         
02258         TCP_DEBUGOUT(<span class="stringliteral">"Entering to send TCP control packet\r\n"</span>);
02259         
02260         kick_WD();
02261         
02262         <span class="keywordflow">if</span>( sockethandle &lt; 0 ) {
02263                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Socket Handle not valid (&lt;0)\r\n"</span>);
02264                 <span class="keywordflow">return</span>;
02265         }
02266         
02267         <span class="keywordflow">if</span>( sockethandle &gt; NO_OF_TCPSOCKETS ) {
02268                 TCP_DEBUGOUT(<span class="stringliteral">"ERROR:Socket Handle not valid (&gt;NO_OF_TCPSOCKETS)\r\n"</span>);
02269                 <span class="keywordflow">return</span>;
02270         }
02271         
02272         <a class="code" href="tcp_8c.html#a15">process_tcp_out</a>(sockethandle, &amp;<a class="code" href="tcp_8c.html#a2">tcp_tempbuf</a>[0], MIN_TCP_HLEN + 1, 0);
02273         
02274         <span class="keywordflow">return</span>;
02275         
02276         
02277 }
02278 
<a name="l02294"></a><a class="code" href="tcp_8c.html#a17">02294</a> <span class="keywordtype">void</span> <a class="code" href="tcp_8c.html#a17">tcp_sendreset</a> (<span class="keyword">struct</span> <a class="code" href="structtcp__frame.html">tcp_frame</a> *frame, UINT32 remip)
02295 {
02296         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
02297 
02298         soc = &amp;tcp_socket[NO_OF_TCPSOCKETS];                            <span class="comment">/* Get socket   */</span>
02299 
02300 
02301         <span class="comment">/* Is this itself a reset packet?       */</span>
02302         
02303         <span class="keywordflow">if</span>( frame-&gt;<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET )
02304                 <span class="keywordflow">return</span>;
02305 
02306         <span class="comment">/* Set temporary tcb variables  */</span>
02307         
02308         soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> = remip;
02309         soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> = frame-&gt;<a class="code" href="structtcp__frame.html#m0">sport</a>;
02310         soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> = frame-&gt;<a class="code" href="structtcp__frame.html#m1">dport</a>;
02311         soc-&gt;<a class="code" href="structtcb.html#m11">tos</a> = 0;
02312         
02313         <span class="comment">/* Does the packet have ACK flag set?   */</span>
02314         
02315         <span class="keywordflow">if</span>( frame-&gt;<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK ) {
02316                 <span class="comment">/* Jup, use it as our seq       */</span>
02317                 
02318                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = frame-&gt;<a class="code" href="structtcp__frame.html#m3">ackno</a>;
02319                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_RESET;  
02320                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = frame-&gt;<a class="code" href="structtcp__frame.html#m2">seqno</a>;
02321         } <span class="keywordflow">else</span> {
02322                 soc-&gt;<a class="code" href="structtcb.html#m6">send_unacked</a> = 0;
02323                 soc-&gt;<a class="code" href="structtcb.html#m7">myflags</a> = TCP_FLAG_RESET | TCP_FLAG_ACK;   
02324                 soc-&gt;<a class="code" href="structtcb.html#m12">receive_next</a> = frame-&gt;<a class="code" href="structtcp__frame.html#m2">seqno</a>+1;
02325         }
02326                 
02327         
02328         soc-&gt;<a class="code" href="structtcb.html#m9">send_mtu</a> = TCP_DEF_MTU;
02329         
02330         <a class="code" href="tcp_8c.html#a16">tcp_sendcontrol</a>(NO_OF_TCPSOCKETS);
02331 
02332 }
02333 
02334 
<a name="l02346"></a><a class="code" href="tcp_8c.html#a18">02346</a> UINT32 <a class="code" href="tcp_8c.html#a79">tcp_initseq</a> (<span class="keywordtype">void</span>)
02347 {
02348 
02349         TCP_DEBUGOUT(<span class="stringliteral">"Calculating initial sequence number\r\n"</span>);
02350         
02351         <span class="keywordflow">return</span>( ( (UINT32)base_timer &lt;&lt; 24) | 0x00FFFFFF );
02352 
02353 }
02354 
<a name="l02369"></a><a class="code" href="tcp_8c.html#a19">02369</a> INT8 <a class="code" href="tcp_8c.html#a19">tcp_mapsocket</a> (<span class="keyword">struct</span> <a class="code" href="structip__frame.html">ip_frame</a>* ipframe, <span class="keyword">struct</span> <a class="code" href="structtcp__frame.html">tcp_frame</a>* tcpframe)
02370 {
02371         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
02372         UINT8 i;
02373 
02374         
02375         <span class="comment">/* Check if there is already connection on      */</span>
02376         
02377         <span class="keywordflow">for</span>( i=0; i &lt; NO_OF_TCPSOCKETS; i++) {
02378                 soc = &amp;tcp_socket[i];                                   <span class="comment">/* Get socket   */</span>
02379                 
02380                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a> == <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>)
02381                         <span class="keywordflow">continue</span>;                                                       <span class="comment">/* No match             */</span>
02382                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> != tcpframe-&gt;<a class="code" href="structtcp__frame.html#m0">sport</a>)
02383                         <span class="keywordflow">continue</span>;                                               
02384                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> != tcpframe-&gt;<a class="code" href="structtcp__frame.html#m1">dport</a>)
02385                         <span class="keywordflow">continue</span>;                                               
02386                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> != ipframe-&gt;<a class="code" href="structip__frame.html#m8">sip</a>) 
02387                         <span class="keywordflow">continue</span>;                                               
02388                 
02389                 <span class="comment">/* There is connection on already       */</span>
02390                 
02391                 TCP_DEBUGOUT(<span class="stringliteral">"Active connection socket found\r\n"</span>);
02392                 
02393                 <span class="keywordflow">return</span>(i);
02394         }
02395         
02396         <span class="comment">/* Allocate listening one if SYN packet (Connection Request)    */</span>
02397         
02398         TCP_DEBUGOUT(<span class="stringliteral">"No active connection, checking if SYN packet\r\n"</span>);
02399         
02400         <span class="comment">/* Is it SYN?   */</span>
02401         
02402         <span class="keywordflow">if</span>( (tcpframe-&gt;<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_SYN) == 0 )
02403                 <span class="keywordflow">return</span>(-1);
02404         <span class="keywordflow">if</span>( tcpframe-&gt;<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_ACK )
02405                 <span class="keywordflow">return</span>(-1);
02406         <span class="keywordflow">if</span>( tcpframe-&gt;<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_RESET )
02407                 <span class="keywordflow">return</span>(-1);
02408         <span class="keywordflow">if</span>( tcpframe-&gt;<a class="code" href="structtcp__frame.html#m4">hlen_flags</a> &amp; TCP_FLAG_FIN )
02409                 <span class="keywordflow">return</span>(-1);
02410         
02411         TCP_DEBUGOUT(<span class="stringliteral">"Trying to allocate listening one for SYN packet\r\n"</span>);
02412         
02413         <span class="comment">/* Search listening sockets     */</span>
02414         
02415         <span class="keywordflow">for</span>( i=0; i &lt; NO_OF_TCPSOCKETS; i++) {
02416                 soc = &amp;tcp_socket[i];                           <span class="comment">/* Get socket   */</span>
02417         
02418                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a45">TCP_STATE_LISTENING</a>)
02419                         <span class="keywordflow">continue</span>;       
02420                 
02421                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> != tcpframe-&gt;<a class="code" href="structtcp__frame.html#m1">dport</a>)
02422                         <span class="keywordflow">continue</span>;
02423                 
02424                 <span class="comment">/* Bind it      */</span>
02425                 
02426                 soc-&gt;<a class="code" href="structtcb.html#m3">rem_ip</a> = ipframe-&gt;<a class="code" href="structip__frame.html#m8">sip</a>;
02427                 soc-&gt;<a class="code" href="structtcb.html#m4">remport</a> = tcpframe-&gt;<a class="code" href="structtcp__frame.html#m0">sport</a>;
02428                 
02429                 TCP_DEBUGOUT(<span class="stringliteral">"Allocated new socket\r\n"</span>);
02430                 
02431                 <span class="keywordflow">return</span>(i);
02432                 
02433         }
02434         
02435         <span class="comment">/* No success   */</span>
02436         
02437         TCP_DEBUGOUT(<span class="stringliteral">"ERROR:No socket found or allocated for TCP packet\r\n"</span>);
02438         
02439         <span class="keywordflow">return</span>(-1);
02440 
02441 }
02442 
02443 
<a name="l02455"></a><a class="code" href="tcp_8c.html#a20">02455</a> <span class="keywordtype">void</span> <a class="code" href="tcp_8c.html#a20">tcp_newstate</a> (<span class="keyword">struct</span> <a class="code" href="structtcb.html">tcb</a>* soc, UINT8 nstate)
02456 {
02457         soc-&gt;<a class="code" href="structtcb.html#m0">state</a> = nstate;
02458         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> = <a class="code" href="group__opentcp__config.html#a9">TCP_DEF_RETRIES</a>;
02459 
02460         <span class="comment">/* In some states we don't want to wait for many retries (e.g. TIMED_WAIT)      */</span>
02461         
02462         <span class="keywordflow">switch</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a>) {
02463                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a52">TCP_STATE_TIMED_WAIT</a>:
02464                         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> = 0;
02465                         <span class="keywordflow">break</span>;
02466                 
02467                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a47">TCP_STATE_SYN_SENT</a>:        
02468                         <span class="comment">/* When we are sending SYN it's propably that ARP is not valid  */</span>
02469                         <span class="comment">/* Do retransmit faster on first time                                                   */</span>
02470                         <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>, <a class="code" href="group__opentcp__config.html#a12">TCP_INIT_RETRY_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
02471                         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> = TCP_CON_ATTEMPTS;
02472                         <span class="keywordflow">break</span>;
02473 
02474                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a51">TCP_STATE_LAST_ACK</a>:
02475                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a48">TCP_STATE_FINW1</a>:
02476                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a49">TCP_STATE_FINW2</a>:
02477                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a50">TCP_STATE_CLOSING</a>:
02478                         soc-&gt;<a class="code" href="structtcb.html#m15">retries_left</a> = 1;
02479                         <span class="keywordflow">break</span>;
02480                 
02481                 <span class="keywordflow">default</span>:
02482                         <span class="keywordflow">break</span>;
02483         
02484         }
02485         
02486         
02487         <span class="comment">/* KeepAlive timer      */</span>
02488         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structtcb.html#m0">state</a> == <a class="code" href="tcp__ip_8h.html#a53">TCP_STATE_CONNECTED</a>)
02489                 <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m13">persist_timerh</a>, soc-&gt;<a class="code" href="structtcb.html#m10">tout</a>);
02490         
02491         <span class="comment">/* Retransmit timer     */</span>
02492         
02493         <a class="code" href="timers_8c.html#a6">init_timer</a>(soc-&gt;<a class="code" href="structtcb.html#m14">retransmit_timerh</a>, <a class="code" href="group__opentcp__config.html#a11">TCP_DEF_RETRY_TOUT</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
02494         
02495         <span class="keywordflow">return</span>;
02496 
02497 
02498 }
02499 
<a name="l02511"></a><a class="code" href="tcp_8c.html#a21">02511</a> UINT16 <a class="code" href="tcp_8c.html#a89">tcp_getfreeport</a> (<span class="keywordtype">void</span>)
02512 {
02513         <span class="keyword">struct </span><a class="code" href="structtcb.html">tcb</a>* soc;
02514         <span class="keyword">static</span> UINT16 lastport = 1;
02515         UINT16 start;
02516         UINT16 i;
02517         
02518 
02519         <span class="comment">/* Try with every port to every socket untill free found        */</span>
02520                 
02521         <span class="keywordflow">for</span>( start = lastport++; start != lastport; lastport++) {
02522                 <span class="keywordflow">if</span>(lastport == <a class="code" href="group__opentcp__config.html#a7">TCP_PORTS_END</a>)
02523                         lastport = 1;
02524                         
02525                 <span class="keywordflow">for</span>(i = 0; i &lt; NO_OF_TCPSOCKETS; i++) {
02526                         soc = &amp;tcp_socket[i];                                   <span class="comment">/* Get socket   */</span>
02527                         
02528                         <span class="keywordflow">if</span>( (soc-&gt;<a class="code" href="structtcb.html#m0">state</a> &gt; <a class="code" href="tcp__ip_8h.html#a44">TCP_STATE_CLOSED</a>) &amp;&amp; (soc-&gt;<a class="code" href="structtcb.html#m5">locport</a> == lastport) ) {
02529                                 <span class="comment">/* Blaah, this socket has reserved the port, go to next one     */</span>
02530                                 <span class="keywordflow">break</span>; 
02531                         }
02532                         
02533                 }       
02534                         
02535                 <span class="comment">/* Did we found it?     */</span>
02536                         
02537                 <span class="keywordflow">if</span>( i == NO_OF_TCPSOCKETS)
02538                         <span class="keywordflow">break</span>; 
02539                         
02540         }
02541                 
02542         <span class="keywordflow">if</span>(lastport == start) {
02543                 TCP_DEBUGOUT(<span class="stringliteral">"Out of TCP ports!!\n\r"</span>);
02544                 <span class="keywordflow">return</span>(0);
02545         }
02546                 
02547         <span class="keywordflow">return</span>(lastport);
02548                 
02549 }
02550 
02551 
02552 
<a name="l02567"></a><a class="code" href="tcp_8c.html#a22">02567</a> UINT8 <a class="code" href="tcp_8c.html#a22">tcp_check_cs</a> (<span class="keyword">struct</span> <a class="code" href="structip__frame.html">ip_frame</a>* ipframe, UINT16 len)
02568 {
02569         UINT16 cs;
02570         UINT8 cs_cnt;
02571         UINT16 i;
02572         
02573         cs = 0;
02574         cs_cnt = 0;
02575         
02576         <span class="comment">/* Do it firstly to IP pseudo header    */</span>
02577         
02578         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(ipframe-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 24), cs_cnt++);    
02579         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(ipframe-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 16), cs_cnt++);
02580         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(ipframe-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 8), cs_cnt++);
02581         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)ipframe-&gt;<a class="code" href="structip__frame.html#m8">sip</a>, cs_cnt++);
02582         
02583         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(ipframe-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 24), cs_cnt++);    
02584         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(ipframe-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 16), cs_cnt++);
02585         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(ipframe-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 8), cs_cnt++);
02586         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)ipframe-&gt;<a class="code" href="structip__frame.html#m9">dip</a>, cs_cnt++);    
02587         
02588         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, 0, cs_cnt++);
02589         
02590         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)ipframe-&gt;<a class="code" href="structip__frame.html#m6">protocol</a>, cs_cnt++);
02591                 
02592         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(len &gt;&gt; 8), cs_cnt++);
02593         cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)len, cs_cnt++);
02594         
02595         <span class="comment">/* Go to TCP data       */</span>
02596         <span class="keywordflow">while</span>(len&gt;15)
02597         {               
02598                 <a class="code" href="system_8h.html#a10">RECEIVE_NETWORK_BUF</a>(<a class="code" href="tcp_8c.html#a2">tcp_tempbuf</a>,16);    
02599                 
02600                 cs = <a class="code" href="ip_8c.html#a8">ip_checksum_buf</a>(cs, <a class="code" href="tcp_8c.html#a2">tcp_tempbuf</a>,16);
02601                 len -= 16;      
02602                 cs_cnt += 16;
02603         }
02604         
02605         <span class="keywordflow">while</span>(len--){
02606                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>(), cs_cnt++);
02607         }
02608         
02609         cs = ~ cs;
02610         
02611         <span class="keywordflow">if</span>(cs != IP_GOOD_CS) {
02612                 <span class="keywordflow">return</span> (0);
02613         }
02614         
02615         <span class="comment">/* It's OK      */</span>
02616         
02617         <span class="keywordflow">return</span>(1);
02618         
02619 
02620 }
02621 
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:33:00 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
