<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/dns/dns.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/dns/dns.c</h1><a href="dns_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions</span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright</span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright</span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the</span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if</span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola</span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself,</span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to</span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior</span>
00026 <span class="comment"> *written permission. For written permission, please contact</span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP",</span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written</span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED</span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE</span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE</span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,</span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series</span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to</span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see</span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00054 
00075 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00076 <span class="preprocessor">#include &lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00077 <span class="preprocessor">#include &lt;<a class="code" href="globalvariables_8h.html">inet/globalvariables.h</a>&gt;</span>
00078 <span class="preprocessor">#include &lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00079 <span class="preprocessor">#include &lt;<a class="code" href="timers_8h.html">inet/timers.h</a>&gt;</span>
00080 <span class="preprocessor">#include &lt;<a class="code" href="tcp__ip_8h.html">inet/tcp_ip.h</a>&gt;</span>
00081 <span class="preprocessor">#include &lt;<a class="code" href="dns_8h.html">inet/dns/dns.h</a>&gt;</span>
00082 
00083 
00084 <span class="preprocessor">#define DNS_STATE_READY         0</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#define DNS_STATE_BUSY          1</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#define DNS_STATE_RESEND        2       </span><span class="comment">/* retransmit request */</span>
00087 
<a name="l00088"></a><a class="code" href="dns_8c.html#a3">00088</a> UINT8 <a class="code" href="dns_8c.html#a3">dns_state</a>; 
<a name="l00089"></a><a class="code" href="dns_8c.html#a4">00089</a> UINT8 <a class="code" href="dns_8c.html#a4">dns_socket</a>; 
<a name="l00090"></a><a class="code" href="dns_8c.html#a5">00090</a> UINT8 <a class="code" href="dns_8c.html#a5">dns_timer</a>; 
<a name="l00091"></a><a class="code" href="dns_8c.html#a6">00091</a> UINT8 <a class="code" href="dns_8c.html#a6">dns_retries</a>; 
<a name="l00093"></a><a class="code" href="dns_8c.html#a7">00093</a> UINT32 <a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>; 
<a name="l00095"></a><a class="code" href="dns_8c.html#a8">00095</a> UINT8 *<a class="code" href="dns_8c.html#a8">dns_hostptr</a>;     
00098 void (*dns_event_listener)(UINT8 event, UINT32 data);
00099 
<a name="l00108"></a><a class="code" href="dns_8c.html#a10">00108</a> <span class="keywordtype">void</span> <a class="code" href="dns_8c.html#a10">dns_init</a>(<span class="keywordtype">void</span>){
00109 
00110         <a class="code" href="dns_8c.html#a3">dns_state</a> = DNS_STATE_READY;
00111 
00112         <a class="code" href="dns_8c.html#a4">dns_socket</a>=<a class="code" href="udp_8c.html#a3">udp_getsocket</a>(0 , <a class="code" href="dns_8c.html#a13">dns_eventlistener</a> , <a class="code" href="tcp__ip_8h.html#a5">UDP_OPT_SEND_CS</a> | <a class="code" href="tcp__ip_8h.html#a6">UDP_OPT_CHECK_CS</a>);
00113 
00114         <span class="keywordflow">if</span>(<a class="code" href="dns_8c.html#a4">dns_socket</a> == -1){
00115                 DEBUGOUT(<span class="stringliteral">"DNS: No free UDP sockets!! \r\n"</span>);
00116                 <span class="keywordflow">return</span>;
00117         }
00118 
00119         <span class="comment">/* open socket */</span>
00120         <a class="code" href="udp_8c.html#a5">udp_open</a>(<a class="code" href="dns_8c.html#a4">dns_socket</a>,<a class="code" href="dns_8h.html#a0">DNS_UDP_PORT</a>);
00121 
00122         <span class="comment">/* now the timer. This will be used for retransmitting the requests */</span>
00123         <a class="code" href="dns_8c.html#a5">dns_timer</a>=<a class="code" href="timers_8c.html#a2">get_timer</a>();
00124 
00125         <span class="comment">/* TODO: if GetTimer is modified so that it doesn't reset system if</span>
00126 <span class="comment">                no timers available, check return value! */</span>
00127 
00128         DEBUGOUT(<span class="stringliteral">"Initialized DNS client\r\n"</span>);
00129 
00130 }
00131 
<a name="l00142"></a><a class="code" href="dns_8c.html#a11">00142</a> <span class="keywordtype">void</span> <a class="code" href="dns_8c.html#a11">dns_retransmit</a>(<span class="keywordtype">void</span>){
00143         <span class="keywordflow">if</span>(<a class="code" href="dns_8c.html#a6">dns_retries</a>!=0){
00144                 <a class="code" href="dns_8c.html#a3">dns_state</a>=DNS_STATE_RESEND;
00145                 <a class="code" href="dns_8c.html#a6">dns_retries</a>--;
00146                 <a class="code" href="dns_8c.html#a14">get_host_by_name</a>(<a class="code" href="dns_8c.html#a8">dns_hostptr</a>,dns_event_listener);
00147                 <a class="code" href="timers_8c.html#a6">init_timer</a>(<a class="code" href="dns_8c.html#a5">dns_timer</a>,<a class="code" href="dns_8h.html#a2">DNS_RESEND_PERIOD</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
00148         }<span class="keywordflow">else</span>{
00149 
00150                 <span class="comment">/* timeout happened */</span>
00151                 <a class="code" href="dns_8c.html#a3">dns_state</a>=DNS_STATE_READY;
00152 
00153                 dns_event_listener(<a class="code" href="dns_8h.html#a4">DNS_EVENT_ERROR</a>,<a class="code" href="dns_8h.html#a11">DNS_ERROR_TIMEOUT</a>);
00154 
00155         }
00156 
00157 }
00158 
<a name="l00168"></a><a class="code" href="dns_8c.html#a12">00168</a> <span class="keywordtype">void</span> <a class="code" href="dns_8c.html#a12">dns_run</a>(<span class="keywordtype">void</span>){
00169         <span class="keywordflow">if</span>((<a class="code" href="dns_8c.html#a3">dns_state</a>==DNS_STATE_BUSY)||(<a class="code" href="dns_8c.html#a3">dns_state</a>==DNS_STATE_RESEND)){
00170                 <span class="comment">/* checking retransmission timer */</span>
00171                 <span class="keywordflow">if</span>(!<a class="code" href="timers_8c.html#a7">check_timer</a>(<a class="code" href="dns_8c.html#a5">dns_timer</a>)){
00172 
00173                         DEBUGOUT(<span class="stringliteral">"DNS: retransmitting the request \r\n"</span>);
00174                         <span class="comment">/* timeout, send another one */</span>
00175                         <a class="code" href="dns_8c.html#a11">dns_retransmit</a>();
00176 
00177                 }
00178         }
00179 }
00180 
<a name="l00205"></a><a class="code" href="dns_8c.html#a13">00205</a> INT32 <a class="code" href="dns_8c.html#a13">dns_eventlistener</a>(INT8 cbhandle, UINT8 event, UINT32 ipaddr, UINT16 port, UINT16 buffindex, UINT16 datalen){
00206         UINT8 tmp_byte;
00207         UINT16 tmp_int;
00208         UINT8 *tmp_ptr;
00209         UINT8 count;
00210         <span class="comment">/* it will fit in 8bits most of the time but... */</span>
00211         UINT16 dns_ancount;
00212         UINT16 dns_nscount;
00213 
00214         <span class="keywordflow">if</span>(cbhandle!=<a class="code" href="dns_8c.html#a4">dns_socket</a>){
00215                 DEBUGOUT(<span class="stringliteral">"DNS: not my handle!!!!"</span>);
00216                 <span class="keywordflow">return</span> (-1);
00217         }
00218 
00219         <span class="keywordflow">if</span>(ipaddr!=<a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>){
00220                 DEBUGOUT(<span class="stringliteral">"DNS: received DNS but IP addr not OK!\r\n"</span>);
00221         }
00222 
00223         <span class="keywordflow">switch</span>(event){
00224                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a31">UDP_EVENT_DATA</a>:
00225                         <span class="comment">/* only process data while not in ready state */</span>
00226                         <span class="keywordflow">if</span>(<a class="code" href="dns_8c.html#a3">dns_state</a>==DNS_STATE_READY){
00227                                 DEBUGOUT(<span class="stringliteral">"DNS: Received answer in wrong state\r\n"</span>);
00228                                 <span class="keywordflow">return</span> (-1);
00229                         }
00230 
00231                         <span class="comment">/* inital size checking. Every DNS reply will be bigger</span>
00232 <span class="comment">                                than 16 bytes */</span>
00233                         <span class="keywordflow">if</span>(datalen&lt;16){
00234                                 DEBUGOUT(<span class="stringliteral">"DNS: UDP packet way to short for DNS!\r\n"</span>);
00235                                 <span class="keywordflow">return</span> (-1);
00236                         }
00237 
00238                         <span class="comment">/* some data received, check if it's what we're waiting for */</span>
00239                         tmp_int=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00240                         tmp_int=(tmp_int&lt;&lt;8)+<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00241                         <span class="keywordflow">if</span>(tmp_int!=0xaaaa){
00242                                 DEBUGOUT(<span class="stringliteral">"DNS: ERROR: ID wrong!\r\n"</span>);
00243                                 <span class="keywordflow">return</span> (-1);
00244                         }
00245 
00246                         tmp_byte=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00247 
00248                         <span class="keywordflow">if</span>(!(tmp_byte&amp;0x80)){
00249                                 DEBUGOUT(<span class="stringliteral">"DNS: THIS IS NOT AN ANSWER! WE'RE NOT A DNS SERVER!\r\n"</span>);
00250                                 <span class="keywordflow">return</span> (-1);
00251                         }
00252 
00253                         <span class="comment">/* opcode or truncated ? */</span>
00254                         <span class="keywordflow">if</span>(tmp_byte&amp;0x7a){
00255                                 DEBUGOUT(<span class="stringliteral">"DNS: Opcode not zero or message truncated. \r\n"</span>);
00256                                 dns_event_listener(<a class="code" href="dns_8h.html#a4">DNS_EVENT_ERROR</a>,<a class="code" href="dns_8h.html#a12">DNS_ERROR_GENERAL</a>);
00257                                 <span class="keywordflow">return</span> (-1);
00258                         }
00259 
00260                         tmp_byte=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00261 
00262                         <span class="comment">/* check RCODE */</span>
00263                         <span class="keywordflow">if</span>((tmp_byte&amp;0x7f)&amp;&amp;(tmp_byte&amp;0x80)){
00264                                 <span class="comment">/* RCODE not zero, and recursion is available   */</span>
00265                                 <span class="comment">/* There was an error. Inform listener                  */</span>
00266                                 DEBUGOUT(<span class="stringliteral">"DNS: RCODE not zero and recursion available! \r\n"</span>);
00267                                 dns_event_listener(<a class="code" href="dns_8h.html#a4">DNS_EVENT_ERROR</a>,tmp_byte&amp;0x7f);
00268                                 <span class="keywordflow">return</span> (-1);
00269                         }
00270 
00271                         <span class="comment">/* question count == 1 ? */</span>
00272                         tmp_int=(((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8);
00273                         tmp_int+=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00274                         <span class="keywordflow">if</span>(tmp_int != 1){
00275                                 DEBUGOUT(<span class="stringliteral">"DNS: we only sent one question and received a couple of answers!!\r\n"</span>);
00276                                 dns_event_listener(<a class="code" href="dns_8h.html#a4">DNS_EVENT_ERROR</a>,<a class="code" href="dns_8h.html#a12">DNS_ERROR_GENERAL</a>);
00277                                 <span class="keywordflow">return</span> (-1);
00278                         }
00279 
00280                         dns_ancount=(((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8);
00281                         dns_ancount+=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00282 
00283                         dns_nscount=(((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8);
00284                         dns_nscount+=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00285 
00286                         <span class="comment">/* skip ARCOUNT */</span>
00287                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00288                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00289 
00290                         <span class="comment">/* got to the data, let's process it */</span>
00291                         <span class="comment">/* check if question section is appropriate (QNAME the same</span>
00292 <span class="comment">                                and QTYPE=QCLASS=1</span>
00293 <span class="comment">                        */</span>
00294                         tmp_ptr=<a class="code" href="dns_8c.html#a8">dns_hostptr</a>;
00295                         <span class="keywordflow">while</span>((tmp_byte=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())!=0){
00296                                 <span class="keywordflow">while</span>((tmp_byte--)!=0){
00297                                         <span class="keywordflow">if</span>(*tmp_ptr++!=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()){
00298                                                 DEBUGOUT(<span class="stringliteral">"DNS: QNAME not the same!!!! \r\n"</span>);
00299                                                 <span class="comment">/* we'll assume that this was from some previous</span>
00300 <span class="comment">                                                        query and just exit here */</span>
00301                                                 <span class="keywordflow">return</span> (-1);
00302                                         }
00303                                 }
00304                                 <span class="comment">/* reached the end of the label. Is it dot or end of string? */</span>
00305 
00306                                 <span class="keywordflow">if</span>(*tmp_ptr==<span class="charliteral">'\0'</span>){
00307                                         <span class="keywordflow">continue</span>;
00308                                 }
00309 
00310                                 <span class="keywordflow">if</span>(*tmp_ptr++!=<span class="charliteral">'.'</span>){
00311                                         DEBUGOUT(<span class="stringliteral">"DNS: DOT not where it's supposed to be!\r\n"</span>);
00312                                         <span class="keywordflow">return</span> (-1);
00313                                 }
00314                         }
00315 
00316 
00317                         <span class="comment">/* qtype and qclass */</span>
00318                         tmp_int=(((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8);
00319                         tmp_int+=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00320 
00321                         tmp_int|=((UINT16)(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8);
00322                         tmp_int|=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00323 
00324                         <span class="keywordflow">if</span>(tmp_int!=0x0001){
00325                                 DEBUGOUT(<span class="stringliteral">"DNS: Question section QTYPE and/or QCLASS not ok!\r\n"</span>);
00326                                 dns_event_listener(<a class="code" href="dns_8h.html#a4">DNS_EVENT_ERROR</a>,<a class="code" href="dns_8h.html#a12">DNS_ERROR_GENERAL</a>);
00327                                 <span class="keywordflow">return</span> (-1);
00328                         }
00329 
00330                         <span class="comment">/* process all answer RRs and try to find answer */</span>
00331 
00332                         <span class="comment">/* simply try to find INET class RR. It is</span>
00333 <span class="comment">                                _PROBABLY_ what we're after. More extensive checking</span>
00334 <span class="comment">                                would demand buffering the reply which may not be</span>
00335 <span class="comment">                                desireable.</span>
00336 <span class="comment">                         */</span>
00337                         <span class="keywordflow">while</span>(dns_ancount||dns_nscount){
00338                                 <span class="keywordflow">do</span>{
00339                                         tmp_byte=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00340                                 }<span class="keywordflow">while</span>((tmp_byte!=0)&amp;&amp;((tmp_byte&amp;0xc0)!=0xc0));
00341 
00342                                 <span class="keywordflow">if</span>(tmp_byte!=0) <span class="comment">/*second offset byte used in compression*/</span>
00343                                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00344 
00345                                 <span class="comment">/* TYPE */</span>
00346                                 tmp_int=((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8;
00347                                 tmp_int|=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00348 
00349                                 <span class="comment">/* CLASS */</span>
00350                                 tmp_int|=(((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8);
00351                                 tmp_int|=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00352 
00353                                 <span class="comment">/* CLASS==INET and TYPE=A ? */</span>
00354                                 <span class="keywordflow">if</span>(tmp_int==0x0001){
00355 
00356                                         <span class="comment">/* got it. Skip TTL and read RDLENGTH */</span>
00357                                         <span class="keywordflow">for</span>(tmp_byte=0;tmp_byte&lt;6;tmp_byte++){
00358                                                 tmp_int=(tmp_int&lt;&lt;8)+<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00359                                         }
00360 
00361                                         <span class="keywordflow">if</span>(tmp_int==0x0004){
00362                                                 <span class="comment">/* great, read IP address*/</span>
00363                                                 <a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;24;
00364                                                 <a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>+=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;16;
00365                                                 <a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>+=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8;
00366                                                 <a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>+=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00367 
00368                                                 <span class="comment">/* we got some IP address. Is it what we asked for</span>
00369 <span class="comment">                                                        or a NS IP addr*/</span>
00370                                                 <span class="keywordflow">if</span>(dns_ancount){
00371                                                         DEBUGOUT(<span class="stringliteral">"DNS: Got IP address!\r\n"</span>);
00372                                                         dns_event_listener(<a class="code" href="dns_8h.html#a5">DNS_EVENT_SUCCESS</a>,<a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>);
00373                                                         <a class="code" href="dns_8c.html#a3">dns_state</a>=DNS_STATE_READY;
00374                                                 }<span class="keywordflow">else</span>{
00375                                                         DEBUGOUT(<span class="stringliteral">"DNS: Got auth DNS IP addr!\r\n"</span>);
00376                                                         <span class="comment">/* invoke another query to the authority */</span>
00377                                                         <a class="code" href="dns_8c.html#a11">dns_retransmit</a>();
00378                                                 }
00379 
00380                                                 <span class="keywordflow">return</span> 0;
00381                                         }<span class="keywordflow">else</span>{
00382                                                 <span class="comment">/* nope, skip other bytes */</span>
00383                                                 <span class="keywordflow">while</span>(tmp_int--)
00384                                                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00385                                         }
00386                                 }<span class="keywordflow">else</span>{
00387 
00388                                         DEBUGOUT(<span class="stringliteral">"DNS: RR.CLASS not INET. Skipping!\r\n"</span>);
00389 
00390                                         <span class="comment">/* skip TTL and read RDLENGTH*/</span>
00391                                         <span class="keywordflow">for</span>(tmp_byte=0;tmp_byte&lt;6;tmp_byte++){
00392                                                 tmp_int=(tmp_int&lt;&lt;8)+<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00393                                         }
00394 
00395                                         <span class="comment">/* skip RDATA */</span>
00396                                         <span class="keywordflow">while</span>(tmp_int--)
00397                                                 <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00398                                 }
00399                                 <span class="comment">/* decrement counters */</span>
00400                                 <span class="keywordflow">if</span>(dns_ancount)
00401                                         dns_ancount--;
00402                                 <span class="keywordflow">else</span>
00403                                         <span class="keywordflow">if</span>(dns_nscount)
00404                                                 dns_nscount--;
00405 
00406                         }
00407                         <span class="keywordflow">break</span>;
00408 
00409                 <span class="keywordflow">default</span>:
00410                         DEBUGOUT(<span class="stringliteral">"DNS: unknown UDP event :-("</span>);
00411                         <span class="keywordflow">break</span>;
00412         }
00413         <span class="keywordflow">return</span> 0;
00414 }
00415 
<a name="l00445"></a><a class="code" href="dns_8c.html#a14">00445</a> UINT8 <a class="code" href="dns_8c.html#a14">get_host_by_name</a>(UINT8 *host_name_ptr, <span class="keywordtype">void</span> (*listener)(UINT8 , UINT32 )){
00446 
00447         UINT8 *buf_ptr;
00448         INT8 i;
00449         UINT16 total;
00450 
00451         <span class="keywordflow">switch</span>(dns_state){
00452 
00453                 <span class="keywordflow">case</span> DNS_STATE_READY:
00454                         <a class="code" href="dns_8c.html#a3">dns_state</a>=DNS_STATE_BUSY;
00455                         <a class="code" href="dns_8c.html#a8">dns_hostptr</a>=host_name_ptr;
00456                         dns_event_listener=listener;
00457                         <a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>=<a class="code" href="dns_8h.html#a1">DNS_SERVER_IP</a>;
00458                         <a class="code" href="dns_8c.html#a6">dns_retries</a>=<a class="code" href="dns_8h.html#a3">DNS_NUM_RETRIES</a>;
00459                         <a class="code" href="timers_8c.html#a6">init_timer</a>(<a class="code" href="dns_8c.html#a5">dns_timer</a>,<a class="code" href="dns_8h.html#a2">DNS_RESEND_PERIOD</a>*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
00460                         <span class="keywordflow">break</span>;
00461 
00462                 <span class="keywordflow">case</span> DNS_STATE_BUSY:
00463                         DEBUGOUT(<span class="stringliteral">"DNS: Error, trying to invoke two DNS requests at the same time!\r\n"</span>);
00464                         <span class="keywordflow">return</span>  <a class="code" href="dns_8h.html#a13">DNS_ERROR_BUSY</a>;
00465 
00466 
00467                 <span class="keywordflow">case</span> DNS_STATE_RESEND:
00468                         <span class="keywordflow">if</span>(host_name_ptr!=<a class="code" href="dns_8c.html#a8">dns_hostptr</a>){
00469                                 DEBUGOUT(<span class="stringliteral">"DNS: Ptrs different. Can't do that! \r\n"</span>);
00470                                 <span class="keywordflow">return</span> <a class="code" href="dns_8h.html#a13">DNS_ERROR_BUSY</a>;
00471                         }
00472                         <span class="keywordflow">break</span>;
00473 
00474                 <span class="keywordflow">default</span>:
00475                         DEBUGOUT(<span class="stringliteral">"DNS: What am I doing in this state?\r\n"</span>);
00476                         <a class="code" href="system_8h.html#a6">RESET_SYSTEM</a>();
00477         }
00478 
00479 
00480         <span class="comment">/* OK, create message in the Netbuf transmit buffer */</span>
00481 
00482         buf_ptr=net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>;
00483 
00484         <span class="comment">/* first the header */</span>
00485         *((UINT16 *)buf_ptr)=0xAAAA; <span class="comment">/* id, fixed for now*/</span>
00486         buf_ptr+=2;
00487 
00488         *buf_ptr++=0x01;
00489         *buf_ptr++=0x00;
00490 
00491         <span class="comment">/*question count*/</span>
00492         *buf_ptr++=0x00;
00493         *buf_ptr++=0x01;
00494 
00495         <span class="comment">/* others are zero */</span>
00496         <span class="keywordflow">for</span>(i=0;i&lt;6;i++)
00497                 *buf_ptr++=0x00;
00498 
00499         <span class="comment">/* ok, create the question section */</span>
00500         total=0;
00501 
00502         <span class="keywordflow">while</span>((*host_name_ptr)!=<span class="charliteral">'\0'</span>){
00503 
00504                 <span class="comment">/* we are still not at the end. Reserve space for count */</span>
00505                 buf_ptr++;
00506                 i=0;
00507 
00508                 <span class="keywordflow">while</span>(((*host_name_ptr)!=<span class="charliteral">'.'</span>)&amp;&amp;((*host_name_ptr)!=<span class="charliteral">'\0'</span>)){
00509                         i++;
00510                         *buf_ptr++=*host_name_ptr++;
00511                         <span class="keywordflow">if</span>(buf_ptr==(net_buf+<a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a>)){
00512                                 DEBUGOUT(<span class="stringliteral">"DNS: Buffer overflow!!!\r\n"</span>);
00513                                 <span class="keywordflow">return</span>(DNS_ERROR_OVERFLOW);
00514                         }
00515                 }
00516 
00517                 <span class="comment">/* label shorter than 63 bytes or less? */</span>
00518                 <span class="keywordflow">if</span>((i&lt;=0)||(i&gt;=64)){
00519                         DEBUGOUT(<span class="stringliteral">"DNS: Label size wrong! Aborting....\r\n"</span>);
00520                         <span class="keywordflow">return</span>(DNS_ERROR_LABEL);
00521                 }
00522 
00523                 <span class="comment">/* it seems ok for now. Increase total name length*/</span>
00524                 total+=i;
00525 
00526                 <span class="keywordflow">if</span>(total&gt;=264){
00527                         DEBUGOUT(<span class="stringliteral">"DNS: Name size wrong! Aborting....\r\n"</span>);
00528                         <span class="keywordflow">return</span>(DNS_ERROR_NAME);
00529                 }
00530 
00531                 *(buf_ptr-i-1)=i;       <span class="comment">/* store label length */</span>
00532 
00533                 <span class="comment">/* ok, where are we ? */</span>
00534                 <span class="keywordflow">if</span>((*host_name_ptr)==<span class="charliteral">'.'</span>){
00535                         <span class="comment">/* still not at the end, skip dot */</span>
00536                         host_name_ptr++;
00537                 }<span class="keywordflow">else</span>
00538                         <span class="keywordflow">if</span>((*host_name_ptr)==<span class="charliteral">'\0'</span>){
00539                                 <span class="comment">/* OHO, finished,</span>
00540 <span class="comment">                                        add ZERO,QTYPE and QCLASS */</span>
00541                                 *buf_ptr++=0x00;
00542                                 *buf_ptr++=0x00;
00543                                 *buf_ptr++=0x01;
00544                                 *buf_ptr++=0x00;
00545                                 *buf_ptr++=0x01;
00546                                 kick_WD();
00547                                 <span class="comment">/* ok, now send the request */</span>
00548                                 <span class="keywordflow">return</span> <a class="code" href="udp_8c.html#a7">udp_send</a>(<a class="code" href="dns_8c.html#a4">dns_socket</a>,<a class="code" href="dns_8c.html#a7">dns_tmp_ip</a>,<a class="code" href="dns_8h.html#a0">DNS_UDP_PORT</a>,net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>,<a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a>-<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>,buf_ptr-(net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>));
00549                         }
00550         }
00551 }
00552 
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:32:59 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
