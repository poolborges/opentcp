<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/arp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/arp.c</h1><a href="arp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright </span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright </span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the </span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if </span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola </span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself, </span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to </span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior </span>
00026 <span class="comment"> *written permission. For written permission, please contact </span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP", </span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written </span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED </span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE </span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR </span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE </span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, </span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series </span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to </span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see </span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00069 <span class="preprocessor">#include &lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00070 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00071 <span class="preprocessor">#include &lt;<a class="code" href="ethernet_8h.html">inet/ethernet.h</a>&gt;</span>
00072 <span class="preprocessor">#include &lt;<a class="code" href="arp_8h.html">inet/arp.h</a>&gt;</span>
00073 <span class="preprocessor">#include &lt;<a class="code" href="timers_8h.html">inet/timers.h</a>&gt;</span>
00074 <span class="preprocessor">#include &lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00075 <span class="preprocessor">#include &lt;<a class="code" href="globalvariables_8h.html">inet/globalvariables.h</a>&gt;</span>
00076 
<a name="l00086"></a><a class="code" href="arp_8c.html#a0">00086</a> <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a>        arp_table[ARP_TSIZE]; 
00087 
<a name="l00094"></a><a class="code" href="arp_8c.html#a1">00094</a> UINT8 <a class="code" href="arp_8c.html#a1">arp_timer</a>; 
00095 
<a name="l00116"></a><a class="code" href="arp_8c.html#a2">00116</a> UINT8 <a class="code" href="arp_8c.html#a2">process_arp</a> (<span class="keyword">struct</span> <a class="code" href="structethernet__frame.html">ethernet_frame</a>* frame) {
00117         
00118         UINT8 temp;             
00119         
00120         <span class="comment">/* Check if ARP packet*/</span>
00121         
00122         <span class="keywordflow">if</span>( frame-&gt;<a class="code" href="structethernet__frame.html#m3">protocol</a> == ARP_ETHCODE ) {
00123                 <span class="comment">/* Yep, ARP */</span>
00124                 
00125                 <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(frame-&gt;<a class="code" href="structethernet__frame.html#m4">buf_index</a>);
00126                 
00127                 <span class="comment">/* Is it long enough?   */</span>
00128                 
00129                 <span class="keywordflow">if</span>( frame-&gt;<a class="code" href="structethernet__frame.html#m2">frame_size</a> &lt; (2*<a class="code" href="arp_8h.html#a0">MAXHWALEN</a> + 2*<a class="code" href="arp_8h.html#a1">MAXPRALEN</a> + 2 + 6) ) {
00130                         <span class="comment">/* Somehow corrupted ARP packet */</span>
00131                         ARP_DEBUGOUT(<span class="stringliteral">"Corrupted ARP packet\n\r"</span>);
00132                         <span class="comment">/*NETWORK_RECEIVE_END();*/</span>
00133                         <span class="keywordflow">return</span>(TRUE);
00134                 }
00135                          
00136                 
00137                 <span class="comment">/* Ignore next 6 bytes: &lt;HW type&gt;, &lt;Protocol type&gt; */</span>
00138                 <span class="comment">/* &lt;HW address len&gt; and &lt;Protocol address len&gt;     */</span>
00139                 
00140                 <span class="keywordflow">for</span>(temp=0; temp&lt;6; temp++)
00141                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00142                 
00143                 ARP_DEBUGOUT(<span class="stringliteral">"Incoming ARP..\n\r"</span>);
00144                 
00145                 <span class="comment">/* Check if request or response */</span>
00146                 
00147                 <span class="keywordflow">if</span>( <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>() == 0x00) {
00148                 
00149                         temp = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();     <span class="comment">/* get opcode */</span>
00150                 
00151                         <span class="keywordflow">if</span>( temp == ARP_REQUEST ) {
00152                                 ARP_DEBUGOUT(<span class="stringliteral">" ARP REQUEST Received..\n\r"</span>);
00153                                 <a class="code" href="arp_8c.html#a3">arp_send_response</a>();
00154                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( temp == ARP_REPLY ) {
00155                                 ARP_DEBUGOUT(<span class="stringliteral">"ARP Response Received..\n\r"</span>);
00156                                 <a class="code" href="arp_8c.html#a4">arp_get_response</a>();     
00157                         }
00158                         
00159                 <span class="comment">/* Wasn't request or response or all done, dump it */</span>
00160                 
00161                 }
00162                 
00163                 <span class="comment">/*NETWORK_RECEIVE_END();*/</span>
00164                 <span class="keywordflow">return</span>(TRUE);
00165                 
00166         }
00167         
00168         <span class="comment">/* Wasn't ARP, don't touch the packet */</span>
00169         
00170         <span class="keywordflow">return</span>(FALSE);                                                          
00171 }
00172 
<a name="l00188"></a><a class="code" href="arp_8c.html#a3">00188</a> <span class="keywordtype">void</span> <a class="code" href="arp_8c.html#a3">arp_send_response</a>(<span class="keywordtype">void</span>)
00189 {
00190         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00191         UINT8 rem_hwadr[<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>];
00192         UINT32 rem_ip;
00193         UINT32 ltemp;
00194         INT8 i;
00195         BYTE j;
00196 
00197         <span class="comment">/* Record Sender's HW address           */</span>
00198         
00199         <span class="keywordflow">for</span>( i=<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>-1; i &gt;= 0; i-- )
00200                 rem_hwadr[i] = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();             
00201         
00202         <span class="comment">/* Read Sender's IP Address     */</span>
00203         
00204         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="arp_8h.html#a1">MAXPRALEN</a>; i++) {
00205                 rem_ip &lt;&lt;= 8;
00206                 rem_ip |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00207         } 
00208         
00209         
00210         <span class="comment">/* Skip Target HW address               */</span>
00211         
00212         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00213         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00214         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00215         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00216         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00217         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();    
00218         
00219         <span class="comment">/* Is The Packet For Us?        */</span>
00220         
00221         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="arp_8h.html#a1">MAXPRALEN</a>; i++) {
00222                 ltemp &lt;&lt;= 8;
00223                 ltemp |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00224         }
00225                 
00226         
00227         <span class="keywordflow">if</span>( ltemp != localmachine.localip ) 
00228                 <span class="keywordflow">return</span>;                                                         <span class="comment">/* No   */</span>
00229 
00230         ARP_DEBUGOUT(<span class="stringliteral">"Preparing for ARP Reply\n\r"</span>);
00231         
00232         <span class="comment">/* OK. Now send reply           */</span>
00233         
00234         <a class="code" href="system_8h.html#a17">NETWORK_SEND_INITIALIZE</a>(<a class="code" href="ethernet_8h.html#a35">ARP_BUFFER</a>);
00235         
00236         <span class="comment">/* Add datalink (Ethernet addresses) information        */</span>
00237         
00238         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>; i++)     {
00239                 send_frame.destination[i] = rem_hwadr[i];
00240                 send_frame.source[i] = localmachine.localHW[i];
00241         }
00242         
00243         send_frame.protocol = <a class="code" href="ethernet_8h.html#a5">PROTOCOL_ARP</a>;
00244         
00245         <a class="code" href="system_8h.html#a18">NETWORK_ADD_DATALINK</a>(&amp;send_frame);
00246         
00247         <span class="comment">/* PUT ARP Data */</span>
00248         
00249         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (BYTE)(AR_HARDWARE&gt;&gt;8) );                               <span class="comment">/* Hardware Type        */</span>
00250         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (BYTE)AR_HARDWARE );
00251         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(0x08);                                                                   <span class="comment">/* Protocol Type        */</span>
00252         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(0x00);
00253         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>);                                                              <span class="comment">/* HW Adr Len           */</span>
00254         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(<a class="code" href="arp_8h.html#a1">MAXPRALEN</a>);                                                              <span class="comment">/* Protocol Adr. Len*/</span>
00255         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( 0x00 );                                                                 <span class="comment">/* ARP Opcode           */</span>      
00256         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( 0x02 );                                 
00257         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localHW[5]));               <span class="comment">/* Address fields       */</span>
00258         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localHW[4]));
00259         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localHW[3]));
00260         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localHW[2]));
00261         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localHW[1]));
00262         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localHW[0]));
00263         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localip&gt;&gt;24));
00264         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localip&gt;&gt;16));
00265         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localip&gt;&gt;8));
00266         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localip));
00267         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)rem_hwadr[5]);
00268         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)rem_hwadr[4]);
00269         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)rem_hwadr[3]);
00270         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)rem_hwadr[2]);
00271         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)rem_hwadr[1]);
00272         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)rem_hwadr[0]);                                            
00273         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(rem_ip&gt;&gt;24));
00274         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(rem_ip&gt;&gt;16));
00275         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(rem_ip&gt;&gt;8));
00276         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)rem_ip);
00277         
00278         <a class="code" href="system_8h.html#a16">NETWORK_COMPLETE_SEND</a>(0x0040);          <span class="comment">/* Send the packet      */</span>
00279         
00280         ARP_DEBUGOUT(<span class="stringliteral">"ARP Reply Sent..\n\r"</span>);
00281         
00282         <span class="comment">/* Add the Sender's info to cache because we can        */</span>
00283         
00284         <a class="code" href="arp_8c.html#a7">arp_add</a>(rem_ip, &amp;send_frame.destination[0], <a class="code" href="arp_8h.html#a17">ARP_TEMP_IP</a>);
00285         
00286         <span class="keywordflow">return</span>;
00287                 
00288 }
00289 
00290 
<a name="l00307"></a><a class="code" href="arp_8c.html#a4">00307</a> <span class="keywordtype">void</span> <a class="code" href="arp_8c.html#a4">arp_get_response</a>(<span class="keywordtype">void</span>)
00308 {
00309         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00310         UINT8 rem_hwadr[<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>];
00311         UINT32  rem_ip;
00312         UINT32  ltemp;
00313         INT8 i;
00314         UINT8 j;
00315         
00316         <span class="comment">/* Read Sender's HW address     */</span>
00317         
00318         <span class="keywordflow">for</span>( i=<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>-1; i &gt;= 0; i-- )
00319                 rem_hwadr[i] = <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00320                 
00321         <span class="comment">/* Read Sender's IP Address     */</span>
00322         
00323         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="arp_8h.html#a1">MAXPRALEN</a>; i++) {
00324                 rem_ip &lt;&lt;= 8;
00325                 rem_ip |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00326         }
00327         
00328         
00329         <span class="comment">/* Skip our HW Address  */</span>
00330         
00331         <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>; i++)
00332                 <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00333         
00334         
00335         <span class="comment">/* Is The Packet For Us?        */</span>
00336         
00337         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="arp_8h.html#a1">MAXPRALEN</a>; i++)     {
00338                 ltemp &lt;&lt;= 8;
00339                 ltemp |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00340         }
00341                 
00342         
00343         <span class="keywordflow">if</span>( ltemp != localmachine.localip ) 
00344                 <span class="keywordflow">return</span>;                                                         <span class="comment">/* No   */</span>
00345 
00346         ARP_DEBUGOUT(<span class="stringliteral">"Now entering to process ARP Reply..\n\r"</span>);
00347         
00348         <span class="comment">/* Are we waiting for that reply?       */</span>
00349         
00350         <span class="keywordflow">for</span>( i=1; i&lt;ARP_TSIZE; i++ ) {
00351                 qstruct = &amp;arp_table[i];
00352                 
00353                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> == <a class="code" href="arp_8h.html#a11">ARP_FREE</a> )
00354                         <span class="keywordflow">continue</span>;
00355                 
00356                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> == <a class="code" href="arp_8h.html#a12">ARP_RESERVED</a> )
00357                         <span class="keywordflow">continue</span>;                               
00358                 
00359                 <span class="keywordflow">if</span>( rem_ip == qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> ) {
00360                         <span class="comment">/* We are caching that IP, refresh it   */</span>
00361                         
00362                         ARP_DEBUGOUT(<span class="stringliteral">"Refreshing ARP cache from Reply..\n\r"</span>);
00363                         
00364                         <span class="keywordflow">for</span>( j=0; j&lt;<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>; j++ )            
00365                                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[j] = rem_hwadr[j];
00366                                 
00367                         qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a1">ARP_TIMEOUT</a>;
00368                         qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> = <a class="code" href="group__opentcp__config.html#a3">ARP_MAXRETRY</a>;                                <span class="comment">/* No need for Retry    */</span>
00369                         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a14">ARP_RESOLVED</a>;
00370                 
00371                         <span class="comment">/* Done */</span>
00372                         
00373                         <span class="keywordflow">break</span>;
00374                 }       
00375         
00376         }
00377 
00378 }
00379 
<a name="l00390"></a><a class="code" href="arp_8c.html#a5">00390</a> <span class="keywordtype">void</span> <a class="code" href="arp_8c.html#a5">arp_send_req</a> (UINT8 entry)
00391 {
00392 
00393         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00394         UINT8 i;
00395         
00396         qstruct = &amp;arp_table[entry];
00397         
00398         <a class="code" href="system_8h.html#a17">NETWORK_SEND_INITIALIZE</a>(<a class="code" href="ethernet_8h.html#a35">ARP_BUFFER</a>);
00399         
00400         <span class="comment">/* Add datalink (Ethernet addresses) information        */</span>
00401         
00402         <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>; i++) {
00403                 send_frame.destination[i] = 0xFF;
00404                 send_frame.source[i] = localmachine.localHW[i];
00405         }
00406         
00407         send_frame.protocol = <a class="code" href="ethernet_8h.html#a5">PROTOCOL_ARP</a>;
00408         
00409         <a class="code" href="system_8h.html#a18">NETWORK_ADD_DATALINK</a>(&amp;send_frame);
00410         
00411         <span class="comment">/* PUT ARP Data */</span>
00412 
00413         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (BYTE) (AR_HARDWARE&gt;&gt;8) );                      <span class="comment">/* Hardware Type        */</span>
00414         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (BYTE) AR_HARDWARE );
00415         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(0x08);                                                           <span class="comment">/* Protocol Type        */</span>
00416         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(0x00);
00417         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>);                                                      <span class="comment">/* HW Adr Len           */</span>
00418         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>(<a class="code" href="arp_8h.html#a1">MAXPRALEN</a>);                                                      <span class="comment">/* Protocol Adr. Len*/</span>
00419         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (BYTE)(ARP_REQUEST&gt;&gt;8));                        <span class="comment">/* ARP Opcode           */</span>
00420         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>( (BYTE) ARP_REQUEST );
00421         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)localmachine.localHW[5]);         <span class="comment">/* Address fields       */</span>
00422         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)localmachine.localHW[4]);
00423         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)localmachine.localHW[3]);
00424         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)localmachine.localHW[2]);
00425         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)localmachine.localHW[1]);
00426         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)localmachine.localHW[0]);
00427         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localip&gt;&gt;24));
00428         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localip&gt;&gt;16));
00429         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(localmachine.localip&gt;&gt;8));
00430         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)localmachine.localip);
00431         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)0xFF);
00432         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)0xFF);
00433         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)0xFF);
00434         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)0xFF);
00435         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)0xFF);
00436         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)0xFF);                                            
00437         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a>&gt;&gt;24));
00438         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a>&gt;&gt;16));
00439         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)(qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a>&gt;&gt;8));
00440         <a class="code" href="system_8h.html#a11">SEND_NETWORK_B</a>((UINT8)qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a>);
00441         
00442         
00443         <span class="comment">/* Packet assembled now, just send it ... */</span>
00444         
00445         <a class="code" href="system_8h.html#a16">NETWORK_COMPLETE_SEND</a>(0x0040);                                          <span class="comment">/* Min packet size      */</span>
00446  
00447         ARP_DEBUGOUT(<span class="stringliteral">"ARP Request Sent\n\r"</span>);
00448         
00449 }
00450 
00451 
<a name="l00466"></a><a class="code" href="arp_8c.html#a6">00466</a> INT8 <a class="code" href="arp_8c.html#a6">arp_alloc</a> (UINT8 type)
00467 {
00468         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00469         INT8 i;
00470         <span class="keyword">static</span> BYTE aenext = 1;         <span class="comment">/* Cache Manager        */</span>
00471         INT16 found;
00472         
00473         <span class="comment">/* try to find free entry */</span>
00474         found=-1;
00475 
00476         <span class="keywordflow">for</span>( i=0; i&lt;ARP_TSIZE; i++ ) {
00477         
00478                 <span class="keywordflow">if</span>( arp_table[i].<a class="code" href="structarp__entry.html#m0">state</a> == <a class="code" href="arp_8h.html#a11">ARP_FREE</a> ) {
00479                         found=i;
00480                         <span class="keywordflow">break</span>;
00481                 }
00482         }
00483         
00484         <span class="keywordflow">if</span>(found != (-1) ) {
00485                 qstruct = &amp;arp_table[found];
00486                 qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a12">ARP_RESERVED</a>;
00487                 qstruct-&gt;<a class="code" href="structarp__entry.html#m1">type</a> = type;   
00488                 <span class="keywordflow">return</span>( (UINT8)found );
00489         }
00490 
00491 
00492         <span class="comment">/* if no success, try ro find first temporary entry     */</span>
00493         <span class="comment">/* on round-robin fashion                                                       */</span>
00494         
00495 
00496         <span class="keywordflow">for</span>( i=0; i&lt;ARP_TSIZE; i++ ) {  
00497                 <span class="keywordflow">if</span>( arp_table[aenext].<a class="code" href="structarp__entry.html#m1">type</a> == <a class="code" href="arp_8h.html#a17">ARP_TEMP_IP</a>) {
00498                         found = aenext;                 
00499                         <span class="keywordflow">break</span>;
00500                 }
00501                         
00502                 <span class="comment">/* Move to next entry */</span>
00503         
00504                 aenext = (aenext + 1);
00505                 <span class="keywordflow">if</span>( aenext &gt;= ARP_TSIZE )
00506                         aenext = 1;
00507                         
00508         }
00509         
00510         
00511         <span class="comment">/* Was there free or temporary entries? */</span>
00512         
00513         <span class="keywordflow">if</span>( found == (-1) )
00514                 <span class="keywordflow">return</span>(-1);
00515                 
00516         <span class="comment">/* Next time start from next entry      */</span>
00517         
00518         aenext = (aenext + 1);  
00519         <span class="keywordflow">if</span>( aenext &gt;= ARP_TSIZE )
00520                 aenext = 1;             
00521 
00522         qstruct = &amp;arp_table[found];
00523         
00524         <span class="comment">/* Set ARP initial parameters   */</span>
00525         
00526         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a12">ARP_RESERVED</a>;
00527         qstruct-&gt;<a class="code" href="structarp__entry.html#m1">type</a> = type;
00528         
00529         <span class="comment">/* Was return(i)!!! &lt;-wrong!!   */</span>
00530         
00531         <span class="keywordflow">return</span>((UINT8)found);
00532 
00533 
00534 }
<a name="l00552"></a><a class="code" href="arp_8c.html#a7">00552</a> INT8 <a class="code" href="arp_8c.html#a7">arp_add</a> (UINT32 pra, UINT8* hwadr, UINT8 type)
00553 {
00554         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00555         INT8 i;
00556         INT8 j;
00557 
00558         <span class="keywordflow">for</span>( i=0; i&lt;ARP_TSIZE; i++ ) {
00559                 qstruct = &amp;arp_table[i];
00560                 
00561                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> == <a class="code" href="arp_8h.html#a11">ARP_FREE</a> )
00562                         <span class="keywordflow">continue</span>;
00563                         
00564                 <span class="keywordflow">if</span>((qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> == pra)&amp;&amp;(pra != IP_BROADCAST_ADDRESS)) {
00565                         <span class="comment">/* The address is in cache, refresh it   */</span>
00566                         
00567                         ARP_DEBUGOUT(<span class="stringliteral">" Refreshing Existing ARP Entry..\n\r"</span>);
00568                 
00569                         <span class="keywordflow">for</span>( j=0; j&lt;<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>; j++ )            
00570                                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[j] = *hwadr++;
00571                                 
00572                         qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a1">ARP_TIMEOUT</a>;
00573                         qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> = <a class="code" href="group__opentcp__config.html#a3">ARP_MAXRETRY</a>;
00574                         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a14">ARP_RESOLVED</a>;
00575         
00576                         <span class="comment">/* All OK       */</span>
00577                 
00578                         <span class="keywordflow">return</span> (0);     
00579                 }
00580         
00581         }
00582         
00583         <span class="keywordflow">if</span>(<a class="code" href="arp_8c.html#a11">is_subnet</a>(pra,&amp;localmachine) == <a class="code" href="system_8h.html#a2">FALSE</a>){
00584                 <span class="keywordflow">return</span> (-1);
00585         }
00586         
00587         <span class="keywordflow">if</span>( localmachine.defgw == pra ) {
00588                 <span class="keywordflow">if</span>(localmachine.defgw != 0) {
00589                         type = <a class="code" href="arp_8h.html#a16">ARP_FIXED_IP</a>;
00590                 }
00591         }
00592 
00593         
00594         <span class="comment">/* Address was'nt on cache. Need to allocate new one    */</span>
00595         
00596         ARP_DEBUGOUT(<span class="stringliteral">"Allocating New ARP Entry..\n\r"</span>);
00597         
00598         i = <a class="code" href="arp_8c.html#a6">arp_alloc</a>(type);
00599         
00600         <span class="keywordflow">if</span>( i &lt; 0 )                             <span class="comment">/* No Entries Left?     */</span>
00601                 <span class="keywordflow">return</span>(-1);
00602                         
00603         <span class="comment">/* Fill the fields              */</span>
00604                 
00605         qstruct = &amp;arp_table[i];
00606                 
00607         qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> = pra;                                                                           <span class="comment">/* Fill IP                              */</span>
00608         
00609         <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>; i++)
00610                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[i] = *hwadr++;                                                   <span class="comment">/* Fill HW address              */</span>
00611 
00612         qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> = <a class="code" href="group__opentcp__config.html#a3">ARP_MAXRETRY</a>;
00613         qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a1">ARP_TIMEOUT</a>;
00614         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a14">ARP_RESOLVED</a>;                          
00615         
00616         ARP_DEBUGOUT(<span class="stringliteral">"ARP Entry Created!..\n\r"</span>);
00617 
00618         <span class="keywordflow">return</span>(1);
00619 
00620 }
00621  
<a name="l00639"></a><a class="code" href="arp_8c.html#a8">00639</a> <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a>* arp_find (LWORD pra, struct netif *machine, UINT8 type)
00640 {
00641         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00642         INT8 i;
00643         
00644         ARP_DEBUGOUT(<span class="stringliteral">"Trying to find MAC address from ARP Cache\n\r"</span>);
00645         
00646         <span class="comment">/* Is the address in the cache  */</span>
00647         
00648         <span class="keywordflow">for</span>( i=0; i&lt;ARP_TSIZE; i++ ) {
00649                 qstruct = &amp;arp_table[i];
00650                 
00651                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> == <a class="code" href="arp_8h.html#a11">ARP_FREE</a> )
00652                         <span class="keywordflow">continue</span>;
00653                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> == pra) {
00654                         <span class="comment">/* The address is in cache, is it valid? */</span>
00655                         
00656                         ARP_DEBUGOUT(<span class="stringliteral">"Address In Cache\n\r"</span>);
00657                         
00658                         <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> &lt; <a class="code" href="arp_8h.html#a14">ARP_RESOLVED</a> ) {
00659                                 ARP_DEBUGOUT(<span class="stringliteral">"Address in cache but unresolved :(\n\r"</span>);
00660                                 <span class="keywordflow">return</span>(0);
00661                         }
00662                         <span class="comment">/* All OK       */</span>
00663                 
00664                         <span class="keywordflow">return</span>(qstruct);        
00665                 }
00666         
00667         }
00668         
00669         <span class="comment">/* The address wasn't on the cache. Is it in our Subnet?        */</span>
00670         
00671         <span class="keywordflow">if</span>( <a class="code" href="arp_8c.html#a11">is_subnet</a>(pra, machine) ) {
00672                 <span class="comment">/* Yep, we need to send ARP REQUEST     */</span>
00673                 
00674                 ARP_DEBUGOUT(<span class="stringliteral">"Need to send ARP Request to local network..\n\r"</span>);
00675                 
00676                 <span class="keywordflow">if</span>( machine-&gt;defgw == pra ) {
00677                         <span class="keywordflow">if</span>(machine-&gt;defgw != 0) {
00678                                 type = <a class="code" href="arp_8h.html#a16">ARP_FIXED_IP</a>;
00679                         }
00680                 }
00681                 i = <a class="code" href="arp_8c.html#a6">arp_alloc</a>(type);
00682                 
00683                 <span class="keywordflow">if</span>( i &lt; 0 )                             <span class="comment">/* No Entries Left?     */</span>
00684                         <span class="keywordflow">return</span>(0);
00685                         
00686                 <span class="comment">/* Send Request after filling the fields        */</span>
00687                 
00688                 qstruct = &amp;arp_table[i];
00689                 
00690                 qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> = pra;                                           <span class="comment">/* Fill IP                              */</span>
00691                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[0] = 0xFF;                                       <span class="comment">/* Fill Broadcast IP    */</span>
00692                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[1] = 0xFF;
00693                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[2] = 0xFF;
00694                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[3] = 0xFF;
00695                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[4] = 0xFF;
00696                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[5] = 0xFF;
00697                 qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> = <a class="code" href="group__opentcp__config.html#a3">ARP_MAXRETRY</a>;
00698                 qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a2">ARP_RESEND</a>;
00699                 <a class="code" href="arp_8c.html#a5">arp_send_req</a>( i );
00700                 qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a13">ARP_PENDING</a>;                           <span class="comment">/* Waiting for Reply    */</span>
00701                 
00702                 <span class="keywordflow">return</span>(0);
00703         
00704         } 
00705 
00706         <span class="comment">/* The Address belongst to the outern world, need to use MAC of                 */</span>
00707         <span class="comment">/* Default Gateway                                                                                                              */</span>
00708         
00709         ARP_DEBUGOUT(<span class="stringliteral">"Need to use MAC of Default GW\n\r"</span>);
00710         
00711         <span class="comment">/* Check for Broadcast                                                                                                  */</span>
00712         
00713         <span class="keywordflow">if</span>(machine-&gt;defgw == 0)                         <span class="comment">/* It's not specified   */</span>
00714                 <span class="keywordflow">return</span>(0);
00715         
00716         
00717         <span class="keywordflow">for</span>( i=0; i&lt;ARP_TSIZE; i++ ) {
00718                 qstruct = &amp;arp_table[i];
00719                 
00720                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> == <a class="code" href="arp_8h.html#a11">ARP_FREE</a> )
00721                         <span class="keywordflow">continue</span>;
00722                         
00723                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> == machine-&gt;defgw ) {
00724                         <span class="comment">/* The address is in cache, is it valid? */</span>
00725                  
00726                         
00727                         <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> &lt; <a class="code" href="arp_8h.html#a14">ARP_RESOLVED</a> ) {
00728                                 ARP_DEBUGOUT(<span class="stringliteral">"The Address of Def. GW is not Solved!\n\r"</span>);
00729                                 <span class="keywordflow">return</span>(0);
00730                         }
00731                 
00732                         <span class="comment">/* All OK       */</span>
00733                         
00734                         ARP_DEBUGOUT(<span class="stringliteral">" &gt;&gt; Default Gateway MAC found!\n\r"</span>);
00735                 
00736                         <span class="keywordflow">return</span>(qstruct);
00737                                 
00738                 }
00739         
00740         }
00741         
00742         ARP_DEBUGOUT(<span class="stringliteral">"Need to send ARP Request to default gateway..\n\r"</span>);
00743                 
00744         i = <a class="code" href="arp_8c.html#a6">arp_alloc</a>(<a class="code" href="arp_8h.html#a16">ARP_FIXED_IP</a>);
00745                 
00746         <span class="keywordflow">if</span>( i &lt; 0 )                             <span class="comment">/* No Entries Left?     */</span>
00747                 <span class="keywordflow">return</span>(0);
00748                         
00749         <span class="comment">/* Send Request after filling the fields        */</span>
00750                 
00751         qstruct = &amp;arp_table[i];
00752                 
00753         qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> = machine-&gt;defgw;                                                <span class="comment">/* Fill IP                              */</span>
00754         qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[0] = 0xFF;                                       <span class="comment">/* Fill Broadcast IP    */</span>
00755         qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[1] = 0xFF;
00756         qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[2] = 0xFF;
00757         qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[3] = 0xFF;
00758         qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[4] = 0xFF;
00759         qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[5] = 0xFF;
00760         qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> = <a class="code" href="group__opentcp__config.html#a3">ARP_MAXRETRY</a>;
00761         qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a2">ARP_RESEND</a>;
00762         <a class="code" href="arp_8c.html#a5">arp_send_req</a>( i );
00763         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a13">ARP_PENDING</a>;                           <span class="comment">/* Waiting for Reply    */</span>
00764         
00765         <span class="keywordflow">return</span>(0);
00766 
00767         
00768 }
00769 
00770 
<a name="l00785"></a><a class="code" href="arp_8c.html#a0">00785</a> <span class="keywordtype">void</span> <a class="code" href="group__periodic__functions.html#a0">arp_manage</a> (<span class="keywordtype">void</span>)
00786 {
00787         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00788         UINT8 i,j;
00789         <span class="keyword">static</span> UINT8 aenext=0;
00790         
00791         <span class="comment">/* Check Timer before entering  */</span>
00792         
00793         <span class="keywordflow">if</span>( <a class="code" href="timers_8c.html#a7">check_timer</a>(<a class="code" href="arp_8c.html#a1">arp_timer</a>) )
00794                 <span class="keywordflow">return</span>;
00795                 
00796         <a class="code" href="timers_8c.html#a6">init_timer</a>( <a class="code" href="arp_8c.html#a1">arp_timer</a>, ARP_MANG_TOUT*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
00797         
00798         <span class="comment">/* DEBUGOUT("Managing ARP Cache\n\r"); */</span>
00799         
00800         <span class="keywordflow">for</span>( i=0; i&lt;ARP_TSIZE; i++ ) {
00801                 <span class="comment">/* DEBUGOUT("."); */</span>
00802         
00803                 qstruct = &amp;arp_table[aenext];
00804                 
00805                 j = aenext;
00806                 
00807                 <span class="comment">/* Take next entry next time    */</span>
00808                                 
00809                 aenext++;
00810                 <span class="keywordflow">if</span>(aenext &gt;= ARP_TSIZE)
00811                         aenext = 0;     
00812         
00813                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> == <a class="code" href="arp_8h.html#a11">ARP_FREE</a> )
00814                         <span class="keywordflow">continue</span>;
00815                         
00816                 <span class="comment">/* TODO: How about ARP_RESERVED?        */</span>
00817                         
00818                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> &gt; 0 )                          <span class="comment">/* Aging                */</span>
00819                         qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> --;
00820                 
00821                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> == 0 ) {                       <span class="comment">/* Timed Out?   */</span>
00822                         <span class="comment">/* Do it for temporay entries   */</span>
00823                         
00824                         ARP_DEBUGOUT(<span class="stringliteral">"Found Timed out Entry..\n\r"</span>);
00825                 
00826                         <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m1">type</a> == <a class="code" href="arp_8h.html#a17">ARP_TEMP_IP</a> ) {
00827 
00828                                 <span class="comment">/* Release it?  */</span>
00829                                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> == <a class="code" href="arp_8h.html#a14">ARP_RESOLVED</a> ) {  
00830                                         ARP_DEBUGOUT(<span class="stringliteral">"Releasing ARP Entry..\n\r"</span>);
00831                                         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a11">ARP_FREE</a>;
00832                                         <span class="keywordflow">continue</span>;
00833                                 }
00834                                 
00835                                 <span class="comment">/* Decrease retries left        */</span>
00836                                 
00837                                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> &gt; 0 )      
00838                                         qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a>--;
00839                                 
00840                                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> == 0 )     {
00841                                         ARP_DEBUGOUT(<span class="stringliteral">"ARP Replies Used up, releasing entry..\n\r"</span>);
00842                                         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a11">ARP_FREE</a>;
00843                                         <span class="keywordflow">continue</span>;
00844                                 }
00845                                 
00846                                 <span class="comment">/* So we need to resend ARP request     */</span>
00847                                 
00848                                 ARP_DEBUGOUT(<span class="stringliteral">"Trying to Resolve dynamic ARP Entry..\n\r"</span>);
00849                         
00850                                 qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a2">ARP_RESEND</a>;
00851                                 <a class="code" href="arp_8c.html#a5">arp_send_req</a>( j );
00852                                 qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a13">ARP_PENDING</a>;                           <span class="comment">/* Waiting for Reply    */</span>                      
00853                                 
00854                                 <span class="keywordflow">return</span>;
00855                         
00856                         }
00857                 
00858                         <span class="comment">/* Do it for Static Entries                     */</span>
00859                 
00860                         <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m1">type</a> == <a class="code" href="arp_8h.html#a16">ARP_FIXED_IP</a> ) {
00861                                 
00862                                 <span class="comment">/* So we need to resend ARP request     */</span>
00863                                 
00864                                 <span class="comment">/* Do not try to refresh broadcast      */</span>
00865                                 
00866                                 <span class="keywordflow">if</span>(qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> == IP_BROADCAST_ADDRESS)      {
00867                                         qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a1">ARP_TIMEOUT</a>;
00868                                         <span class="keywordflow">continue</span>;
00869                                 }
00870                                 
00871                                 ARP_DEBUGOUT(<span class="stringliteral">"Refreshing Static ARP Entry..\n\r"</span>);
00872                                 
00873                                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> &gt; 0 )      
00874                                         qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a>--;
00875                                 
00876                                 <span class="keywordflow">if</span>( qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> == 0 )
00877                                         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a13">ARP_PENDING</a>;
00878                                 <span class="keywordflow">else</span>
00879                                         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a15">ARP_REFRESHING</a>;
00880                         
00881                                 qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a2">ARP_RESEND</a>;
00882                                 
00883                                 <a class="code" href="arp_8c.html#a5">arp_send_req</a>( j );
00884                                 
00885                                 <span class="keywordflow">return</span>;
00886                         
00887                         }
00888                 
00889                 }
00890         
00891         }
00892 
00893 
00894 }
00895 
00896 
00897 
<a name="l00910"></a><a class="code" href="arp_8c.html#a0">00910</a> <span class="keywordtype">void</span> <a class="code" href="group__core__initializer.html#a0">arp_init</a> (<span class="keywordtype">void</span>)
00911 {
00912         <span class="keyword">struct </span><a class="code" href="structarp__entry.html">arp_entry</a> *qstruct;
00913         INT8 i;
00914         
00915         ARP_DEBUGOUT(<span class="stringliteral">"Initializing ARP"</span>);
00916         
00917         <span class="keywordflow">for</span>( i=0; i&lt;ARP_TSIZE; i++ ) {
00918                 qstruct = &amp;arp_table[i];
00919                 
00920                 qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a11">ARP_FREE</a>;
00921                 qstruct-&gt;<a class="code" href="structarp__entry.html#m1">type</a> = <a class="code" href="arp_8h.html#a17">ARP_TEMP_IP</a>;
00922                 
00923                 ARP_DEBUGOUT(<span class="stringliteral">"."</span>);
00924         }
00925         
00926         <a class="code" href="arp_8c.html#a1">arp_timer</a> = <a class="code" href="timers_8c.html#a2">get_timer</a>();
00927         <a class="code" href="timers_8c.html#a6">init_timer</a>(<a class="code" href="arp_8c.html#a1">arp_timer</a>, ARP_MANG_TOUT*<a class="code" href="timers_8h.html#a1">TIMERTIC</a>);
00928 
00929         <span class="comment">/* set broadcast entry  */</span>
00930         
00931         qstruct = &amp;arp_table[0];
00932         qstruct-&gt;<a class="code" href="structarp__entry.html#m5">pradr</a> = IP_BROADCAST_ADDRESS;
00933         qstruct-&gt;<a class="code" href="structarp__entry.html#m0">state</a> = <a class="code" href="arp_8h.html#a14">ARP_RESOLVED</a>;
00934         qstruct-&gt;<a class="code" href="structarp__entry.html#m1">type</a> = <a class="code" href="arp_8h.html#a16">ARP_FIXED_IP</a>;
00935         qstruct-&gt;<a class="code" href="structarp__entry.html#m3">ttl</a> = <a class="code" href="group__opentcp__config.html#a1">ARP_TIMEOUT</a>;
00936         qstruct-&gt;<a class="code" href="structarp__entry.html#m2">retries</a> = <a class="code" href="group__opentcp__config.html#a3">ARP_MAXRETRY</a>;        
00937         
00938         <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="arp_8h.html#a0">MAXHWALEN</a>; i++)
00939                 qstruct-&gt;<a class="code" href="structarp__entry.html#m4">hwadr</a>[i] = 0xFF;                                                       
00940         
00941         ARP_DEBUGOUT(<span class="stringliteral">"\n\r"</span>);
00942         
00943 }
<a name="l00960"></a><a class="code" href="arp_8c.html#a11">00960</a> BYTE <a class="code" href="arp_8c.html#a11">is_subnet</a> (LWORD ipadr, <span class="keyword">struct</span> netif* machine)
00961 {
00962 
00963         UINT32 ltemp;
00964 
00965         ltemp = ipadr &amp; machine-&gt;<a class="code" href="structnetif.html#m3">netmask</a>;                                               <span class="comment">/* Get Subnet part      */</span>
00966         
00967         ltemp ^= (machine-&gt;<a class="code" href="structnetif.html#m0">localip</a> &amp; machine-&gt;<a class="code" href="structnetif.html#m3">netmask</a>);                 <span class="comment">/* Compare to my IP     */</span>
00968         
00969         <span class="keywordflow">if</span>( ltemp )
00970                 <span class="keywordflow">return</span>(FALSE);
00971         
00972         <span class="keywordflow">return</span>(TRUE);
00973 
00974 }
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:32:59 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
