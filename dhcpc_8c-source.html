<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/dhcp/dhcpc.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/dhcp/dhcpc.c</h1><a href="dhcpc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright </span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright </span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the </span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if </span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola </span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself, </span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to </span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior </span>
00026 <span class="comment"> *written permission. For written permission, please contact </span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP", </span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written </span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED </span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE </span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR </span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE </span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, </span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series </span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to </span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see </span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00071 <span class="preprocessor">#include&lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00072 <span class="preprocessor">#include&lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00073 <span class="preprocessor">#include&lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00074 <span class="preprocessor">#include&lt;<a class="code" href="tcp__ip_8h.html">inet/tcp_ip.h</a>&gt;</span>
00075 <span class="preprocessor">#include&lt;<a class="code" href="timers_8h.html">inet/timers.h</a>&gt;</span>
00076 <span class="preprocessor">#include&lt;<a class="code" href="arp_8h.html">inet/arp.h</a>&gt;</span>
00077 <span class="preprocessor">#include&lt;<a class="code" href="ethernet_8h.html">inet/ethernet.h</a>&gt;</span>
00078 <span class="preprocessor">#include&lt;<a class="code" href="dhcpc_8h.html">inet/dhcp/dhcpc.h</a>&gt;</span>
00079 
<a name="l00087"></a><a class="code" href="dhcpc_8c.html#a0">00087</a> UINT8 <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>;
00088 
<a name="l00094"></a><a class="code" href="dhcpc_8c.html#a1">00094</a> UINT8 <a class="code" href="dhcpc_8c.html#a1">dhcpc_timer_handle</a>;
00095 
<a name="l00100"></a><a class="code" href="dhcpc_8c.html#a2">00100</a> INT8 <a class="code" href="dhcpc_8c.html#a2">dhcpc_soc_handle</a>;
00101 
<a name="l00106"></a><a class="code" href="dhcpc_8c.html#a3">00106</a> UINT8   <a class="code" href="dhcpc_8c.html#a3">dhcpc_initialized</a>=0;
00107 
<a name="l00115"></a><a class="code" href="dhcpc_8c.html#a4">00115</a> UINT32 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>;
00116 
<a name="l00124"></a><a class="code" href="dhcpc_8c.html#a5">00124</a> UINT32 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>;
00125 
<a name="l00131"></a><a class="code" href="dhcpc_8c.html#a6">00131</a> UINT32 <a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>;
00132 
<a name="l00140"></a><a class="code" href="dhcpc_8c.html#a7">00140</a> UINT32 <a class="code" href="dhcpc_8c.html#a7">dhcpc_requested_ip</a>;
00141 
00142 INT32 <a class="code" href="dhcpc_8c.html#a8">dhcpc_eventlistener</a>(INT8 cbhandle, UINT8 event, UINT32 ipaddr, UINT16 port, UINT16 buffindex, UINT16 datalen);
00143 INT8 <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(UINT8 msg_type);
00144 
<a name="l00158"></a><a class="code" href="dhcpc_8c.html#a10">00158</a> INT8 <a class="code" href="dhcpc_8c.html#a10">dhcpc_init</a>(<span class="keywordtype">void</span>)
00159 {
00160         
00161         <span class="comment">/* If we already have some IP address (stored from some previous</span>
00162 <span class="comment">         * requests, try obtaining it again */</span>  
00163         <span class="keywordflow">if</span>((localmachine.localip!=0)&amp;&amp;(localmachine.localip!=0xffffffff)){
00164                 <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_INIT_REBOOT;
00165         }<span class="keywordflow">else</span>{
00166                 <span class="comment">/* start from beginning */</span>
00167                 <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_INIT;
00168                 }
00169         
00170         <a class="code" href="dhcpc_8c.html#a2">dhcpc_soc_handle</a>=<a class="code" href="udp_8c.html#a3">udp_getsocket</a>(0,<a class="code" href="dhcpc_8c.html#a8">dhcpc_eventlistener</a>,<a class="code" href="tcp__ip_8h.html#a5">UDP_OPT_SEND_CS</a>|<a class="code" href="tcp__ip_8h.html#a6">UDP_OPT_CHECK_CS</a>);
00171         
00172         <span class="keywordflow">if</span>(<a class="code" href="dhcpc_8c.html#a2">dhcpc_soc_handle</a>&lt;0){
00173                 DEBUGOUT(<span class="stringliteral">"DHCP client not able to obtain socket!\r\n"</span>);
00174                 <span class="keywordflow">return</span> (-1);
00175         }       
00176         
00177         <span class="comment">/* open socket for communication immediately */</span>
00178         <a class="code" href="udp_8c.html#a5">udp_open</a>(<a class="code" href="dhcpc_8c.html#a2">dhcpc_soc_handle</a>,DHCP_CLIENT_PORT);
00179         
00180         <span class="comment">/* get timer handle */</span>
00181         <a class="code" href="dhcpc_8c.html#a1">dhcpc_timer_handle</a>=<a class="code" href="timers_8c.html#a2">get_timer</a>();
00182         
00183         <span class="comment">/* initialize timer for 1 sec intervals */</span>
00184         <a class="code" href="timers_8c.html#a6">init_timer</a>(<a class="code" href="dhcpc_8c.html#a1">dhcpc_timer_handle</a>,<a class="code" href="timers_8h.html#a1">TIMERTIC</a>*1);      <span class="comment">/* on every second */</span>
00185         
00186         <a class="code" href="dhcpc_8c.html#a3">dhcpc_initialized</a>=1;
00187         DEBUGOUT(<span class="stringliteral">"DHCP Client initialized\r\n"</span>);
00188         
00189         <span class="keywordflow">return</span> (0);
00190 }
00191 
<a name="l00201"></a><a class="code" href="dhcpc_8c.html#a11">00201</a> <span class="keywordtype">void</span> <a class="code" href="dhcpc_8c.html#a11">dhcpc_run</a>(<span class="keywordtype">void</span>){
00202         UINT8 sec=0;
00203         
00204         <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a3">dhcpc_initialized</a>)
00205                 <span class="keywordflow">return</span>;
00206                 
00207         <span class="keywordflow">if</span>(!<a class="code" href="timers_8c.html#a7">check_timer</a>(<a class="code" href="dhcpc_8c.html#a1">dhcpc_timer_handle</a>))
00208                 sec=1;
00209         
00210         <span class="keywordflow">switch</span>(dhcpc_state){
00211                 <span class="keywordflow">case</span> DHCP_STATE_INIT_REBOOT:
00212                         <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_REBOOTING;
00213                         <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=4;     <span class="comment">/* next retransmission in 4 secs */</span>
00214                         <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>=8;     <span class="comment">/* after that after 8 secs retrs */</span>
00215                         <a class="code" href="dhcpc_8c.html#a7">dhcpc_requested_ip</a>=localmachine.localip;
00216                         <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_REQUEST);
00217                         <span class="keywordflow">break</span>;
00218 
00219                 <span class="keywordflow">case</span> DHCP_STATE_REBOOTING:
00220                         <span class="keywordflow">if</span>(sec)
00221                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>--;
00222                         
00223                         <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>){
00224                                 <span class="keywordflow">if</span>(<a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>&gt;=32){
00225                                         <span class="comment">/* we need to restart, we don't want to wait more</span>
00226 <span class="comment">                                         * than 30 secs for retransmissions</span>
00227 <span class="comment">                                         */</span>
00228                                          <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_INIT_REBOOT;
00229                                 }<span class="keywordflow">else</span>{
00230                                         <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=<a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>;
00231                                         <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>&lt;&lt;=1;   <span class="comment">/* exponential backoff retransmission */</span>
00232                                         <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_REQUEST);
00233                                 }                       
00234                         }               
00235                         <span class="keywordflow">break</span>;
00236                 <span class="keywordflow">case</span> DHCP_STATE_INIT:
00237                         <span class="comment">/* switch to selecting, send DHCPDISCOVER and initialize</span>
00238 <span class="comment">                         * timeout timer</span>
00239 <span class="comment">                         */</span>
00240                         DEBUGOUT(<span class="stringliteral">"DHCP State=INIT; Sending DHCPDISCOVER message; State INIT--&gt;SELECTING\r\n"</span>);
00241                         <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_SELECTING;
00242                         <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_DISCOVER);
00243                         <span class="comment">/* T1 will be timeout timer. T2 will hold next timeout value */</span>
00244                         <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=4;     <span class="comment">/* next retransmission after 4 secs */</span>
00245                         <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>=8;     <span class="comment">/* after 4 secs expire, this will be next timeout */</span>
00246                         <span class="keywordflow">break</span>;
00247                 <span class="keywordflow">case</span> DHCP_STATE_SELECTING:
00248                         <span class="comment">/* one second expired ? */</span>
00249                         <span class="keywordflow">if</span>(sec)
00250                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>--;
00251                         
00252                         <span class="comment">/* timeout expired without receiving DHCPOFFER ? */</span>
00253                         <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>){
00254                                 DEBUGOUT(<span class="stringliteral">"DHCP State=SELECTING; "</span>);
00255                                 <span class="comment">/* yes, retransmit or restart the process */</span>
00256                                 <span class="keywordflow">if</span>(<a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>&gt;=32){
00257                                         <span class="comment">/* we need to restart, we don't want to wait more</span>
00258 <span class="comment">                                         * than 30 secs for retransmissions</span>
00259 <span class="comment">                                         */</span>
00260                                          <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_INIT;
00261                                          DEBUGOUT(<span class="stringliteral">"Timeout for retransmissions too big; State SELECTING--&gt;INIT\r\n"</span>);
00262                                 }<span class="keywordflow">else</span>{
00263                                         DEBUGOUT(<span class="stringliteral">"Retransmitting DHCPDISCOVER\r\n"</span>);
00264                                         <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=<a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>;
00265                                         <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>&lt;&lt;=1;   <span class="comment">/* exponential backoff retransmission */</span>
00266                                         <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_DISCOVER);
00267                                 }
00268                         }
00269                         <span class="keywordflow">break</span>;
00270                 <span class="keywordflow">case</span> DHCP_STATE_REQUESTING:
00271                         <span class="comment">/* DHCPREQUEST sent, waiting for proper response. Retransmit</span>
00272 <span class="comment">                         * if necessary</span>
00273 <span class="comment">                         */</span>
00274                         <span class="keywordflow">if</span>(sec)
00275                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>--;
00276                          
00277                         <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>){
00278                                 <span class="comment">/* timeout occured without receiving DHCPACK */</span>
00279                                 DEBUGOUT(<span class="stringliteral">"DHCP State=REQUESTING; "</span>);
00280                                 <span class="keywordflow">if</span>(<a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>&gt;=32){
00281                                         <span class="comment">/* we need to restart, we don't want to wait more</span>
00282 <span class="comment">                                         * than 30 secs for retransmissions. Restart whole</span>
00283 <span class="comment">                                         * process</span>
00284 <span class="comment">                                         */</span>
00285                                          <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_INIT;
00286                                          DEBUGOUT(<span class="stringliteral">"Timeout for retransmits too big; State REQUESTING--&gt;INIT\r\n"</span>);
00287                                 }<span class="keywordflow">else</span>{
00288                                         DEBUGOUT(<span class="stringliteral">"Retransmitting DHCPREQUEST\r\n"</span>);
00289                                         <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=<a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>;
00290                                         <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>&lt;&lt;=1;   <span class="comment">/* exponential backoff retransmission */</span>
00291                                         <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_REQUEST);
00292                                 }                               
00293                         } 
00294                         <span class="keywordflow">break</span>;
00295                 <span class="keywordflow">case</span> DHCP_STATE_BOUND:
00296                         <span class="comment">/* wait for T1 to expire */</span>
00297                         <span class="keywordflow">if</span>(sec){
00298                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>--;
00299                                 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>--;
00300                         }
00301                         <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>){
00302                                 DEBUGOUT(<span class="stringliteral">"DHCP State=BOUND; Starting renewing process; State BOUND--&gt;RENEWING\r\n"</span>);
00303                                 <span class="comment">/* T1 expired, start renewing process */</span>
00304                                 <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_RENEWING;
00305                                 
00306                                 <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_REQUEST);
00307                                 
00308                                 <span class="comment">/* T1 will be used for retransmissions untill we</span>
00309 <span class="comment">                                 * return to BOUND state or reset to INIT state</span>
00310 <span class="comment">                                 */</span>
00311                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=10;    <span class="comment">/* fixed 10sec retransmissions */</span>
00312                         }
00313                         <span class="keywordflow">break</span>;
00314                 <span class="keywordflow">case</span> DHCP_STATE_RENEWING:
00315                         <span class="keywordflow">if</span>(sec){
00316                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>--;
00317                                 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>--;
00318                         }
00319                         
00320                         <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>){
00321                                 DEBUGOUT(<span class="stringliteral">"DHCP State=RENEWING; T2 expired; State RENEWING--&gt;REBINDING\r\n"</span>);
00322                                 <span class="comment">/* oh no, T2 also expired. switch to rebinding state. This</span>
00323 <span class="comment">                                 * is our last attempt to retain this IP address.</span>
00324 <span class="comment">                                 */</span>
00325                                 <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_REBINDING;
00326                                 
00327                                 <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_REQUEST);
00328                                 
00329                                 <span class="comment">/* dhcpc_t1 will be used for timeouts */</span>
00330                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=5;     <span class="comment">/* 5 second retransmits */</span>
00331                                 
00332                                 <span class="comment">/* dhcpc_t2 will be used for fixed numer of retries. This</span>
00333 <span class="comment">                                 * is a bit different than per RFC, but we don't want </span>
00334 <span class="comment">                                 * another 32-bit timer value for keeping lease time.</span>
00335 <span class="comment">                                 */</span>
00336                                 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>=10;
00337                         }<span class="keywordflow">else</span>
00338                                 <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>){
00339                                         DEBUGOUT(<span class="stringliteral">"DHCP State=RENEWING; Retransmitting DHCPREQUEST\r\n"</span>);        
00340                                         <span class="comment">/* retransmit DHCP REQUEST messages */</span>
00341                                         <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_REQUEST);
00342                                         <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=10;
00343                                 }
00344                         <span class="keywordflow">break</span>;
00345                 <span class="keywordflow">case</span> DHCP_STATE_REBINDING:
00346                         <span class="keywordflow">if</span>(sec)
00347                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>--;
00348                         
00349                         <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>){
00350                         
00351                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=5;     <span class="comment">/* 5 second retransmits */</span>
00352                                 
00353                                 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>--;     <span class="comment">/* retransmit count */</span>
00354                                 
00355                                 <span class="keywordflow">if</span>(!<a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>){
00356                                         DEBUGOUT(<span class="stringliteral">"DHCP State=REBINDING; Lease time expired; State REBINDING--&gt;INIT\r\n"</span>);
00357                                         <span class="comment">/* used up retransmission. Assume that lease time</span>
00358 <span class="comment">                                         * expired by now. Restart the process</span>
00359 <span class="comment">                                         */</span>
00360                                          <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_INIT;
00361                                          localmachine.localip=0;        <span class="comment">/* can't use this any more */</span>
00362                                 }<span class="keywordflow">else</span>{
00363                                         DEBUGOUT(<span class="stringliteral">"DHCP State=REBINDING; Retransmitting DHCPREQUEST\r\n"</span>);
00364                                         <span class="comment">/* still have some time */</span>
00365                                         <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_REQUEST);
00366                                 }
00367                         }
00368                         <span class="keywordflow">break</span>;
00369                 <span class="keywordflow">default</span>:
00370                         <span class="keywordflow">break</span>;
00371         }
00372         
00373         <span class="keywordflow">if</span>(sec){
00374                 <a class="code" href="timers_8c.html#a6">init_timer</a>(<a class="code" href="dhcpc_8c.html#a1">dhcpc_timer_handle</a>,<a class="code" href="timers_8h.html#a1">TIMERTIC</a>*1);
00375         }
00376 }
00377 
<a name="l00389"></a><a class="code" href="dhcpc_8c.html#a9">00389</a> INT8 <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(UINT8 msg_type)
00390 {
00391 
00392         UINT16 index;
00393         UINT8 *buf_ptr; <span class="comment">/* transmit buffer pointer */</span>
00394         
00395         <span class="comment">/* first clear transmit buffer to all zeroes */</span>
00396         <span class="keywordflow">for</span>(index=<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>;index&lt;<a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a>;index++)
00397                 net_buf[index]=0;
00398                 
00399         buf_ptr=net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>;
00400         
00401         <span class="comment">/* create DHCP message */</span>
00402         
00403         *buf_ptr++=BOOT_REQUEST;
00404         *buf_ptr++=0x01;                <span class="comment">/* htype=ethernet */</span>
00405         *buf_ptr++=0x06;                <span class="comment">/* hlen=6 for ethernet */</span>
00406         *buf_ptr++=0x00;                <span class="comment">/* hops=0 by clients */</span>
00407         
00408         <span class="comment">/* xid, use constant value for all requests (allowed by RFC) */</span>
00409         *buf_ptr++=0xAA;
00410         *buf_ptr++=0xBB;
00411         *buf_ptr++=0xCC;
00412         *buf_ptr++=0xDD;
00413         
00414         <span class="comment">/* seconds from boot. Fixed for now */</span>
00415         *buf_ptr++=0x00;
00416         *buf_ptr++=0x00;
00417         
00418         <span class="comment">/* flags, use broadcast */</span>
00419         *buf_ptr++=0x80;
00420         *buf_ptr++=0x00;
00421         
00422         <span class="comment">/* ciaddr. Sent only if client is in BOUND, RENEW or REBINDING</span>
00423 <span class="comment">         * state (RFC2131)</span>
00424 <span class="comment">         */</span>
00425         <span class="keywordflow">if</span>((<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>==DHCP_STATE_BOUND)
00426                 ||(<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>==DHCP_STATE_RENEWING)
00427                 ||(<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>==DHCP_STATE_REBINDING)){
00428                 *buf_ptr++=(UINT8)(localmachine.localip&gt;&gt;24);
00429                 *buf_ptr++=(UINT8)(localmachine.localip&gt;&gt;16);
00430                 *buf_ptr++=(UINT8)(localmachine.localip&gt;&gt;8);
00431                 *buf_ptr++=(UINT8)(localmachine.localip);               
00432         }<span class="keywordflow">else</span>{
00433                 buf_ptr+=4;     <span class="comment">/* skip 4 bytes, buffer zeroed already */</span>
00434         }
00435         
00436         <span class="comment">/* yiaddr, siaddr, giaddr, skip */</span>
00437         buf_ptr+=12;
00438         
00439         <span class="comment">/* chaddr */</span>
00440         *buf_ptr++=localmachine.localHW[5];
00441         *buf_ptr++=localmachine.localHW[4];
00442         *buf_ptr++=localmachine.localHW[3];
00443         *buf_ptr++=localmachine.localHW[2];
00444         *buf_ptr++=localmachine.localHW[1];
00445         *buf_ptr++=localmachine.localHW[0];
00446         buf_ptr+=10;
00447         
00448         <span class="comment">/* sname and file, skip */</span>
00449         buf_ptr+=192;
00450         
00451         <span class="comment">/* options field. First magic cookie */</span>
00452         *buf_ptr++=99;
00453         *buf_ptr++=130;
00454         *buf_ptr++=83;
00455         *buf_ptr++=99;
00456 
00457         <span class="comment">/* message type */</span>
00458         *buf_ptr++=DHCP_OPT_MSG_TYPE;
00459         *buf_ptr++=1;
00460         *buf_ptr++=msg_type;
00461                 
00462         <span class="comment">/* next depends on what state we're in and message type */</span>
00463         <span class="keywordflow">switch</span>(msg_type){
00464 
00465                 <span class="keywordflow">case</span> DHCP_REQUEST:
00466                 <span class="keywordflow">case</span> DHCP_DECLINE: <span class="comment">/* sent only from REQUESTING state */</span>
00467 
00468                         <span class="comment">/* Requested IP address MUST NOT be sent in RENEWING and</span>
00469 <span class="comment">                         * REBINDING states (RFC2123 page 31)</span>
00470 <span class="comment">                         */</span>
00471                         <span class="keywordflow">if</span>((<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>!=DHCP_STATE_RENEWING)
00472                                 &amp;&amp;(<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>!=DHCP_STATE_REBINDING)){
00473                                 *buf_ptr++=DHCP_OPT_REQUESTED_IP;
00474                                 *buf_ptr++=4;
00475                                 *buf_ptr++=(UINT8)(<a class="code" href="dhcpc_8c.html#a7">dhcpc_requested_ip</a>&gt;&gt;24);
00476                                 *buf_ptr++=(UINT8)(<a class="code" href="dhcpc_8c.html#a7">dhcpc_requested_ip</a>&gt;&gt;16);
00477                                 *buf_ptr++=(UINT8)(<a class="code" href="dhcpc_8c.html#a7">dhcpc_requested_ip</a>&gt;&gt;8);
00478                                 *buf_ptr++=(UINT8)(dhcpc_requested_ip);
00479                         }       
00480                         <span class="comment">/* server identifier, only when not in INIT_REBOOT state </span>
00481 <span class="comment">                         *(RFC2131, Section 4.3.2) or RENEWING, REBINDING</span>
00482 <span class="comment">                         * state (RFC2131 page 31)</span>
00483 <span class="comment">                         */</span>
00484                         <span class="keywordflow">if</span>((<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>!=DHCP_STATE_INIT_REBOOT)
00485                                 &amp;&amp;(<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>!=DHCP_STATE_REBOOTING)   <span class="comment">/* for retransmissions */</span>                       
00486                                 &amp;&amp;(<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>!=DHCP_STATE_RENEWING)
00487                                 &amp;&amp;(<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>!=DHCP_STATE_REBINDING)){
00488                                 *buf_ptr++=DHCP_OPT_SERV_IDENT;
00489                                 *buf_ptr++=4;
00490                                 *buf_ptr++=(UINT8)(<a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>&gt;&gt;24);
00491                                 *buf_ptr++=(UINT8)(<a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>&gt;&gt;16);
00492                                 *buf_ptr++=(UINT8)(<a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>&gt;&gt;8);
00493                                 *buf_ptr++=(UINT8)(dhcpc_server_identifier);
00494                         }       
00495                         <span class="comment">/* go through to request parameters we're interested in, but</span>
00496 <span class="comment">                         * only if we're not sending DECLINE message (parameter list</span>
00497 <span class="comment">                         * MUST NOT be sent in such a message)</span>
00498 <span class="comment">                         */</span>
00499                          <span class="keywordflow">if</span>(msg_type==DHCP_DECLINE)
00500                                 <span class="keywordflow">break</span>;
00501                         
00502                 <span class="keywordflow">case</span> DHCP_DISCOVER:             
00503                         <span class="comment">/* parameter request list. These also MUST be transmitted</span>
00504 <span class="comment">                         * with DHCP REQUEST message */</span>
00505                         *buf_ptr++=DHCP_OPT_PARAM_REQUEST;
00506                         *buf_ptr++=7;   <span class="comment">/* number of parameters we're requesting */</span>
00507                         *buf_ptr++=DHCP_OPT_SUBNET_MASK;
00508                         *buf_ptr++=DHCP_OPT_ROUTER;
00509                         *buf_ptr++=DHCP_OPT_DNS_SERVER;
00510                         *buf_ptr++=DHCP_OPT_HOST_NAME;
00511                         *buf_ptr++=DHCP_OPT_LEASE_TIME;
00512                         *buf_ptr++=DHCP_OPT_T1_VALUE;
00513                         *buf_ptr++=DHCP_OPT_T2_VALUE;
00514                         <span class="keywordflow">break</span>;                  
00515 
00516                 <span class="keywordflow">default</span>:
00517                         <span class="keywordflow">break</span>;
00518         }
00519         
00520         <span class="comment">/* end option */</span>
00521         *buf_ptr++=DHCP_OPT_END;
00522         <span class="keywordflow">while</span>(buf_ptr&lt;(net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>+300))
00523                 *buf_ptr++=0x00;
00524                 
00525         <span class="comment">/* send message. Send unicast when server's IP is available (only</span>
00526 <span class="comment">         * in selected states, check RFC) and allowed (also check RFCs).</span>
00527 <span class="comment">         * Check RFCs in any case :-)</span>
00528 <span class="comment">         */</span>
00529         <span class="keywordflow">if</span>((<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>==DHCP_STATE_BOUND)
00530                 ||(<a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>==DHCP_STATE_RENEWING))
00531                 <span class="keywordflow">return</span> <a class="code" href="udp_8c.html#a7">udp_send</a>(<a class="code" href="dhcpc_8c.html#a2">dhcpc_soc_handle</a>,<a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>,DHCP_SERVER_PORT,net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>,<a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a>-<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>,buf_ptr-(net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>));
00532         <span class="keywordflow">else</span>
00533                 <span class="keywordflow">return</span> <a class="code" href="udp_8c.html#a7">udp_send</a>(<a class="code" href="dhcpc_8c.html#a2">dhcpc_soc_handle</a>,IP_BROADCAST_ADDRESS,DHCP_SERVER_PORT,net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>,<a class="code" href="group__opentcp__config.html#a4">NETWORK_TX_BUFFER_SIZE</a>-<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>,buf_ptr-(net_buf+<a class="code" href="tcp__ip_8h.html#a62">UDP_APP_OFFSET</a>));
00534 
00535 }
00536 
<a name="l00549"></a><a class="code" href="dhcpc_8c.html#a12">00549</a> UINT32 <a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(UINT8 n){
00550         UINT32 ret_value=0;
00551         <span class="comment">/* read n bytes and return value of last of them (max 4, can be less)*/</span>
00552         <span class="keywordflow">while</span>(n--){
00553                 ret_value=(ret_value&lt;&lt;8)|<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00554         }
00555         <span class="keywordflow">return</span> ret_value;
00556 }
00557 
<a name="l00568"></a><a class="code" href="dhcpc_8c.html#a8">00568</a> INT32 <a class="code" href="dhcpc_8c.html#a8">dhcpc_eventlistener</a>(INT8 cbhandle, UINT8 event, UINT32 ipaddr, UINT16 port, UINT16 buffindex, UINT16 datalen)
00569 {
00570         UINT32 temp;
00571         UINT32 yiaddr;  <span class="comment">/* assigned IP */</span>
00572         UINT8 i;
00573         UINT8 msg_type=0;
00574         
00575         <span class="keywordflow">if</span>(cbhandle!=<a class="code" href="dhcpc_8c.html#a2">dhcpc_soc_handle</a>){
00576                 DEBUGOUT(<span class="stringliteral">"DHCP Client: Not my handle!!!!\r\n"</span>);
00577                 <span class="keywordflow">return</span> (-1);
00578         }
00579         
00580         <span class="keywordflow">switch</span>(event){
00581                 <span class="keywordflow">case</span> <a class="code" href="tcp__ip_8h.html#a31">UDP_EVENT_DATA</a>:
00582                         DEBUGOUT(<span class="stringliteral">"DHCP Client: Received data...."</span>);
00583                         <span class="comment">/* initial correctness checking */</span>
00584                         <span class="keywordflow">if</span>(datalen&lt;236){
00585                                 DEBUGOUT(<span class="stringliteral">"length not OK, dumping packet\r\n"</span>);
00586                                 <span class="keywordflow">return</span> (-1);
00587                                 }
00588                         
00589                         <span class="comment">/* op */</span>
00590                         <span class="keywordflow">if</span>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()!=BOOT_REPLY){
00591                                 DEBUGOUT(<span class="stringliteral">"op not BOOT_REPLY, dumping packet\r\n"</span>);
00592                                 <span class="keywordflow">return</span> (-1);
00593                                 }
00594                                 
00595                         <span class="comment">/* skip htype, hlen, hops */</span>
00596                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00597                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00598                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00599                         
00600                         <span class="comment">/* check xid */</span>
00601                         temp=0;
00602                         temp|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;24;
00603                         temp|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;16;
00604                         temp|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8;
00605                         temp|=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00606                         <span class="keywordflow">if</span>(temp!=0xAABBCCDD){
00607                                 DEBUGOUT(<span class="stringliteral">"xid not OK, dumping packet\r\n"</span>);
00608                                 <span class="keywordflow">return</span> (-1);
00609                                 }
00610                                 
00611                         <span class="comment">/* skip secs, flags, ciaddr and find yiaddr*/</span>
00612                         <span class="keywordflow">for</span>(i=0;i&lt;12;i++)
00613                                 yiaddr=(yiaddr&lt;&lt;8)|<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00614                          
00615                          <span class="comment">/* skip siaddr, giaddr, chaddr, sname, file. </span>
00616 <span class="comment">                          * We get all the info we need from options.</span>
00617 <span class="comment">                          */</span>
00618                         <span class="keywordflow">for</span>(i=0;i&lt;216;i++)
00619                                 <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00620                         
00621                         <span class="comment">/* check magic cookie */</span>
00622                         temp=0;
00623                         temp|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;24;
00624                         temp|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;16;
00625                         temp|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8;
00626                         temp|=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00627                         <span class="keywordflow">if</span>(temp!=0x63825363){
00628                                 DEBUGOUT(<span class="stringliteral">"magic cookie not OK, dumping packet\r\n"</span>);
00629                                 <span class="keywordflow">return</span> (-1);
00630                                 }
00631                         DEBUGOUT(<span class="stringliteral">"initial check OK, proceeding...\r\n"</span>);
00632                         <span class="comment">/* process further received message, depends on state we're in */</span>
00633                         <span class="keywordflow">switch</span>(dhcpc_state){
00634                                 <span class="keywordflow">case</span> DHCP_STATE_SELECTING:
00635                                         <span class="comment">/* select first DHCPOFFER */</span>
00636                                         <a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>=0;
00637                                         DEBUGOUT(<span class="stringliteral">"DHCP Client state=SELECTING; "</span>);
00638                                         <span class="comment">/* iterate through parameters and try to find if </span>
00639 <span class="comment">                                         * this really is DHCPOFFER. Besides that, we're</span>
00640 <span class="comment">                                         * only interested in SERVERIDENTIFIER option (which</span>
00641 <span class="comment">                                         * is actually server's IP address)</span>
00642 <span class="comment">                                         */</span>
00643                                         <span class="keywordflow">while</span>((i=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())!=DHCP_OPT_END){
00644                                                 <span class="comment">/* there are still options to process*/</span>
00645                                                 <span class="keywordflow">switch</span>(i){
00646                                                         <span class="keywordflow">case</span> DHCP_OPT_MSG_TYPE:
00647                                                                 <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00648                                                                 msg_type=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();   
00649                                                                 <span class="keywordflow">break</span>;
00650                                                         <span class="keywordflow">case</span> DHCP_OPT_SERV_IDENT:
00651                                                                 <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00652                                                                 <span class="comment">/* Read SERVER IDENTIFIER */</span>
00653                                                                 <a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;24;
00654                                                                 <a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;16;
00655                                                                 <a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>|=((UINT32)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())&lt;&lt;8;
00656                                                                 <a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>|=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00657                                                                 <span class="keywordflow">break</span>;
00658                                                         <span class="keywordflow">case</span> DHCP_OPT_OVERLOAD:
00659                                                                 <span class="comment">/* we can't process overloaded messages */</span>
00660                                                                 DEBUGOUT(<span class="stringliteral">"Overloaded DHCP message, can't process...\r\n"</span>);
00661                                                                 <span class="keywordflow">return</span> (-1);
00662                                                                 <span class="keywordflow">break</span>;
00663                                                         <span class="keywordflow">default</span>:
00664                                                                 <span class="comment">/* not interesting parameter for now */</span>
00665                                                                 <span class="keywordflow">if</span>(i==DHCP_OPT_PAD)
00666                                                                         <span class="keywordflow">break</span>;
00667                                                                 i=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();  <span class="comment">/* parameter length */</span>
00668                                                                 <span class="keywordflow">while</span>(i--){
00669                                                                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00670                                                                 }
00671                                                                 <span class="keywordflow">break</span>;
00672                                                 }
00673                                         }
00674                                         <span class="comment">/* ok, processed all, got what we were looking for ? */</span>
00675                                         <span class="keywordflow">if</span>((!<a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>)||(msg_type!=DHCP_OFFER)){
00676                                                 DEBUGOUT(<span class="stringliteral">" Not a DHCP offer or no server identifier; Aborting...\r\n"</span>);
00677                                                 <span class="keywordflow">return</span>(-1);
00678                                         }
00679                                         
00680                                         DEBUGOUT(<span class="stringliteral">" DHCP offer valid, sending DHCP REQUEST; State SELECTING--&gt;REQUESTING\r\n"</span>);
00681                                         <span class="comment">/* we have the offer, contact the server! */</span>
00682                                         <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_REQUESTING;
00683                                         <a class="code" href="dhcpc_8c.html#a7">dhcpc_requested_ip</a>=yiaddr;      <span class="comment">/* offered IP ! */</span>
00684                                         
00685                                         <a class="code" href="dhcpc_8c.html#a9">dhcpc_send_message</a>(DHCP_REQUEST);
00686                                         
00687                                         <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=4;     <span class="comment">/* 4 secs for first retransmission */</span>
00688                                         <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>=8;     <span class="comment">/* next one after 8 secs */</span>
00689                                         <span class="keywordflow">break</span>;
00690 
00691                                 <span class="keywordflow">case</span> DHCP_STATE_REQUESTING:
00692                                         <span class="comment">/* wait for DHCPACK */</span>
00693                                         
00694                                         DEBUGOUT(<span class="stringliteral">"DHCP Client state=REQUESTING; "</span>);
00695 
00696                                         <span class="comment">/* is message from the same server who sent the offer </span>
00697 <span class="comment">                                         * and assigned IP == offered IP? This will also reject</span>
00698 <span class="comment">                                         * subsequent DHCPOFFERs from slow DHCP servers.</span>
00699 <span class="comment">                                         */</span>
00700                                         <span class="keywordflow">if</span>((<a class="code" href="dhcpc_8c.html#a6">dhcpc_server_identifier</a>!=ipaddr)||(yiaddr!=<a class="code" href="dhcpc_8c.html#a7">dhcpc_requested_ip</a>)){
00701                                                 DEBUGOUT(<span class="stringliteral">"Server or requested IP not the same, dumping..\r\n"</span>);
00702                                                 <span class="keywordflow">return</span> (-1);
00703                                         }
00704                                         
00705                                         <span class="comment">/* ok, go through param list and process them. We expect to get</span>
00706 <span class="comment">                                         * all the params here and that this is DHCPACK message</span>
00707 <span class="comment">                                         */</span>
00708                                         DEBUGOUT(<span class="stringliteral">"Received params: "</span>);
00709                                         <span class="keywordflow">while</span>((i=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())!=DHCP_OPT_END){
00710                                                 
00711                                                 <span class="keywordflow">switch</span>(i){
00712                                                         <span class="keywordflow">case</span> DHCP_OPT_PAD:
00713                                                                 <span class="keywordflow">break</span>;
00714                                                         <span class="keywordflow">case</span> DHCP_OPT_SUBNET_MASK:
00715                                                                 temp=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00716                                                                 <span class="comment">/* temp holds subnet mask, for now just show it and set params*/</span>
00717                                                                 localmachine.netmask=temp;
00718                                                                 DEBUGOUT(<span class="stringliteral">"Subnet mask;"</span>);
00719                                                                 <span class="keywordflow">break</span>;
00720                                                         <span class="keywordflow">case</span> DHCP_OPT_ROUTER:
00721                                                                 temp=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00722                                                                 <span class="comment">/* temp holds gateway IP */</span>
00723                                                                 localmachine.defgw=temp;
00724                                                                 DEBUGOUT(<span class="stringliteral">"Gateway IP; "</span>);
00725                                                                 <span class="keywordflow">break</span>;
00726                                                         <span class="keywordflow">case</span> DHCP_OPT_DNS_SERVER:
00727                                                                 temp=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00728                                                                 DEBUGOUT(<span class="stringliteral">"DNS IP;"</span>);
00729                                                                 <span class="keywordflow">break</span>;
00730                                                         <span class="keywordflow">case</span> DHCP_OPT_HOST_NAME:
00731                                                                 <span class="comment">/* Read host name here and store it */</span>
00732                                                                 i=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();  <span class="comment">/* length of host name */</span>
00733                                                                 <span class="keywordflow">while</span>(i--){
00734                                                                         <span class="comment">/* read host name. Store this if necessary */</span>
00735                                                                         <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00736                                                                 }
00737                                                                 DEBUGOUT(<span class="stringliteral">"Host name; "</span>);
00738                                                                 <span class="keywordflow">break</span>;
00739                                                         <span class="keywordflow">case</span> DHCP_OPT_LEASE_TIME:
00740                                                                 temp=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00741                                                                 <span class="comment">/* time calculation from RFC! These values can also</span>
00742 <span class="comment">                                                                 * be received directly in options</span>
00743 <span class="comment">                                                                 */</span>
00744                                                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=0.5*temp;
00745                                                                 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>=0.875*temp;
00746                                                                 DEBUGOUT(<span class="stringliteral">"Lease time;"</span>); 
00747                                                                 <span class="keywordflow">break</span>;
00748                                                         <span class="keywordflow">case</span> DHCP_OPT_OVERLOAD:
00749                                                                 DEBUGOUT(<span class="stringliteral">"Overloaded DHCP message, can't process...\r\n"</span>);
00750                                                                 <span class="keywordflow">return</span> (-1);
00751                                                                 <span class="keywordflow">break</span>;
00752                                                         <span class="keywordflow">case</span> DHCP_OPT_MSG_TYPE:
00753                                                                 <span class="comment">/* if this is DHCPACK we can switch state and assume</span>
00754 <span class="comment">                                                                 * that the parameters are OK</span>
00755 <span class="comment">                                                                 */</span>
00756                                                                 <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00757                                                                 <span class="keywordflow">if</span>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()==DHCP_ACK){
00758                                                                         DEBUGOUT(<span class="stringliteral">"DHCP_ACK Message!; State REQUESTING--&gt;BOUND; "</span>);
00759                                                                         <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_BOUND;
00760                                                                         
00761                                                                         <span class="comment">/* we should actually probe the received IP with</span>
00762 <span class="comment">                                                                         * ARP first, but let's wait with that for </span>
00763 <span class="comment">                                                                         * now.....</span>
00764 <span class="comment">                                                                         */</span>
00765                                                                         localmachine.localip=<a class="code" href="dhcpc_8c.html#a7">dhcpc_requested_ip</a>;
00766                                                                         <span class="comment">/* dhcpc_requested_ip holds the assigned IP</span>
00767 <span class="comment">                                                                         * address. USE IT OR LOOSE IT!</span>
00768 <span class="comment">                                                                         */</span>
00769                                                                         DEBUGOUT(<span class="stringliteral">"IP address;"</span>);
00770                                                                 }<span class="keywordflow">else</span>{
00771                                                                         DEBUGOUT(<span class="stringliteral">"NOT DHCPACK message; dumping...\r\n"</span>);
00772                                                                         <span class="keywordflow">return</span>(-1);
00773                                                                 }       
00774                                                                 <span class="keywordflow">break</span>;
00775                                                         <span class="keywordflow">case</span> DHCP_OPT_T1_VALUE:
00776                                                                 DEBUGOUT(<span class="stringliteral">"T1;"</span>);
00777                                                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00778                                                                 <span class="keywordflow">break</span>;
00779                                                         <span class="keywordflow">case</span> DHCP_OPT_T2_VALUE:
00780                                                                 DEBUGOUT(<span class="stringliteral">"T2; "</span>);
00781                                                                 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00782                                                                 <span class="keywordflow">break</span>;
00783                                                         <span class="keywordflow">default</span>:
00784                                                                 <a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00785                                                                 <span class="keywordflow">break</span>;
00786                                                 }
00787                                         }
00788                                         DEBUGOUT(<span class="stringliteral">"\r\n"</span>);
00789                                         <span class="keywordflow">break</span>;
00790                                 <span class="keywordflow">case</span> DHCP_STATE_RENEWING:
00791                                 <span class="keywordflow">case</span> DHCP_STATE_REBINDING:
00792                                 <span class="keywordflow">case</span> DHCP_STATE_REBOOTING:
00793                                         <span class="comment">/* wait for DHCPACK. If we get DHCPNAK restart. Here</span>
00794 <span class="comment">                                         * we're only interested in ACK and T1 and T2 parameters.</span>
00795 <span class="comment">                                         * NOTE: other parameters can change as well during time(</span>
00796 <span class="comment">                                         * DNS, gateway etc. Add cases similar to those in</span>
00797 <span class="comment">                                         * REQUESTING state here as well if you want those.</span>
00798 <span class="comment">                                         */</span>
00799                                         DEBUGOUT(<span class="stringliteral">"DHCP Client state=REQUESTING or REBINDING; "</span>);
00800                                         <span class="keywordflow">while</span>((i=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>())!=DHCP_OPT_END){
00801                                                 <span class="keywordflow">switch</span>(i){
00802                                                         <span class="keywordflow">case</span> DHCP_OPT_PAD:
00803                                                                 <span class="keywordflow">break</span>;
00804                                                         <span class="keywordflow">case</span> DHCP_OPT_LEASE_TIME:
00805                                                                 DEBUGOUT(<span class="stringliteral">"Lease time; "</span>);
00806                                                                 temp=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00807                                                                 <span class="comment">/* time calculation from RFC! These values can also</span>
00808 <span class="comment">                                                                 * be received directly in options</span>
00809 <span class="comment">                                                                 */</span>
00810                                                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=0.5*temp;
00811                                                                 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>=0.875*temp; 
00812                                                                 <span class="keywordflow">break</span>;                                                          
00813                                                         <span class="keywordflow">case</span> DHCP_OPT_MSG_TYPE:
00814                                                                 <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00815                                                                 i=<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00816                                                                 <span class="keywordflow">if</span>(i==DHCP_NAK){
00817                                                                         DEBUGOUT(<span class="stringliteral">"DHCP_NAK received; State --&gt; INIT\r\n"</span>);
00818                                                                         <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_INIT;
00819                                                                         localmachine.localip=0;
00820                                                                         <span class="keywordflow">return</span>(-1);
00821                                                                 }
00822                                                                 <span class="keywordflow">if</span>(i==DHCP_ACK){
00823                                                                         DEBUGOUT(<span class="stringliteral">"DHCP_ACK received; State --&gt; BOUND\r\n"</span>);
00824                                                                         <a class="code" href="dhcpc_8c.html#a0">dhcpc_state</a>=DHCP_STATE_BOUND;
00825                                                                 }
00826                                                                 <span class="keywordflow">break</span>;
00827                                                         <span class="keywordflow">case</span> DHCP_OPT_T1_VALUE:
00828                                                                 DEBUGOUT(<span class="stringliteral">"T1; "</span>);
00829                                                                 <a class="code" href="dhcpc_8c.html#a4">dhcpc_t1</a>=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00830                                                                 <span class="keywordflow">break</span>;
00831                                                         <span class="keywordflow">case</span> DHCP_OPT_T2_VALUE:
00832                                                                 DEBUGOUT(<span class="stringliteral">"T2; "</span>);
00833                                                                 <a class="code" href="dhcpc_8c.html#a5">dhcpc_t2</a>=<a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00834                                                                 <span class="keywordflow">break</span>;
00835                                                         <span class="keywordflow">default</span>:
00836                                                                 <a class="code" href="dhcpc_8c.html#a12">dhcpc_read_n_bytes</a>(<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>());
00837                                                                 <span class="keywordflow">break</span>;
00838                                                 }
00839                                         }
00840                                         <span class="keywordflow">break</span>;
00841                                 <span class="keywordflow">default</span>:
00842                                         <span class="comment">/* dump frames when in all other states */</span>
00843                                         <span class="keywordflow">break</span>;                          
00844                         }
00845                         <span class="keywordflow">break</span>;
00846                 <span class="keywordflow">default</span>:
00847                         <span class="comment">/* should never get here */</span>
00848                         DEBUGOUT(<span class="stringliteral">"DHCP Client: Unknown UDP event :-( \r\n"</span>);
00849                         <span class="keywordflow">break</span>;
00850         }
00851         <span class="keywordflow">return</span> 1;
00852 
00853 }
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:32:59 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
