<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/opentcp/udp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>/opentcp/udp.c</h1><a href="udp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> *Copyright (c) 2000-2002 Viola Systems Ltd.</span>
00003 <span class="comment"> *All rights reserved.</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *Redistribution and use in source and binary forms, with or without </span>
00006 <span class="comment"> *modification, are permitted provided that the following conditions </span>
00007 <span class="comment"> *are met:</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *1. Redistributions of source code must retain the above copyright </span>
00010 <span class="comment"> *notice, this list of conditions and the following disclaimer.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *2. Redistributions in binary form must reproduce the above copyright </span>
00013 <span class="comment"> *notice, this list of conditions and the following disclaimer in the </span>
00014 <span class="comment"> *documentation and/or other materials provided with the distribution.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *3. The end-user documentation included with the redistribution, if </span>
00017 <span class="comment"> *any, must include the following acknowledgment:</span>
00018 <span class="comment"> *      "This product includes software developed by Viola </span>
00019 <span class="comment"> *      Systems (http://www.violasystems.com/)."</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *Alternately, this acknowledgment may appear in the software itself, </span>
00022 <span class="comment"> *if and wherever such third-party acknowledgments normally appear.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> *4. The names "OpenTCP" and "Viola Systems" must not be used to </span>
00025 <span class="comment"> *endorse or promote products derived from this software without prior </span>
00026 <span class="comment"> *written permission. For written permission, please contact </span>
00027 <span class="comment"> *opentcp@opentcp.org.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> *5. Products derived from this software may not be called "OpenTCP", </span>
00030 <span class="comment"> *nor may "OpenTCP" appear in their name, without prior written </span>
00031 <span class="comment"> *permission of the Viola Systems Ltd.</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED </span>
00034 <span class="comment"> *WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span>
00035 <span class="comment"> *MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. </span>
00036 <span class="comment"> *IN NO EVENT SHALL VIOLA SYSTEMS LTD. OR ITS CONTRIBUTORS BE LIABLE </span>
00037 <span class="comment"> *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR </span>
00038 <span class="comment"> *CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </span>
00039 <span class="comment"> *SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR </span>
00040 <span class="comment"> *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span>
00041 <span class="comment"> *WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE </span>
00042 <span class="comment"> *OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, </span>
00043 <span class="comment"> *EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00044 <span class="comment"> *====================================================================</span>
00045 <span class="comment"> *</span>
00046 <span class="comment"> *OpenTCP is the unified open source TCP/IP stack available on a series </span>
00047 <span class="comment"> *of 8/16-bit microcontrollers, please see &lt;http://www.opentcp.org&gt;.</span>
00048 <span class="comment"> *</span>
00049 <span class="comment"> *For more information on how to network-enable your devices, or how to </span>
00050 <span class="comment"> *obtain commercial technical support for OpenTCP, please see </span>
00051 <span class="comment"> *&lt;http://www.violasystems.com/&gt;.</span>
00052 <span class="comment"> */</span>
00053 
00077 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html">inet/debug.h</a>&gt;</span>
00078 <span class="preprocessor">#include &lt;<a class="code" href="datatypes_8h.html">inet/datatypes.h</a>&gt;</span>
00079 <span class="preprocessor">#include &lt;<a class="code" href="ethernet_8h.html">inet/ethernet.h</a>&gt;</span>
00080 <span class="preprocessor">#include &lt;<a class="code" href="ip_8h.html">inet/ip.h</a>&gt;</span>
00081 <span class="preprocessor">#include &lt;<a class="code" href="tcp__ip_8h.html">inet/tcp_ip.h</a>&gt;</span>
00082 <span class="preprocessor">#include &lt;<a class="code" href="system_8h.html">inet/system.h</a>&gt;</span>
00083 
<a name="l00094"></a><a class="code" href="udp_8c.html#a0">00094</a> <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a> udp_socket[NO_OF_UDPSOCKETS];
00095 
<a name="l00101"></a><a class="code" href="udp_8c.html#a1">00101</a> <span class="keyword">struct </span><a class="code" href="structudp__frame.html">udp_frame</a> received_udp_packet;
00102 
<a name="l00118"></a><a class="code" href="udp_8c.html#a2">00118</a> INT8 <a class="code" href="group__core__initializer.html#a4">udp_init</a> (<span class="keywordtype">void</span>)
00119 {
00120         UINT8 i;
00121         <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a>* soc;
00122         
00123         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS &lt; 0 )
00124                 <span class="keywordflow">return</span>(-1);
00125         
00126         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS == 0 )
00127                 <span class="keywordflow">return</span>(0);
00128         
00129         UDP_DEBUGOUT(<span class="stringliteral">"Initializing UDP"</span>);
00130         
00131         <span class="keywordflow">for</span>(i=0; i &lt; NO_OF_UDPSOCKETS; i++) {
00132                 soc = &amp;udp_socket[i];                   <span class="comment">/* Get Socket   */</span>
00133                 
00134                 soc-&gt;<a class="code" href="structucb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a28">UDP_STATE_FREE</a>;
00135                 soc-&gt;<a class="code" href="structucb.html#m1">tos</a> = 0;
00136                 soc-&gt;<a class="code" href="structucb.html#m2">locport</a> = 0;
00137                 soc-&gt;<a class="code" href="structucb.html#m3">opts</a> = <a class="code" href="tcp__ip_8h.html#a5">UDP_OPT_SEND_CS</a> | <a class="code" href="tcp__ip_8h.html#a6">UDP_OPT_CHECK_CS</a>;  
00138                 soc-&gt;event_listener = 0;
00139                 
00140                 UDP_DEBUGOUT(<span class="stringliteral">"."</span>);
00141                 
00142         }
00143         
00144         UDP_DEBUGOUT(<span class="stringliteral">"\n\rUDP Initialized\n\r"</span>);
00145         
00146         <span class="comment">/* Return number of sockets initialized */</span>
00147         
00148         <span class="keywordflow">return</span>(i+1);
00149 
00150 }
00151 
<a name="l00175"></a><a class="code" href="udp_8c.html#a3">00175</a> INT8 <a class="code" href="udp_8c.html#a3">udp_getsocket</a> (UINT8 tos, INT32 (*listener)(INT8, UINT8, UINT32, UINT16, UINT16, UINT16), UINT8 opts )
00176 {
00177         INT8 i;
00178         <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a>* soc;
00179         
00180         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS &lt; 0 )
00181                 <span class="keywordflow">return</span>(-1);
00182         
00183         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS == 0 )
00184                 <span class="keywordflow">return</span>(-1);
00185         
00186         
00187         <span class="keywordflow">if</span>(listener == 0) {
00188                 UDP_DEBUGOUT(<span class="stringliteral">"ERROR:Event listener function for UDP not specified\r\n"</span>);
00189                 <span class="keywordflow">return</span>(-1);
00190         }
00191         
00192         UDP_DEBUGOUT(<span class="stringliteral">"Searching for free UDP socket...\r\n"</span>);
00193         
00194         <span class="keywordflow">for</span>(i=0; i &lt; NO_OF_UDPSOCKETS; i++) {
00195                 soc = &amp;udp_socket[i];                   <span class="comment">/* Get Socket   */</span>
00196         
00197                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structucb.html#m0">state</a> == <a class="code" href="tcp__ip_8h.html#a28">UDP_STATE_FREE</a>) {
00198                         <span class="comment">/* We found it  */</span>
00199                         
00200                         UDP_DEBUGOUT(<span class="stringliteral">"Free socket found\r\n"</span>);
00201                         
00202                         soc-&gt;<a class="code" href="structucb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a29">UDP_STATE_CLOSED</a>;
00203                         soc-&gt;<a class="code" href="structucb.html#m1">tos</a> = tos;
00204                         soc-&gt;<a class="code" href="structucb.html#m2">locport</a> = 0;
00205                         
00206                         soc-&gt;<a class="code" href="structucb.html#m3">opts</a> = 0;
00207                         
00208                         <span class="keywordflow">if</span>(opts &amp; <a class="code" href="tcp__ip_8h.html#a5">UDP_OPT_SEND_CS</a>)
00209                                 soc-&gt;<a class="code" href="structucb.html#m3">opts</a> |= <a class="code" href="tcp__ip_8h.html#a5">UDP_OPT_SEND_CS</a>;
00210                         <span class="keywordflow">if</span>(opts &amp; <a class="code" href="tcp__ip_8h.html#a6">UDP_OPT_CHECK_CS</a>)
00211                                 soc-&gt;<a class="code" href="structucb.html#m3">opts</a> |= <a class="code" href="tcp__ip_8h.html#a6">UDP_OPT_CHECK_CS</a>;
00212                         
00213                         soc-&gt;event_listener = listener;
00214 
00215                         <span class="comment">/* Return handle        */</span>
00216                         
00217                         <span class="keywordflow">return</span>(i);
00218                 }
00219         
00220         }
00221         
00222         <span class="comment">/* We are there so no socket found      */</span>
00223         
00224         UDP_DEBUGOUT(<span class="stringliteral">"No UDP socket found\r\n"</span>);
00225         <span class="keywordflow">return</span>(-1);
00226 
00227 }
00228 
00229 
<a name="l00244"></a><a class="code" href="udp_8c.html#a4">00244</a> INT8 <a class="code" href="udp_8c.html#a4">udp_releasesocket</a> (INT8 sochandle)
00245 {
00246         <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a>* soc;
00247         
00248         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS &lt; 0 )
00249                 <span class="keywordflow">return</span>(-1);
00250         
00251         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS == 0 )
00252                 <span class="keywordflow">return</span>(-1);
00253         
00254         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_UDPSOCKETS ) {
00255                 UDP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00256                 <span class="keywordflow">return</span>(-1);
00257         }
00258         
00259         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00260                 UDP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00261                 <span class="keywordflow">return</span>(-1);
00262         }
00263         
00264         soc = &amp;udp_socket[sochandle];           <span class="comment">/* Get referense        */</span>
00265         
00266         soc-&gt;<a class="code" href="structucb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a28">UDP_STATE_FREE</a>;
00267         soc-&gt;<a class="code" href="structucb.html#m1">tos</a> = 0;
00268         soc-&gt;<a class="code" href="structucb.html#m2">locport</a> = 0;
00269         soc-&gt;<a class="code" href="structucb.html#m3">opts</a> = <a class="code" href="tcp__ip_8h.html#a5">UDP_OPT_SEND_CS</a> | <a class="code" href="tcp__ip_8h.html#a6">UDP_OPT_CHECK_CS</a>; 
00270         soc-&gt;event_listener = 0;
00271 
00272         <span class="keywordflow">return</span>(sochandle);
00273 
00274 }
00275 
00276 
<a name="l00291"></a><a class="code" href="udp_8c.html#a5">00291</a> INT8 <a class="code" href="udp_8c.html#a5">udp_open</a> (INT8 sochandle, UINT16 locport)
00292 {
00293         <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a>* soc;
00294         
00295         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS &lt; 0 )
00296                 <span class="keywordflow">return</span>(-1);
00297         
00298         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS == 0 )
00299                 <span class="keywordflow">return</span>(-1);
00300         
00301         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_UDPSOCKETS ) {
00302                 UDP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00303                 <span class="keywordflow">return</span>(-1);
00304         }
00305         
00306         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00307                 UDP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00308                 <span class="keywordflow">return</span>(-1);
00309         }
00310         
00311         <span class="keywordflow">if</span>(locport == 0) {
00312                 locport=<a class="code" href="udp_8c.html#a71">udp_getfreeport</a>();
00313                 <span class="keywordflow">return</span>(-1);
00314         }
00315         
00316         soc = &amp;udp_socket[sochandle];           <span class="comment">/* Get referense        */</span>
00317 
00318         soc-&gt;<a class="code" href="structucb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a30">UDP_STATE_OPENED</a>;
00319         soc-&gt;<a class="code" href="structucb.html#m2">locport</a> = locport;
00320         
00321         <span class="keywordflow">return</span>(sochandle);
00322 
00323 }
00324 
00325 
00326 
<a name="l00340"></a><a class="code" href="udp_8c.html#a6">00340</a> INT8 <a class="code" href="udp_8c.html#a6">udp_close</a> (INT8 sochandle)
00341 {
00342         <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a>* soc;
00343         
00344         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS &lt; 0 )
00345                 <span class="keywordflow">return</span>(-1);
00346         
00347         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS == 0 )
00348                 <span class="keywordflow">return</span>(-1);
00349         
00350         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_UDPSOCKETS ) {
00351                 UDP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00352                 <span class="keywordflow">return</span>(-1);
00353         }
00354         
00355         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00356                 UDP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00357                 <span class="keywordflow">return</span>(-1);
00358         }
00359         
00360         soc = &amp;udp_socket[sochandle];           <span class="comment">/* Get referense        */</span>
00361 
00362         soc-&gt;<a class="code" href="structucb.html#m0">state</a> = <a class="code" href="tcp__ip_8h.html#a29">UDP_STATE_CLOSED</a>;
00363         
00364         <span class="keywordflow">return</span>(sochandle);
00365 
00366 }
00367 
00368 
<a name="l00395"></a><a class="code" href="udp_8c.html#a7">00395</a> INT16 <a class="code" href="udp_8c.html#a7">udp_send</a> (INT8 sochandle, UINT32 remip, UINT16 remport, UINT8* buf, UINT16 blen, UINT16 dlen)
00396 {
00397         <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a>* soc;
00398         UINT8* user_buf_start;
00399         UINT16 cs;
00400         UINT8 cs_cnt;
00401         INT16 i;
00402         
00403         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS &lt; 0 )
00404                 <span class="keywordflow">return</span>(-1);
00405         
00406         <span class="keywordflow">if</span>( NO_OF_UDPSOCKETS == 0 )
00407                 <span class="keywordflow">return</span>(-1);
00408         
00409         <span class="keywordflow">if</span>( sochandle &gt; NO_OF_UDPSOCKETS ) {
00410                 UDP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00411                 <span class="keywordflow">return</span>(-1);
00412         }
00413         
00414         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00415                 UDP_DEBUGOUT(<span class="stringliteral">"Socket handle non-valid\r\n"</span>);
00416                 <span class="keywordflow">return</span>(-1);
00417         }
00418         
00419         <span class="keywordflow">if</span>(remip == 0) {
00420                 UDP_DEBUGOUT(<span class="stringliteral">"Remote IP 0 not allowed\r\n"</span>);
00421                 <span class="keywordflow">return</span>(-1);
00422         }
00423         
00424         <span class="keywordflow">if</span>(remport == 0) {
00425                 UDP_DEBUGOUT(<span class="stringliteral">"Remote port 0 not allowed\r\n"</span>);
00426                 <span class="keywordflow">return</span>(-1);
00427         }
00428         
00429         <span class="keywordflow">if</span>( dlen &gt; blen )
00430                 dlen = blen;
00431         
00432         <span class="keywordflow">if</span>( (dlen + <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>) &gt; UDP_SEND_MTU)
00433                 dlen = UDP_SEND_MTU - <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>;
00434         
00435         soc = &amp;udp_socket[sochandle];           <span class="comment">/* Get referense        */</span>
00436 
00437         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structucb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a30">UDP_STATE_OPENED</a> ) {
00438                 UDP_DEBUGOUT(<span class="stringliteral">"UDP Socket Closed\r\n"</span>);
00439                 <span class="keywordflow">return</span>(-3);
00440         }
00441         
00442         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structucb.html#m2">locport</a> == 0) {
00443                 UDP_DEBUGOUT(<span class="stringliteral">"ERROR:Socket local port is zero\r\n"</span>);
00444                 <span class="keywordflow">return</span>(-1);
00445         }
00446 
00447         user_buf_start = buf;
00448         
00449         buf -= <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>;
00450         
00451         <span class="comment">/* Put header   */</span>
00452         
00453         *buf++ = (UINT8)(soc-&gt;<a class="code" href="structucb.html#m2">locport</a> &gt;&gt; 8);
00454         *buf++ = (UINT8)soc-&gt;<a class="code" href="structucb.html#m2">locport</a>;
00455         *buf++ = (UINT8)(remport &gt;&gt; 8);
00456         *buf++ = (UINT8)remport;
00457         *buf++ = (UINT8)((dlen + <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>) &gt;&gt; 8);
00458         *buf++ = (UINT8)(dlen + <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>);
00459         *buf++ = 0;
00460         *buf = 0;
00461         
00462         buf = user_buf_start;
00463         buf -= <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>;
00464         
00465         <span class="comment">/* Calculate checksum if needed */</span>
00466         
00467         cs = 0;
00468         
00469         <span class="keywordflow">if</span>( soc-&gt;<a class="code" href="structucb.html#m3">opts</a> &amp; <a class="code" href="tcp__ip_8h.html#a5">UDP_OPT_SEND_CS</a>) {
00470                 cs = 0;
00471                 cs_cnt = 0;
00472         
00473                 <span class="comment">/* Do it firstly to IP pseudo header    */</span>
00474         
00475                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(localmachine.localip &gt;&gt; 24), cs_cnt++);    
00476                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(localmachine.localip &gt;&gt; 16), cs_cnt++);
00477                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(localmachine.localip &gt;&gt; 8), cs_cnt++);
00478                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)localmachine.localip, cs_cnt++);
00479         
00480                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(remip &gt;&gt; 24), cs_cnt++);   
00481                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(remip &gt;&gt; 16), cs_cnt++);
00482                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(remip &gt;&gt; 8), cs_cnt++);
00483                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)remip, cs_cnt++);   
00484         
00485                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, 0, cs_cnt++);
00486         
00487                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)<a class="code" href="ip_8h.html#a2">IP_UDP</a>, cs_cnt++);
00488                 
00489                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)((dlen + <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>) &gt;&gt; 8), cs_cnt++);
00490                 cs = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(cs, (UINT8)(dlen + <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>), cs_cnt++);       
00491         
00492                 <span class="comment">/* Go to UDP header + data      */</span>
00493         
00494                 buf = user_buf_start;
00495                 buf -= <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>;
00496         
00497                 cs = <a class="code" href="ip_8c.html#a8">ip_checksum_buf</a>(cs, buf, dlen + <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>);
00498                         
00499                 cs = ~ cs;
00500         
00501                 <span class="keywordflow">if</span>(cs == 0)
00502                         cs = 0xFFFF;
00503                 
00504                 <span class="comment">/* Save checksum in correct place       */</span>
00505                 buf = user_buf_start;
00506                 buf -= <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>;
00507                 buf += 6;
00508                 *buf++ = (UINT8)(cs &gt;&gt; 8);
00509                 *buf = (UINT8)cs;       
00510                 
00511                 buf = user_buf_start;
00512                 buf -= <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>;
00513                         
00514         }
00515         
00516         <span class="comment">/* Send it to IP        */</span>
00517         
00518         UDP_DEBUGOUT(<span class="stringliteral">"Sending UDP...\r\n"</span>);
00519         
00520         i = <a class="code" href="ip_8c.html#a4">process_ip_out</a>(remip, <a class="code" href="ip_8h.html#a2">IP_UDP</a>, soc-&gt;<a class="code" href="structucb.html#m1">tos</a>, 100, buf, dlen + <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>);
00521         
00522         <span class="comment">/* Errors?      */</span>
00523         
00524         <span class="keywordflow">if</span>( i &lt; 0 )
00525                 <span class="keywordflow">return</span>(i);
00526         
00527         UDP_DEBUGOUT(<span class="stringliteral">"UDP packet sent\r\n"</span>);
00528         
00529         <span class="keywordflow">return</span>(i - <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>);
00530 
00531 
00532 }
00533 
00534 
00535 
<a name="l00550"></a><a class="code" href="udp_8c.html#a8">00550</a> INT16 <a class="code" href="udp_8c.html#a8">process_udp_in</a>(<span class="keyword">struct</span> <a class="code" href="structip__frame.html">ip_frame</a>* frame, UINT16 len)
00551 {
00552         <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a>* soc;
00553         UINT16 checksum;
00554         UINT16 i;
00555         INT8 sochandle;
00556                 
00557         <span class="comment">/* Is this UDP? */</span>
00558         
00559         UDP_DEBUGOUT(<span class="stringliteral">"Processing UDP...\n\r"</span>);
00560         
00561         <span class="keywordflow">if</span>( frame-&gt;<a class="code" href="structip__frame.html#m6">protocol</a> != <a class="code" href="ip_8h.html#a2">IP_UDP</a> ) {
00562                 UDP_DEBUGOUT(<span class="stringliteral">"ERROR: The protocol is not UDP\n\r"</span>);
00563                 <span class="keywordflow">return</span>(-1);
00564         }
00565         
00566         <span class="comment">/* Start processing the message */</span>
00567         
00568         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(frame-&gt;<a class="code" href="structip__frame.html#m11">buf_index</a>);
00569 
00570         received_udp_packet.<a class="code" href="structudp__frame.html#m0">sport</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
00571         received_udp_packet.<a class="code" href="structudp__frame.html#m0">sport</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00572         
00573         received_udp_packet.<a class="code" href="structudp__frame.html#m1">dport</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
00574         received_udp_packet.<a class="code" href="structudp__frame.html#m1">dport</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();       
00575         
00576         received_udp_packet.<a class="code" href="structudp__frame.html#m2">tlen</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
00577         received_udp_packet.<a class="code" href="structudp__frame.html#m2">tlen</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00578         
00579         received_udp_packet.<a class="code" href="structudp__frame.html#m3">checksum</a> = ((UINT16)<a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>()) &lt;&lt; 8;
00580         received_udp_packet.<a class="code" href="structudp__frame.html#m3">checksum</a> |= <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>();
00581         
00582         <span class="keywordflow">if</span>(received_udp_packet.<a class="code" href="structudp__frame.html#m2">tlen</a> &lt; <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a> ) {
00583                 UDP_DEBUGOUT(<span class="stringliteral">"UDP frame too short\n\r"</span>);
00584                 <span class="keywordflow">return</span>(-1);
00585         }
00586         
00587         
00588         <span class="comment">/* Map UDP socket       */</span>
00589         
00590         sochandle = -1;
00591         
00592         <span class="keywordflow">for</span>( i=0; i &lt; NO_OF_UDPSOCKETS; i++) {
00593                 soc = &amp;udp_socket[i];                           <span class="comment">/* Get referense        */</span>
00594 
00595                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structucb.html#m0">state</a> != <a class="code" href="tcp__ip_8h.html#a30">UDP_STATE_OPENED</a> )
00596                         <span class="keywordflow">continue</span>;
00597                 
00598                 <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structucb.html#m2">locport</a> != received_udp_packet.<a class="code" href="structudp__frame.html#m1">dport</a>)
00599                         <span class="keywordflow">continue</span>;
00600                 
00601                 <span class="comment">/* Socket found */</span>
00602                 
00603                 sochandle = i;
00604                 
00605                 <span class="keywordflow">break</span>;
00606         }
00607         
00608         <span class="keywordflow">if</span>( sochandle &lt; 0 ) {
00609                 UDP_DEBUGOUT(<span class="stringliteral">"No socket found for received UDP Packet\r\n"</span>);
00610                 
00611                 <span class="comment">/* TODO: Send ICMP      */</span>
00612                 
00613                 <span class="keywordflow">return</span>(-1);
00614         }
00615         
00616         <span class="comment">/* Calculate checksum for received packet       */</span>
00617         
00618         <span class="keywordflow">if</span>(soc-&gt;<a class="code" href="structucb.html#m3">opts</a> &amp; <a class="code" href="tcp__ip_8h.html#a6">UDP_OPT_CHECK_CS</a>) {
00619                 <span class="keywordflow">if</span>(received_udp_packet.<a class="code" href="structudp__frame.html#m3">checksum</a> != 0) {
00620                         checksum = 0;
00621                         i = 0;
00622                         
00623                         <span class="comment">/* Do it firstly to IP pseudo header    */</span>
00624         
00625                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 24), (UINT8)i++);        
00626                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 16), (UINT8)i++);
00627                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a> &gt;&gt; 8), (UINT8)i++);
00628                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m9">dip</a>, (UINT8)i++);
00629         
00630                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 24), (UINT8)i++);        
00631                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 16), (UINT8)i++);
00632                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)(frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a> &gt;&gt; 8), (UINT8)i++);
00633                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>, (UINT8)i++);        
00634         
00635                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, 0, (UINT8)i++);
00636         
00637                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)<a class="code" href="ip_8h.html#a2">IP_UDP</a>, (UINT8)i++);
00638                 
00639                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)(len &gt;&gt; 8), (UINT8)i++);
00640                         checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, (UINT8)len, (UINT8)i++);       
00641 
00642         
00643                         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(frame-&gt;<a class="code" href="structip__frame.html#m11">buf_index</a>);
00644         
00645                         <span class="keywordflow">for</span>(i=0; i &lt; len; i++)
00646                                 checksum = <a class="code" href="ip_8c.html#a7">ip_checksum</a>(checksum, <a class="code" href="system_8h.html#a9">RECEIVE_NETWORK_B</a>(), (UINT8)i);
00647         
00648                         checksum = ~ checksum;
00649         
00650                         <span class="keywordflow">if</span>(checksum != IP_GOOD_CS) {
00651                                 UDP_DEBUGOUT(<span class="stringliteral">"ERROR: UDP Checksum failed!\n\r"</span>);
00652                                 <span class="keywordflow">return</span> (-1);
00653                         }
00654                 
00655                 }
00656         
00657                 UDP_DEBUGOUT(<span class="stringliteral">"UDP Checksum OK\n\r"</span>);
00658         
00659         }
00660         
00661         
00662         received_udp_packet.<a class="code" href="structudp__frame.html#m4">buf_index</a> = frame-&gt;<a class="code" href="structip__frame.html#m11">buf_index</a> + <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>;
00663         <a class="code" href="system_8h.html#a14">NETWORK_RECEIVE_INITIALIZE</a>(received_udp_packet.<a class="code" href="structudp__frame.html#m4">buf_index</a>);
00664         
00665         <span class="comment">/* Generate data event  */</span>
00666         
00667         soc-&gt;event_listener(sochandle, <a class="code" href="tcp__ip_8h.html#a31">UDP_EVENT_DATA</a>, frame-&gt;<a class="code" href="structip__frame.html#m8">sip</a>, received_udp_packet.<a class="code" href="structudp__frame.html#m0">sport</a>, received_udp_packet.<a class="code" href="structudp__frame.html#m4">buf_index</a>, received_udp_packet.<a class="code" href="structudp__frame.html#m2">tlen</a> - <a class="code" href="tcp__ip_8h.html#a8">UDP_HLEN</a>);
00668         
00669         <span class="keywordflow">return</span>(1);
00670 
00671 }
00672 
<a name="l00684"></a><a class="code" href="udp_8c.html#a9">00684</a> UINT16 <a class="code" href="udp_8c.html#a71">udp_getfreeport</a> (<span class="keywordtype">void</span>){
00685         <span class="keyword">struct </span><a class="code" href="structucb.html">ucb</a>* soc;
00686         <span class="keyword">static</span> UINT16 lastport = 1;
00687         UINT16 start;
00688         UINT16 i;
00689         
00690 
00691         <span class="comment">/* Try with every port to every socket untill free found        */</span>
00692                 
00693         <span class="keywordflow">for</span>( start = lastport++; start != lastport; lastport++) {
00694                 <span class="keywordflow">if</span>(lastport == <a class="code" href="group__opentcp__config.html#a8">UDP_PORTS_END</a>)
00695                         lastport = 1;
00696                         
00697                 <span class="keywordflow">for</span>(i = 0; i &lt; NO_OF_UDPSOCKETS; i++) {
00698                         soc = &amp;udp_socket[i];                                   <span class="comment">/* Get socket   */</span>
00699                         
00700                         <span class="keywordflow">if</span>( (soc-&gt;<a class="code" href="structucb.html#m0">state</a> &gt; <a class="code" href="tcp__ip_8h.html#a29">UDP_STATE_CLOSED</a>) &amp;&amp; (soc-&gt;<a class="code" href="structucb.html#m2">locport</a> == lastport) )                     {
00701                                 <span class="comment">/* Blaah, this socket has reserved the port, go to next one     */</span>
00702                                 <span class="keywordflow">break</span>; 
00703                         }
00704                         
00705                 }       
00706                         
00707                 <span class="comment">/* Did we found it?     */</span>
00708                         
00709                 <span class="keywordflow">if</span>( i == NO_OF_UDPSOCKETS)
00710                         <span class="keywordflow">break</span>; 
00711                         
00712         }
00713                 
00714         <span class="keywordflow">if</span>(lastport == start) {
00715                 DEBUGOUT(<span class="stringliteral">"Out of UDP ports!!\n\r"</span>);
00716                 <span class="keywordflow">return</span>(0);
00717         }
00718                 
00719         <span class="keywordflow">return</span>(lastport);
00720                 
00721 }
00722 
00723 
00724 
00725 
00726 
</pre></div><hr><address style="align: right;"><small>Generated on Sun Aug 3 20:33:00 2003 for OpenTCP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
